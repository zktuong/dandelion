

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>dandelion.preprocessing._preprocessing &mdash; dandelion 0.0.27.post1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/dandelion_logo.png"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/dandelion_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#required-database">Required database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#external-softwares">External softwares</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#basic-requirements">Basic requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#acknowledgements">Acknowledgements</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1_dandelion_preprocessing-10x%20data.html">Pre-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/2_dandelion_filtering-10x%20data.html">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/3_dandelion_findingclones_and_analysis-10x%20data.html">BCR clustering and visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/5_dandelion_running_from_R.html">Running from R</a></li>
</ul>
<p class="caption"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Preprocessing: <cite>pp</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.preprocessing.external">Preprocessing (external): <cite>pp.external</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.tools">Tools: <cite>tl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.plotting">Plotting: <cite>pl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.utilities">Utilities: <cite>utl</cite></a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dandelion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>dandelion.preprocessing._preprocessing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dandelion.preprocessing._preprocessing</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># @Author: kt16</span>
<span class="c1"># @Date:   2020-05-12 17:56:02</span>
<span class="c1"># @Last Modified by:   Kelvin</span>
<span class="c1"># @Last Modified time: 2020-12-30 01:48:33</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">..utilities._utilities</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.external._preprocessing</span> <span class="kn">import</span> <span class="n">assigngenes_igblast</span><span class="p">,</span> <span class="n">makedb_igblast</span><span class="p">,</span> <span class="n">parsedb_heavy</span><span class="p">,</span> <span class="n">parsedb_light</span><span class="p">,</span> <span class="n">tigger_genotype</span><span class="p">,</span> <span class="n">creategermlines</span>
<span class="kn">from</span> <span class="nn">plotnine</span> <span class="kn">import</span> <span class="n">ggplot</span><span class="p">,</span> <span class="n">geom_bar</span><span class="p">,</span> <span class="n">geom_col</span><span class="p">,</span> <span class="n">ggtitle</span><span class="p">,</span> <span class="n">scale_fill_manual</span><span class="p">,</span> <span class="n">coord_flip</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">element_blank</span><span class="p">,</span> <span class="n">aes</span><span class="p">,</span> <span class="n">xlab</span><span class="p">,</span> <span class="n">ylab</span><span class="p">,</span> <span class="n">facet_wrap</span><span class="p">,</span> <span class="n">facet_grid</span><span class="p">,</span> <span class="n">theme_classic</span><span class="p">,</span> <span class="n">theme</span><span class="p">,</span> <span class="n">annotate</span><span class="p">,</span> <span class="n">theme_bw</span><span class="p">,</span> <span class="n">geom_histogram</span><span class="p">,</span> <span class="n">geom_vline</span>
<span class="kn">from</span> <span class="nn">changeo.Gene</span> <span class="kn">import</span> <span class="n">buildGermline</span>
<span class="kn">from</span> <span class="nn">changeo.IO</span> <span class="kn">import</span> <span class="n">countDbFile</span><span class="p">,</span> <span class="n">getDbFields</span><span class="p">,</span> <span class="n">getFormatOperators</span><span class="p">,</span> <span class="n">readGermlines</span><span class="p">,</span> <span class="n">checkFields</span>
<span class="kn">from</span> <span class="nn">changeo.Receptor</span> <span class="kn">import</span> <span class="n">AIRRSchema</span><span class="p">,</span> <span class="n">ChangeoSchema</span><span class="p">,</span> <span class="n">Receptor</span><span class="p">,</span> <span class="n">ReceptorData</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scanpy</span> <span class="kn">import</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">logg</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">Bio</span> <span class="kn">import</span> <span class="n">Align</span>

<div class="viewcode-block" id="format_fasta"><a class="viewcode-back" href="../../../modules/dandelion.preprocessing.format_fasta.html#dandelion.preprocessing.format_fasta">[docs]</a><span class="k">def</span> <span class="nf">format_fasta</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">remove_trailing_hyphen_number</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds prefix to the headers/contig ids in cellranger fasta and annotation file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fasta : str</span>
<span class="sd">        path to fasta file.</span>
<span class="sd">    prefix : str, optional</span>
<span class="sd">        prefix to append to the headers/contig ids.</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        suffix to append to the headers/contig ids.</span>
<span class="sd">    sep : str, optional</span>
<span class="sd">        separator after prefix or before suffix to append to the headers/contig ids.</span>
<span class="sd">    remove_trailing_hyphen_number : bool</span>
<span class="sd">        whether or not to remove the trailing hyphen number e.g. &#39;-1&#39; from the cell/contig barcodes.</span>
<span class="sd">    outdir : str, optional</span>
<span class="sd">        path to output location. None defaults to &#39;dandelion/data&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Formatted fasta file with new headers containing prefix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filePath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fasta</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">fasta</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.fasta&quot;</span><span class="p">):</span>
        <span class="n">filePath</span> <span class="o">=</span> <span class="n">fasta</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fasta</span><span class="p">)):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fasta</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fasta</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.fasta&quot;</span><span class="p">):</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="n">fasta</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filePath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Path to fasta file is unknown. Please specify path to fasta file or folder containing fasta file. Starting folder should only contain 1 fasta file.&#39;</span><span class="p">)</span>

    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">seqs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">sep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">fasta_iterator</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seqs</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span>
        <span class="k">elif</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">:</span>
                    <span class="n">newheader</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_contig&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newheader</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_contig&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">:</span>
                    <span class="n">newheader</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_contig&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newheader</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="n">seqs</span><span class="p">[</span><span class="n">newheader</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">:</span>
                    <span class="n">newheader</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_contig&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newheader</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newheader</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="n">seqs</span><span class="p">[</span><span class="n">newheader</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span>

    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filePath</span><span class="p">):</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filePath</span><span class="p">):</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">basedir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;dandelion/data/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outdir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">out_dir</span> <span class="o">=</span> <span class="n">outdir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>

    <span class="n">out_fasta</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>

    <span class="n">fh1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_fasta</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">fh1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">seqs</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span><span class="o">+</span><span class="n">l</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">seqs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">Write_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">out_fasta</span><span class="p">)</span>

    <span class="c1"># format the barcode and contig_id in the corresponding annotation file too</span>
    <span class="n">anno</span> <span class="o">=</span> <span class="n">basedir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">,</span> <span class="s1">&#39;_annotations.csv&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">anno</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_contig&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_contig&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_contig&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_contig&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_contig&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contig_id&#39;</span><span class="p">]]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">]]</span>

    <span class="n">out_anno</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">,</span> <span class="s1">&#39;_annotations.csv&#39;</span><span class="p">)</span>

    <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_anno</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="format_fastas"><a class="viewcode-back" href="../../../modules/dandelion.preprocessing.format_fastas.html#dandelion.preprocessing.format_fastas">[docs]</a><span class="k">def</span> <span class="nf">format_fastas</span><span class="p">(</span><span class="n">fastas</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">remove_trailing_hyphen_number</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds prefix to the headers/contig ids in cellranger fasta and annotation file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fastas : list</span>
<span class="sd">        list or sequence of paths to fasta files.</span>
<span class="sd">    prefix : list, optional</span>
<span class="sd">        list or sequence of prefixes to append to headers/contig ids in each fasta file.</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        list or sequence of suffixes to append to headers/contig ids in each fasta file.</span>
<span class="sd">    sep : str, optional</span>
<span class="sd">        separator after prefix or before suffix to append to the headers/contig ids.</span>
<span class="sd">    remove_trailing_hyphen_number : bool</span>
<span class="sd">        whether or not to remove the trailing hyphen number e.g. &#39;-1&#39; from the cell/contig barcodes.</span>
<span class="sd">    outdir : str, optional</span>
<span class="sd">        path to out put location. Default is None, which is &#39;dandelion/data&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Formatted fasta file with new headers containing prefix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fastas</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">fastas</span> <span class="o">=</span> <span class="p">[</span><span class="n">fastas</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">[</span><span class="n">prefix</span><span class="p">]</span>
        <span class="n">prefix_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fastas</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">suffix</span><span class="p">]</span>
        <span class="n">suffix_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fastas</span><span class="p">,</span> <span class="n">suffix</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">fasta</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fastas</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Formating fasta(s) &#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">format_fasta</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">remove_trailing_hyphen_number</span> <span class="o">=</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">format_fasta</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix_dict</span><span class="p">[</span><span class="n">fasta</span><span class="p">],</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix_dict</span><span class="p">[</span><span class="n">fasta</span><span class="p">],</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">sep</span><span class="p">,</span> <span class="n">remove_trailing_hyphen_number</span> <span class="o">=</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">format_fasta</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix_dict</span><span class="p">[</span><span class="n">fasta</span><span class="p">],</span> <span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">sep</span><span class="p">,</span> <span class="n">remove_trailing_hyphen_number</span> <span class="o">=</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">format_fasta</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix_dict</span><span class="p">[</span><span class="n">fasta</span><span class="p">],</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">sep</span><span class="p">,</span> <span class="n">remove_trailing_hyphen_number</span> <span class="o">=</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">format_fasta</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">remove_trailing_hyphen_number</span> <span class="o">=</span> <span class="n">remove_trailing_hyphen_number</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span><span class="p">)</span></div>


<div class="viewcode-block" id="assign_isotype"><a class="viewcode-back" href="../../../modules/dandelion.preprocessing.assign_isotype.html#dandelion.preprocessing.assign_isotype">[docs]</a><span class="k">def</span> <span class="nf">assign_isotype</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="s1">&#39;blast&#39;</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="s1">&#39;human&#39;</span><span class="p">,</span> <span class="n">correct_c_call</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">correction_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">blastdb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allele</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ncpu</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Annotate contigs with constant region call using blastn</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fasta : str</span>
<span class="sd">        path to fasta file.</span>
<span class="sd">    fileformat : str</span>
<span class="sd">        format of V(D)J file/objects. Default is &#39;blast&#39;. Also accepts &#39;changeo&#39; (same behaviour as &#39;blast&#39;) and &#39;airr&#39;.</span>
<span class="sd">    org : str</span>
<span class="sd">        organism of reference folder. Default is &#39;human&#39;.</span>
<span class="sd">    correct_c_call : bool</span>
<span class="sd">        whether or not to adjust the c_calls after blast based on provided primers specified in `primer_dict` option. Default is True.</span>
<span class="sd">    correction_dict : dict[dict], optional</span>
<span class="sd">        a nested dictionary contain isotype/c_genes as keys and primer sequences as records to use for correcting annotated c_calls. Defaults to a curated dictionary for human sequences if left as none.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        whether or not to plot reassignment summary metrics. Default is True.</span>
<span class="sd">    figsize : tuple[float, float]</span>
<span class="sd">        size of figure. Default is (4, 4).</span>
<span class="sd">    blastdb : str, optional</span>
<span class="sd">        path to blast database. Defaults to `$BLASTDB` environmental variable.</span>
<span class="sd">    allele : bool</span>
<span class="sd">        whether or not to return allele calls. Default is False.</span>
<span class="sd">    parallel : bool</span>
<span class="sd">        whether or not to use parallelization. Default is True.</span>
<span class="sd">    ncpu : int</span>
<span class="sd">        number of cores to use if parallel is True. Default is all available minus 1.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        whether or not to print the blast command in terminal. Default is False.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    V(D)J tsv files with constant genes annotated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_run_blastn</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">blastdb</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">,</span> <span class="n">org</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">blastdb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bdb</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;BLASTDB&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Environmental variable BLASTDB must be set. Otherwise, please provide path to blast database&#39;</span><span class="p">)</span>
            <span class="n">bdb</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">+</span><span class="n">org</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">org</span><span class="o">+</span><span class="s1">&#39;_BCR_C.fasta&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;BLASTDB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blastdb</span>
            <span class="n">bdb</span> <span class="o">=</span> <span class="n">blastdb</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blastn&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-db&#39;</span><span class="p">,</span> <span class="n">bdb</span><span class="p">,</span>
                <span class="s1">&#39;-evalue&#39;</span><span class="p">,</span> <span class="s1">&#39;0.001&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-max_target_seqs&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-outfmt&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-query&#39;</span><span class="p">,</span> <span class="n">fasta</span><span class="p">]</span>

        <span class="n">blast_out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/tmp/</span><span class="si">{}</span><span class="s2">.xml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fasta</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fasta</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fileformat</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running command: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">blast_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">out</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_parse_BLAST</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parses BLAST output from output files and writes formatted output to BLAST</span>
<span class="sd">        output summary files</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">split_blast_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            code adapted from http://stackoverflow.com/questions/19575702/pythonhow-to-split-file-into-chunks-by-the-occurrence-of-the-header-word</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;&lt;Iteration&gt;&#39;</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_chunk</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="ow">and</span> <span class="n">current_chunk</span><span class="p">:</span>
                        <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_chunk</span><span class="p">[:])</span>
                        <span class="n">current_chunk</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Total queries&quot;</span><span class="p">):</span>
                        <span class="n">current_chunk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_chunk</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">extract_blast_info</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="n">input_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/tmp/</span><span class="si">{}</span><span class="s2">.xml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fasta</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fasta</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fileformat</span><span class="p">)</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/tmp/</span><span class="si">{}</span><span class="s2">.blastsummary.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fasta</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fasta</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fileformat</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;------------------</span><span class="se">\n</span><span class="s2">##</span><span class="si">{}</span><span class="s2">##</span><span class="se">\n</span><span class="s2">------------------</span><span class="se">\n\n</span><span class="s2">#BCR#</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fasta</span><span class="p">))</span>
            <span class="c1"># Split result file into chunks corresponding to results for each query sequence.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
                <span class="n">blast_result_chunks</span> <span class="o">=</span> <span class="n">split_blast_file</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">blast_result_chunks</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">line_x</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
                        <span class="n">line_x</span><span class="o">=</span> <span class="n">line_x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Iteration_query-def&gt;&quot;</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line_x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">blast_query_name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_evalue&gt;&quot;</span><span class="p">):</span>
                            <span class="n">evalue</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                            <span class="n">evalue</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">evalue</span><span class="p">),</span> <span class="s1">&#39;.0e&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hit_accession&gt;&quot;</span><span class="p">):</span>
                            <span class="n">C_segment</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s2">&quot;C-REGION&quot;</span> <span class="ow">or</span> <span class="s2">&quot;CH1&quot;</span> <span class="ow">in</span> <span class="n">C_segment</span><span class="p">:</span>
                                <span class="n">C_segment</span> <span class="o">=</span> <span class="n">C_segment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_bit-score&gt;&quot;</span><span class="p">):</span>
                            <span class="n">bit_score</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_query-from&gt;&quot;</span><span class="p">):</span>
                            <span class="n">q_start</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_query-to&gt;&quot;</span><span class="p">):</span>
                            <span class="n">q_end</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_hit-from&gt;&quot;</span><span class="p">):</span>
                            <span class="n">s_start</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_hit-to&gt;&quot;</span><span class="p">):</span>
                            <span class="n">s_end</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Iteration_query-len&gt;&quot;</span><span class="p">):</span>
                            <span class="n">query_length</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_align-len&gt;&quot;</span><span class="p">):</span>
                            <span class="n">align_length</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_gaps&gt;&quot;</span><span class="p">):</span>
                            <span class="n">gaps</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_identity&gt;&quot;</span><span class="p">):</span>
                            <span class="n">identity</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_qseq&gt;&quot;</span><span class="p">):</span>
                            <span class="n">c_qseq</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Hsp_hseq&gt;&quot;</span><span class="p">):</span>
                            <span class="n">c_hseq</span> <span class="o">=</span> <span class="n">extract_blast_info</span><span class="p">(</span><span class="n">line_x</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;Iteration_message&gt;No hits found&quot;</span><span class="p">):</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">out_string</span> <span class="o">=</span> <span class="s2">&quot;##</span><span class="si">{blast_query_name}</span><span class="s2">##</span><span class="se">\n</span><span class="s2">No C segment found</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                <span class="n">blast_query_name</span><span class="o">=</span><span class="n">blast_query_name</span><span class="p">)</span>
                            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_string</span><span class="p">)</span>
                        <span class="c1"># Create output string when reaching end of BLAST</span>
                        <span class="c1"># iteration result (marked by &lt;/Iteration&gt;) and write</span>
                        <span class="c1"># to BLAST summary file</span>
                        <span class="k">elif</span> <span class="n">line_x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;/Iteration&gt;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">identity_pro</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="n">align_length</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
                            <span class="n">identity_pro</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">identity_pro</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">)</span>
                            <span class="n">mismatches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">align_length</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span>
                            <span class="c1">#Account for reversed sequences</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">s_start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">s_end</span><span class="p">):</span>
                                <span class="n">blast_query_name</span> <span class="o">=</span> <span class="s2">&quot;reversed|&quot;</span> <span class="o">+</span> <span class="n">blast_query_name</span>
                                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">q_start</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">q_end</span><span class="p">)</span>
                                <span class="n">q_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_length</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="n">q_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_length</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="n">s_start</span><span class="p">,</span> <span class="n">s_end</span> <span class="o">=</span> <span class="n">s_end</span><span class="p">,</span> <span class="n">s_start</span>
                            <span class="n">intro_string</span> <span class="o">=</span> <span class="s2">&quot;##</span><span class="si">{}</span><span class="s2">##</span><span class="se">\n</span><span class="s2">C segment:</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">blast_query_name</span><span class="p">,</span> <span class="n">C_segment</span><span class="p">)</span>
                            <span class="n">header_string</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Segment</span><span class="se">\t</span><span class="s2">query_id</span><span class="se">\t</span><span class="s2">subject_id</span><span class="se">\t</span><span class="si">% i</span><span class="s2">dentity</span><span class="se">\t</span><span class="s2">alignment length</span><span class="se">\t</span><span class="s2">&quot;</span>
                                            <span class="s2">&quot;mismatches</span><span class="se">\t</span><span class="s2">gap opens</span><span class="se">\t</span><span class="s2">gaps</span><span class="se">\t</span><span class="s2">q start</span><span class="se">\t</span><span class="s2">q end</span><span class="se">\t</span><span class="s2">s start</span><span class="se">\t</span><span class="s2">s end</span><span class="se">\t</span><span class="s2">&quot;</span>
                                            <span class="s2">&quot;evalue</span><span class="se">\t</span><span class="s2">bit score</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">out_string</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;C</span><span class="se">\t</span><span class="si">{blast_query_name}</span><span class="se">\t</span><span class="si">{C_segment}</span><span class="se">\t</span><span class="si">{identity_pro}</span><span class="se">\t</span><span class="si">{align_length}</span><span class="se">\t</span><span class="si">{mismatches}</span><span class="se">\t</span><span class="s2">NA</span><span class="se">\t</span><span class="si">{gaps}</span><span class="se">\t</span><span class="si">{q_start}</span><span class="se">\t</span><span class="si">{q_end}</span><span class="se">\t</span><span class="si">{s_start}</span><span class="se">\t</span><span class="si">{s_end}</span><span class="se">\t</span><span class="si">{evalue}</span><span class="se">\t</span><span class="si">{bit_score}</span><span class="se">\t</span><span class="si">{q_seq}</span><span class="se">\t</span><span class="si">{h_seq}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">blast_query_name</span><span class="o">=</span><span class="n">blast_query_name</span><span class="p">,</span>
                                            <span class="n">C_segment</span><span class="o">=</span><span class="n">C_segment</span><span class="p">,</span> <span class="n">identity_pro</span><span class="o">=</span><span class="n">identity_pro</span><span class="p">,</span> <span class="n">align_length</span><span class="o">=</span><span class="n">align_length</span><span class="p">,</span>
                                            <span class="n">evalue</span><span class="o">=</span><span class="n">evalue</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="n">mismatches</span><span class="p">,</span> <span class="n">gaps</span><span class="o">=</span><span class="n">gaps</span><span class="p">,</span> <span class="n">q_start</span><span class="o">=</span><span class="n">q_start</span><span class="p">,</span>
                                            <span class="n">q_end</span><span class="o">=</span><span class="n">q_end</span><span class="p">,</span> <span class="n">s_start</span><span class="o">=</span><span class="n">s_start</span><span class="p">,</span> <span class="n">s_end</span><span class="o">=</span><span class="n">s_end</span><span class="p">,</span> <span class="n">bit_score</span><span class="o">=</span><span class="n">bit_score</span><span class="p">,</span> <span class="n">q_seq</span> <span class="o">=</span> <span class="n">c_qseq</span><span class="p">,</span> <span class="n">h_seq</span> <span class="o">=</span> <span class="n">c_hseq</span><span class="p">)</span>
                            <span class="n">string_to_write</span> <span class="o">=</span> <span class="n">intro_string</span> <span class="o">+</span> <span class="n">header_string</span> <span class="o">+</span> <span class="n">out_string</span>
                            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_write</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_C</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">,</span> <span class="n">allele</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ncpu</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">_get_C_call</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">contig_name</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">,</span> <span class="n">allele</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">blast_summary_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/tmp/</span><span class="si">{}</span><span class="s2">.blastsummary.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fasta</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fasta</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fileformat</span><span class="p">)</span>

            <span class="n">C_seq</span><span class="p">,</span><span class="n">C_germ</span><span class="p">,</span> <span class="n">C_gene</span><span class="p">,</span> <span class="n">C_ident</span><span class="p">,</span> <span class="n">C_eval</span><span class="p">,</span> <span class="n">C_bitscore</span><span class="p">,</span> <span class="n">C_qstart</span><span class="p">,</span> <span class="n">C_qend</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">blast_summary_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;C</span><span class="se">\t</span><span class="si">{contig_name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">contig_name</span><span class="o">=</span><span class="n">contig_name</span><span class="p">))</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;C</span><span class="se">\t</span><span class="s2">reversed|</span><span class="si">{contig_name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">contig_name</span><span class="o">=</span><span class="n">contig_name</span><span class="p">)):</span>
                        <span class="n">C_gene</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">C_ident</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">C_seq</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">14</span><span class="p">]</span>
                        <span class="n">C_germ</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">15</span><span class="p">]</span>
                        <span class="n">C_eval</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">12</span><span class="p">]</span>
                        <span class="n">C_bitscore</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">13</span><span class="p">]</span>
                        <span class="n">C_qstart</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">8</span><span class="p">]</span>
                        <span class="n">C_qend</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">9</span><span class="p">]</span>

                        <span class="k">if</span> <span class="s2">&quot;_CH1&quot;</span> <span class="ow">or</span> <span class="s2">&quot;_C-REGION&quot;</span> <span class="ow">in</span> <span class="n">C_gene</span><span class="p">:</span>
                            <span class="n">C_gene</span> <span class="o">=</span> <span class="n">C_gene</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allele</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">C_gene</span> <span class="o">=</span> <span class="n">C_gene</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">C_call</span><span class="p">,</span> <span class="n">C_identity</span><span class="p">,</span> <span class="n">C_sequence</span><span class="p">,</span> <span class="n">C_germline</span><span class="p">,</span> <span class="n">C_support</span><span class="p">,</span> <span class="n">C_score</span><span class="p">,</span> <span class="n">C_start</span><span class="p">,</span> <span class="n">C_end</span><span class="p">,</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
            <span class="n">C_call</span><span class="p">[</span><span class="n">contig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_gene</span>
            <span class="n">C_identity</span><span class="p">[</span><span class="n">contig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_ident</span>
            <span class="n">C_sequence</span><span class="p">[</span><span class="n">contig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_seq</span>
            <span class="n">C_germline</span><span class="p">[</span><span class="n">contig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_germ</span>
            <span class="n">C_support</span><span class="p">[</span><span class="n">contig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_eval</span>
            <span class="n">C_score</span><span class="p">[</span><span class="n">contig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_bitscore</span>
            <span class="n">C_start</span><span class="p">[</span><span class="n">contig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_qstart</span>
            <span class="n">C_end</span><span class="p">[</span><span class="n">contig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_qend</span>

            <span class="k">return</span><span class="p">(</span><span class="n">C_sequence</span><span class="p">,</span> <span class="n">C_germline</span><span class="p">,</span> <span class="n">C_call</span><span class="p">,</span> <span class="n">C_identity</span><span class="p">,</span> <span class="n">C_support</span><span class="p">,</span> <span class="n">C_score</span><span class="p">,</span> <span class="n">C_start</span><span class="p">,</span> <span class="n">C_end</span><span class="p">)</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">contigs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">fasta_iterator</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
            <span class="n">contigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ncpu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">num_cores</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_cores</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ncpu</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">num_cores</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">_get_C_call</span><span class="p">)(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">,</span> <span class="n">allele</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">contigs</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Retrieving contant region calls, parallelizing with &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_cores</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; cpus &#39;</span><span class="p">))</span>
            <span class="c1"># transform list of dicts to dict</span>
            <span class="n">seq</span><span class="p">,</span> <span class="n">germ</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">support</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
                <span class="n">_seq</span><span class="p">,</span> <span class="n">_germ</span><span class="p">,</span> <span class="n">_call</span><span class="p">,</span> <span class="n">_ident</span><span class="p">,</span> <span class="n">_support</span><span class="p">,</span> <span class="n">_score</span><span class="p">,</span> <span class="n">_start</span><span class="p">,</span> <span class="n">_end</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="n">seq</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_seq</span><span class="p">)</span>
                <span class="n">germ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_germ</span><span class="p">)</span>
                <span class="n">call</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_call</span><span class="p">)</span>
                <span class="n">ident</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_ident</span><span class="p">)</span>
                <span class="n">support</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_support</span><span class="p">)</span>
                <span class="n">score</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_score</span><span class="p">)</span>
                <span class="n">start</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_start</span><span class="p">)</span>
                <span class="n">end</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_end</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq</span><span class="p">,</span> <span class="n">germ</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">support</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">contigs</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Retrieving contant region calls &#39;</span><span class="p">):</span>
                <span class="n">seq</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">germ</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">ident</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">support</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">start</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">end</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_C_call</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">,</span> <span class="n">allele</span><span class="p">)[</span><span class="n">c</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">germ</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">support</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transfer_c</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">c_dict</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
        <span class="n">_data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">c_dict</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">colname</span><span class="p">]),</span> <span class="n">left_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">c_dict</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_cell</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">_data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">_data</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_contig&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_data</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">]]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span>

    <span class="n">aligner</span> <span class="o">=</span> <span class="n">Align</span><span class="o">.</span><span class="n">PairwiseAligner</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">two_gene_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
        <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span> <span class="o">=</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_sequence_alignment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">alignments1</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key1</span><span class="p">],</span> <span class="n">seq</span><span class="p">)</span>
        <span class="n">alignments2</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key2</span><span class="p">],</span> <span class="n">seq</span><span class="p">)</span>
        <span class="n">score1</span> <span class="o">=</span> <span class="n">alignments1</span><span class="o">.</span><span class="n">score</span>
        <span class="n">score2</span> <span class="o">=</span> <span class="n">alignments2</span><span class="o">.</span><span class="n">score</span>
        <span class="k">if</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score1</span> <span class="o">&lt;</span> <span class="n">score2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">three_gene_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
        <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">key3</span> <span class="o">=</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_sequence_alignment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">alignments1</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key1</span><span class="p">],</span> <span class="n">seq</span><span class="p">)</span>
        <span class="n">alignments2</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key2</span><span class="p">],</span> <span class="n">seq</span><span class="p">)</span>
        <span class="n">alignments3</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key3</span><span class="p">],</span> <span class="n">seq</span><span class="p">)</span>
        <span class="n">score1</span> <span class="o">=</span> <span class="n">alignments1</span><span class="o">.</span><span class="n">score</span>
        <span class="n">score2</span> <span class="o">=</span> <span class="n">alignments2</span><span class="o">.</span><span class="n">score</span>
        <span class="n">score3</span> <span class="o">=</span> <span class="n">alignments3</span><span class="o">.</span><span class="n">score</span>
        <span class="k">if</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score2</span> <span class="o">==</span> <span class="n">score3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score2</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score1</span> <span class="ow">and</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score3</span> <span class="o">&gt;</span> <span class="n">score1</span> <span class="ow">and</span> <span class="n">score3</span> <span class="o">&gt;</span> <span class="n">score2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score2</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score2</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score1</span> <span class="ow">and</span> <span class="n">score2</span> <span class="o">==</span> <span class="n">score3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">four_gene_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
        <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">key3</span><span class="p">,</span> <span class="n">key4</span> <span class="o">=</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_sequence_alignment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">alignments1</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key1</span><span class="p">],</span> <span class="n">seq</span><span class="p">)</span>
        <span class="n">alignments2</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key2</span><span class="p">],</span> <span class="n">seq</span><span class="p">)</span>
        <span class="n">alignments3</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key3</span><span class="p">],</span> <span class="n">seq</span><span class="p">)</span>
        <span class="n">alignments4</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key4</span><span class="p">],</span> <span class="n">seq</span><span class="p">)</span>
        <span class="n">score1</span> <span class="o">=</span> <span class="n">alignments1</span><span class="o">.</span><span class="n">score</span>
        <span class="n">score2</span> <span class="o">=</span> <span class="n">alignments2</span><span class="o">.</span><span class="n">score</span>
        <span class="n">score3</span> <span class="o">=</span> <span class="n">alignments3</span><span class="o">.</span><span class="n">score</span>
        <span class="n">score4</span> <span class="o">=</span> <span class="n">alignments4</span><span class="o">.</span><span class="n">score</span>
        <span class="k">if</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score2</span> <span class="o">==</span> <span class="n">score3</span> <span class="o">==</span> <span class="n">score4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score2</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score3</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score1</span> <span class="ow">and</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score3</span> <span class="ow">and</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score3</span> <span class="o">&gt;</span> <span class="n">score1</span> <span class="ow">and</span> <span class="n">score3</span> <span class="o">&gt;</span> <span class="n">score2</span> <span class="ow">and</span> <span class="n">score3</span> <span class="o">&gt;</span> <span class="n">score4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score4</span> <span class="o">&gt;</span> <span class="n">score1</span> <span class="ow">and</span> <span class="n">score4</span> <span class="o">&gt;</span> <span class="n">score2</span> <span class="ow">and</span> <span class="n">score4</span> <span class="o">&gt;</span> <span class="n">score3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score2</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score3</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score2</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score3</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score2</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score3</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score2</span> <span class="o">==</span> <span class="n">score3</span> <span class="ow">and</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score1</span> <span class="ow">and</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score2</span> <span class="o">==</span> <span class="n">score4</span> <span class="ow">and</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score1</span> <span class="ow">and</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score3</span> <span class="o">==</span> <span class="n">score4</span> <span class="ow">and</span> <span class="n">score3</span> <span class="o">&gt;</span> <span class="n">score1</span> <span class="ow">and</span> <span class="n">score3</span> <span class="o">&gt;</span> <span class="n">score2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score2</span> <span class="o">==</span> <span class="n">score3</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score2</span> <span class="o">==</span> <span class="n">score4</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score1</span> <span class="o">==</span> <span class="n">score3</span> <span class="o">==</span> <span class="n">score4</span> <span class="ow">and</span> <span class="n">score1</span> <span class="o">&gt;</span> <span class="n">score2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score2</span> <span class="o">==</span> <span class="n">score3</span> <span class="o">==</span> <span class="n">score4</span> <span class="ow">and</span> <span class="n">score2</span> <span class="o">&gt;</span> <span class="n">score1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_correct_c_call</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">primers_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">primers_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">primer_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;IGHG&#39;</span><span class="p">:{</span>
                    <span class="s1">&#39;IGHG1&#39;</span><span class="p">:</span><span class="s1">&#39;GCCTCCACCAAGGGCCCATCGGTCTTCCCCCTGGCACCCTCCTCCAAGAGCACCTCTGGGGGCACAGCGGCCCTGGGC&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;IGHG2&#39;</span><span class="p">:</span><span class="s1">&#39;GCCTCCACCAAGGGCCCATCGGTCTTCCCCCTGGCGCCCTGCTCCAGGAGCACCTCCGAGAGCACAGCGGCCCTGGGC&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;IGHG3&#39;</span><span class="p">:</span><span class="s1">&#39;GCTTCCACCAAGGGCCCATCGGTCTTCCCCCTGGCGCCCTGCTCCAGGAGCACCTCTGGGGGCACAGCGGCCCTGGGC&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;IGHG4&#39;</span><span class="p">:</span><span class="s1">&#39;GCTTCCACCAAGGGCCCATCCGTCTTCCCCCTGGCGCCCTGCTCCAGGAGCACCTCCGAGAGCACAGCCGCCCTGGGC&#39;</span><span class="p">},</span>
                <span class="s1">&#39;IGHA&#39;</span><span class="p">:{</span>
                    <span class="s1">&#39;IGHA1&#39;</span><span class="p">:</span><span class="s1">&#39;GCATCCCCGACCAGCCCCAAGGTCTTCCCGCTGAGCCTCTGCAGCACCCAGCCAGATGGGAACGTGGTCATCGCCTGC&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;IGHA2&#39;</span><span class="p">:</span><span class="s1">&#39;GCATCCCCGACCAGCCCCAAGGTCTTCCCGCTGAGCCTCGACAGCACCCCCCAAGATGGGAACGTGGTCGTCGCATGC&#39;</span><span class="p">},</span>
                <span class="s1">&#39;IGLC7&#39;</span><span class="p">:{</span>
                    <span class="s1">&#39;IGLC&#39;</span><span class="p">:</span><span class="s1">&#39;GTCAGCCCAAGGCTGCCCCCTCGGTCACTCTGTTCCCGCCCTCCTCTGAGGAGCTTCAAGCCAACAAGGCCACACTGGTGTGTCTCATAA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;IGLC7&#39;</span><span class="p">:</span><span class="s1">&#39;GTCAGCCCAAGGCTGCCCCCTCGGTCACTCTGTTCCCACCCTCCTCTGAGGAGCTTCAAGCCAACAAGGCCACACTGGTGTGTCTCGTAA&#39;</span><span class="p">},</span>
                <span class="s1">&#39;IGLC3&#39;</span><span class="p">:{</span>
                    <span class="s1">&#39;IGLC&#39;</span><span class="p">:</span><span class="s1">&#39;GTCAGCCCAAGGCTGCCCCCTCGGTCACTCTGTTCCCGCCCTCCTCTGAGGAGCTTCAAGCCAACAAGGCCACACTGGTGTGTCTCATAA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;IGLC3&#39;</span><span class="p">:</span><span class="s1">&#39;GTCAGCCCAAGGCTGCCCCCTCGGTCACTCTGTTCCCACCCTCCTCTGAGGAGCTTCAAGCCAACAAGGCCACACTGGTGTGTCTCATAA&#39;</span><span class="p">},</span>
                <span class="s1">&#39;IGLC6&#39;</span><span class="p">:{</span>
                    <span class="s1">&#39;IGLC&#39;</span><span class="p">:</span> <span class="s1">&#39;TCGGTCACTCTGTTCCCGCCCTCCTCTGAGGAGCTTCAAGCCAACAAGGCCACACTGGTGTGTCTCA&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;IGLC6&#39;</span><span class="p">:</span><span class="s1">&#39;TCGGTCACTCTGTTCCCGCCCTCCTCTGAGGAGCTTCAAGCCAACAAGGCCACACTGGTGTGCCTGA&#39;</span><span class="p">}}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">primer_dict</span> <span class="o">=</span> <span class="n">primers_dict</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">primer_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">primer_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">two_gene_correction</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">primer_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">primer_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">three_gene_correction</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">primer_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">primer_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">four_gene_correction</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">primer_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

    <span class="c1"># main function from here    </span>
    <span class="n">format_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap&#39;</span><span class="p">}</span>    

    <span class="n">filePath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fasta</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">fasta</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.fasta&quot;</span><span class="p">):</span>
        <span class="n">filePath</span> <span class="o">=</span> <span class="n">fasta</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fasta</span><span class="p">)):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fasta</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fasta</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;dandelion&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fasta</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
                        <span class="n">out_</span> <span class="o">=</span> <span class="n">fasta</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/data/&#39;</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out_</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">):</span>
                                <span class="n">filePath</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="n">x</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_</span> <span class="o">=</span> <span class="n">fasta</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">):</span>
                            <span class="n">filePath</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">filePath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Path to fasta file is unknown. Please specify path to fasta file or folder containing fasta file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filePath</span><span class="p">))</span>

    <span class="c1"># running blast using blast</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running blastn </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">_run_blastn</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">blastdb</span><span class="p">,</span> <span class="n">format_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">org</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="c1"># parsing output into a summary.txt file</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parsing blast output </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">_parse_BLAST</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">format_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
    <span class="c1"># Add the c_calls to the data file</span>
    <span class="n">c_seq</span><span class="p">,</span> <span class="n">c_germ</span><span class="p">,</span> <span class="n">c_call</span><span class="p">,</span> <span class="n">c_ident</span><span class="p">,</span> <span class="n">c_supp</span><span class="p">,</span> <span class="n">c_scr</span><span class="p">,</span> <span class="n">c_st</span><span class="p">,</span> <span class="n">c_en</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="n">c_seq</span><span class="p">,</span> <span class="n">c_germ</span><span class="p">,</span> <span class="n">c_call</span><span class="p">,</span> <span class="n">c_ident</span><span class="p">,</span> <span class="n">c_supp</span><span class="p">,</span> <span class="n">c_scr</span><span class="p">,</span> <span class="n">c_st</span><span class="p">,</span> <span class="n">c_en</span> <span class="o">=</span> <span class="n">_get_C</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">format_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">allele</span><span class="p">,</span> <span class="n">parallel</span><span class="p">,</span> <span class="n">ncpu</span><span class="p">)</span>
    
    <span class="n">_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/tmp/</span><span class="si">{}</span><span class="s2">_genotyped.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filePath</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">format_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
    <span class="n">_airrfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/tmp/</span><span class="si">{}</span><span class="s2">.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filePath</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_igblast&#39;</span><span class="p">)</span>
    <span class="n">_file2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_genotyped.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filePath</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">format_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading 10X annotations </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">dat_10x</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">_file</span><span class="p">)</span>
    <span class="n">res_10x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat_10x</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">])</span>
    <span class="n">res_10x</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_10x</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preparing new calls </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">_transfer_c</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="n">c_call</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">_transfer_c</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">c_seq</span><span class="p">,</span> <span class="s1">&#39;c_sequence_alignment&#39;</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">_transfer_c</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">c_germ</span><span class="p">,</span> <span class="s1">&#39;c_germline_alignment&#39;</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">_transfer_c</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">c_st</span><span class="p">,</span> <span class="s1">&#39;c_sequence_start&#39;</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">_transfer_c</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">c_en</span><span class="p">,</span> <span class="s1">&#39;c_sequence_end&#39;</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">_transfer_c</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">c_scr</span><span class="p">,</span> <span class="s1">&#39;c_score&#39;</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">_transfer_c</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">c_ident</span><span class="p">,</span> <span class="s1">&#39;c_identity&#39;</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">_transfer_c</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">c_supp</span><span class="p">,</span> <span class="s1">&#39;c_support&#39;</span><span class="p">)</span>
    <span class="n">res_blast</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">])</span>
    <span class="n">res_blast</span> <span class="o">=</span> <span class="n">res_blast</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

    <span class="n">res_10x_sum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_10x</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">res_blast_sum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_blast</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">res_10x_sum</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;10X&#39;</span>
    <span class="n">res_blast_sum</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;blast&#39;</span>
    <span class="n">res_10x_sum</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">]</span>
    <span class="n">res_blast_sum</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">]</span>
    <span class="n">res_10x_sum</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">res_10x_sum</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">([</span><span class="s1">&#39;c_call&#39;</span><span class="p">])</span>
    <span class="n">res_blast_sum</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">res_blast_sum</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">([</span><span class="s1">&#39;c_call&#39;</span><span class="p">])</span>
    <span class="n">res_10x_sum</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">res_blast_sum</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">correct_c_call</span><span class="p">:</span> <span class="c1"># TODO: figure out if i need to set up a None correction?</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correcting C calls </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">_correct_c_call</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">primers_dict</span><span class="o">=</span><span class="n">correction_dict</span><span class="p">)</span>
        <span class="n">res_corrected</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">])</span>
        <span class="n">res_corrected</span> <span class="o">=</span> <span class="n">res_corrected</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">res_corrected_sum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_corrected</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">res_corrected_sum</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;corrected&#39;</span>
        <span class="n">res_corrected_sum</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">]</span>
        <span class="n">res_corrected_sum</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">res_corrected_sum</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">([</span><span class="s1">&#39;c_call&#39;</span><span class="p">])</span>
        <span class="n">res_corrected_sum</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res_10x_sum</span><span class="p">,</span> <span class="n">res_blast_sum</span><span class="p">,</span> <span class="n">res_corrected_sum</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res_10x_sum</span><span class="p">,</span> <span class="n">res_blast_sum</span><span class="p">])</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">reorder_categories</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">])),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finishing up </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;cell_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">_add_cell</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;c_call_10x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dat_10x</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">])</span>
    <span class="c1"># some minor adjustment to the final output table</span>
    <span class="n">airr_output</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">_airrfile</span><span class="p">)</span>
    <span class="n">cols_to_merge</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;junction_aa_length&#39;</span><span class="p">,</span> <span class="s1">&#39;fwr1_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;fwr2_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;fwr3_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;fwr4_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;cdr1_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;cdr2_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;cdr3_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;sequence_alignment_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;v_sequence_alignment_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;d_sequence_alignment_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;j_sequence_alignment_aa&#39;</span><span class="p">]</span> 
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols_to_merge</span><span class="p">:</span>
        <span class="n">dat</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">airr_output</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
    <span class="n">dat</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">_file2</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">figure_size</span> <span class="o">=</span> <span class="n">figsize</span>
        <span class="k">if</span> <span class="n">correct_c_call</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ggplot</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;c_call&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">coord_flip</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="s2">&quot;c_call&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">% c</span><span class="s2"> calls&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">geom_col</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="s1">&#39;dodge&#39;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;#79706e&#39;</span><span class="p">,</span><span class="s1">&#39;#86bcb6&#39;</span><span class="p">,</span> <span class="s1">&#39;#F28e2b&#39;</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_title</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ggplot</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;c_call&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">coord_flip</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="s2">&quot;c_call&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">% c</span><span class="s2"> calls&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">geom_col</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="s1">&#39;dodge&#39;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;#79706e&#39;</span><span class="p">,</span><span class="s1">&#39;#86bcb6&#39;</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_title</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">()))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="assign_isotypes"><a class="viewcode-back" href="../../../modules/dandelion.preprocessing.assign_isotypes.html#dandelion.preprocessing.assign_isotypes">[docs]</a><span class="k">def</span> <span class="nf">assign_isotypes</span><span class="p">(</span><span class="n">fastas</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="s1">&#39;blast&#39;</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="s1">&#39;human&#39;</span><span class="p">,</span> <span class="n">correct_c_call</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">correction_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">blastdb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allele</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ncpu</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Annotate contigs with constant region call using blastn</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fastas : list</span>
<span class="sd">        list or sequence of paths to fasta files.</span>
<span class="sd">    fileformat : str</span>
<span class="sd">        format of V(D)J file/objects. Default is &#39;blast&#39;. Also accepts &#39;changeo&#39; (same behaviour as &#39;blast&#39;) and &#39;airr&#39;.</span>
<span class="sd">    org : str</span>
<span class="sd">        organism of reference folder. Default is &#39;human&#39;.</span>
<span class="sd">    correct_c_call : bool</span>
<span class="sd">        whether or not to adjust the c_calls after blast based on provided primers specified in `primer_dict` option. Default is True.</span>
<span class="sd">    correction_dict : dict[dict], optional</span>
<span class="sd">        a nested dictionary contain isotype/c_genes as keys and primer sequences as records to use for correcting annotated c_calls. Defaults to a curated dictionary for human sequences if left as none.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        whether or not to plot reassignment summary metrics. Default is True.</span>
<span class="sd">    figsize : tuple[float, float]</span>
<span class="sd">        size of figure. Default is (4, 4).</span>
<span class="sd">    blastdb : str, optional</span>
<span class="sd">        path to blast database. Defaults to `$BLASTDB` environmental variable.</span>
<span class="sd">    allele : bool</span>
<span class="sd">        whether or not to return allele calls. Default is False.</span>
<span class="sd">    parallel : bool</span>
<span class="sd">        whether or not to use parallelization. Default is True.</span>
<span class="sd">    ncpu : int</span>
<span class="sd">        number of cores to use if parallel is True. Default is all available - 1.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        whether or not to print the blast command in terminal. Default is False.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    V(D)J tsv files with constant genes annotated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fastas</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">fastas</span> <span class="o">=</span> <span class="p">[</span><span class="n">fastas</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assign isotypes </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fasta</span> <span class="ow">in</span> <span class="n">fastas</span><span class="p">:</span>
        <span class="n">assign_isotype</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="n">fileformat</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="n">org</span><span class="p">,</span> <span class="n">correct_c_call</span> <span class="o">=</span> <span class="n">correct_c_call</span><span class="p">,</span> <span class="n">correction_dict</span> <span class="o">=</span> <span class="n">correction_dict</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">blastdb</span> <span class="o">=</span> <span class="n">blastdb</span><span class="p">,</span> <span class="n">allele</span> <span class="o">=</span> <span class="n">allele</span><span class="p">,</span> <span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">,</span> <span class="n">ncpu</span> <span class="o">=</span> <span class="n">ncpu</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="reannotate_genes"><a class="viewcode-back" href="../../../modules/dandelion.preprocessing.reannotate_genes.html#dandelion.preprocessing.reannotate_genes">[docs]</a><span class="k">def</span> <span class="nf">reannotate_genes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">igblast_db</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span><span class="s1">&#39;human&#39;</span><span class="p">,</span> <span class="n">loci</span> <span class="o">=</span> <span class="s1">&#39;ig&#39;</span><span class="p">,</span> <span class="n">extended</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reannotate cellranger fasta files with igblastn and parses to airr/changeo data format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : list</span>
<span class="sd">        list or sequence of fasta file locations, or folder name containing fasta files. if provided as a single string, it will first be converted to a list; this allows for the function to be run on single/multiple samples.</span>
<span class="sd">    igblast_db : str, optional</span>
<span class="sd">        path to igblast database folder. Defaults to `$IGDATA` environmental variable.</span>
<span class="sd">    germline : str, optional</span>
<span class="sd">        path to germline database folder. Defaults to `$GERMLINE` environmental variable.</span>
<span class="sd">    org : str</span>
<span class="sd">        organism of germline database. Default is &#39;human&#39;.</span>
<span class="sd">    loci : str</span>
<span class="sd">        mode for igblastn. Default is &#39;ig&#39; for BCRs. Also accepts &#39;tr&#39; for TCRs.</span>
<span class="sd">    extended : bool</span>
<span class="sd">        whether or not to transfer additional 10X annotions to output file. Default is True.</span>
<span class="sd">    verbose :</span>
<span class="sd">        whether or not to print the igblast command used in the terminal. Default is False.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    V(D)J data file in airr/changeo data format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>

    <span class="n">filePath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Assigning genes &#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.fasta&quot;</span><span class="p">):</span>
            <span class="n">filePath</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;dandelion&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
                            <span class="n">out_</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/data/&#39;</span>
                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">):</span>
                                    <span class="n">filePath</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="n">x</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out_</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">):</span>
                                <span class="n">filePath</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">filePath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Path to fasta file for </span><span class="si">{}</span><span class="s1"> is unknown. Please specify path to fasta file or folder containing fasta file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filePath</span><span class="p">))</span>

        <span class="n">assigngenes_igblast</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">igblast_db</span><span class="o">=</span><span class="n">igblast_db</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="n">org</span><span class="p">,</span> <span class="n">loci</span><span class="o">=</span><span class="n">loci</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">makedb_igblast</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="n">org</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">extended</span> <span class="o">=</span> <span class="n">extended</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="reassign_alleles"><a class="viewcode-back" href="../../../modules/dandelion.preprocessing.reassign_alleles.html#dandelion.preprocessing.reassign_alleles">[docs]</a><span class="k">def</span> <span class="nf">reassign_alleles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">combined_folder</span><span class="p">,</span> <span class="n">v_germline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="s1">&#39;human&#39;</span><span class="p">,</span> <span class="n">v_field</span><span class="o">=</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">,</span> <span class="n">germ_types</span><span class="o">=</span><span class="s1">&#39;dmask&#39;</span><span class="p">,</span> <span class="n">novel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cloned</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">sample_id_dictionary</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct allele calls based on a personalized genotype using tigger-reassignAlleles. It uses a subject-specific genotype to correct correct preliminary allele assignments of a set of sequences derived from a single subject.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : list</span>
<span class="sd">        list or sequence of data folders containing the .tsv files. if provided as a single string, it will first be converted to a list; this allows for the function to be run on single/multiple samples.</span>
<span class="sd">    combined_folder : str</span>
<span class="sd">        name of folder for concatenated data file and genotyped files.</span>
<span class="sd">    v_germline : str, optional</span>
<span class="sd">        path to heavy chain v germline fasta. Defaults to IGHV fasta in `$GERMLINE` environmental variable.</span>
<span class="sd">    germline : str, optional</span>
<span class="sd">        path to germline database folder. Defaults to `$GERMLINE` environmental variable.</span>
<span class="sd">    org : str</span>
<span class="sd">        organism of germline database. Default is &#39;human&#39;.</span>
<span class="sd">    v_field : str</span>
<span class="sd">        name of column containing the germline V segment call. Default is &#39;v_call_genotyped&#39; (airr) for after tigger.</span>
<span class="sd">    germ_types : str</span>
<span class="sd">        Specify type of germline for reconstruction. Accepts one of : &#39;full&#39;, &#39;dmask&#39;, &#39;vonly&#39;, &#39;region&#39;. Default is &#39;dmask&#39;.</span>
<span class="sd">    novel : bool</span>
<span class="sd">        whether or not to run novel allele discovery during tigger-genotyping. Default is True (yes).</span>
<span class="sd">    cloned : bool</span>
<span class="sd">        whether or not to run CreateGermlines.py with `--cloned`.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        whether or not to plot reassignment summary metrics. Default is True.</span>
<span class="sd">    figsize : tuple[float, float]</span>
<span class="sd">        size of figure. Default is (4, 3).</span>
<span class="sd">    sample_id_dictionary : dict, optional</span>
<span class="sd">        dictionary for creating a sample_id column in the concatenated file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Whether or not to print the command used in the terminal. Default is False.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Individual V(D)J data files with v_call_genotyped column containing reassigned heavy chain v calls</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fileformat</span> <span class="o">=</span> <span class="s1">&#39;blast&#39;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>

    <span class="n">informat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap.tsv&#39;</span><span class="p">}</span>
    <span class="n">germpass_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_germ-pass.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_germ-pass.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap_germ-pass.tsv&#39;</span><span class="p">}</span>
    <span class="n">heavy_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_heavy_parse-select.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_heavy_parse-select.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap_heavy_parse-select.tsv&#39;</span><span class="p">}</span>
    <span class="n">light_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_light_parse-select.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_light_parse-select.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap_light_parse-select.tsv&#39;</span><span class="p">}</span>
    <span class="n">fileformat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_genotyped.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_genotyped.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap_genotyped.tsv&#39;</span><span class="p">}</span>
    <span class="n">fileformat_passed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_genotyped_germ-pass.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_genotyped_germ-pass.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap_genotyped_germ-pass.tsv&#39;</span><span class="p">}</span>
    <span class="n">inferred_fileformat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_inferredGenotype.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_inferredGenotype.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap_inferredGenotype.txt&#39;</span><span class="p">}</span>
    <span class="n">germline_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_genotype.fasta&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_genotype.fasta&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap_genotype.fasta&#39;</span><span class="p">}</span>
    <span class="n">fform_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;airr&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;airr&#39;</span><span class="p">,</span> <span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;changeo&#39;</span><span class="p">}</span>

    <span class="n">filepathlist_heavy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filepathlist_light</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filePath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sampleNames_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">filePath_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Processing data file(s) &#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]):</span>
            <span class="n">filePath</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;dandelion&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
                            <span class="n">out_</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/data/tmp/&#39;</span>
                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]):</span>
                                    <span class="n">filePath</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="n">x</span>
                                    <span class="n">filePath_heavy</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">heavy_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
                                    <span class="n">filePath_light</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">light_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out_</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]):</span>
                                <span class="n">filePath</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">x</span>
                                <span class="n">filePath_heavy</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">heavy_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
                                <span class="n">filePath_light</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">light_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">filePath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Path to .tsv file for </span><span class="si">{}</span><span class="s1"> is unknown. Please specify path to reannotated .tsv file or folder containing reannotated .tsv file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">sample_id_dictionary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sampleNames_dict</span><span class="p">[</span><span class="n">filePath</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_id_dictionary</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sampleNames_dict</span><span class="p">[</span><span class="n">filePath</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        
        <span class="n">filePath_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span> <span class="o">=</span>  <span class="n">filePath</span>

        <span class="c1"># splitting up to heavy chain and light chain files</span>
        <span class="n">parsedb_heavy</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
        <span class="n">parsedb_light</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>

        <span class="c1"># add to counter        </span>
        <span class="n">filepathlist_heavy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filePath_heavy</span><span class="p">)</span>
        <span class="n">filepathlist_light</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filePath_light</span><span class="p">)</span>
    
    <span class="c1"># make output directory</span>
    <span class="n">outDir</span> <span class="o">=</span> <span class="n">combined_folder</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outDir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outDir</span><span class="p">)</span>

    <span class="c1"># concatenate</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filepathlist_heavy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Concatenating objects&#39;</span><span class="p">)</span>
        <span class="n">cmd1</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filepathlist_heavy</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&gt;&#39;</span><span class="p">]</span> <span class="o">+</span>  <span class="p">[</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]])</span>
        <span class="n">cmd2</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filepathlist_light</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&gt;&#39;</span><span class="p">]</span> <span class="o">+</span>  <span class="p">[</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_light&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmd1</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">filepathlist_heavy</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&gt;&#39;</span><span class="p">]</span> <span class="o">+</span>  <span class="p">[</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]])</span>
        <span class="n">cmd2</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">filepathlist_light</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&gt;&#39;</span><span class="p">]</span> <span class="o">+</span>  <span class="p">[</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_light&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running command: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running command: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd2</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd1</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd2</span><span class="p">)</span>

    <span class="n">novel_dict</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span><span class="s1">&#39;YES&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span><span class="s1">&#39;NO&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">novel</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Running tigger-genotype with novel allele discovery.&#39;</span><span class="p">)</span>
            <span class="n">tigger_genotype</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">v_germline</span> <span class="o">=</span> <span class="n">v_germline</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="n">fform_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">novel_</span> <span class="o">=</span> <span class="n">novel_dict</span><span class="p">[</span><span class="n">novel</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">creategermlines</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">fileformat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germtypes</span> <span class="o">=</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="n">genotype_fasta</span> <span class="o">=</span> <span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">germline_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">v_field</span> <span class="o">=</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">cloned</span> <span class="o">=</span> <span class="n">cloned</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">fileformat_passed_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Novel allele discovery execution halted.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Attempting to run tigger-genotype without novel allele discovery.&#39;</span><span class="p">)</span>
                <span class="n">tigger_genotype</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">v_germline</span> <span class="o">=</span> <span class="n">v_germline</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="n">fform_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">novel_</span> <span class="o">=</span> <span class="n">novel_dict</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">creategermlines</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">fileformat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germtypes</span> <span class="o">=</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="n">genotype_fasta</span> <span class="o">=</span> <span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">germline_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">v_field</span> <span class="o">=</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">cloned</span> <span class="o">=</span> <span class="n">cloned</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">fileformat_passed_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Insufficient contigs for running tigger-genotype. Defaulting to original heavy chain v_calls.&#39;</span><span class="p">)</span>
                <span class="n">tigger_failed</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Running tigger-genotype without novel allele discovery.&#39;</span><span class="p">)</span>
            <span class="n">tigger_genotype</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">v_germline</span> <span class="o">=</span> <span class="n">v_germline</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="n">fform_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">novel_</span> <span class="o">=</span> <span class="n">novel_dict</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">creategermlines</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">fileformat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germtypes</span> <span class="o">=</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="n">genotype_fasta</span> <span class="o">=</span> <span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">germline_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">v_field</span> <span class="o">=</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">cloned</span> <span class="o">=</span> <span class="n">cloned</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">fileformat_passed_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Insufficient contigs for running tigger-genotype. Defaulting to original heavy chain v_calls.&#39;</span><span class="p">)</span>
            <span class="n">tigger_failed</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;tigger_failed&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="n">creategermlines</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germtypes</span> <span class="o">=</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="n">genotype_fasta</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">v_field</span> <span class="o">=</span> <span class="s1">&#39;v_call&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">cloned</span> <span class="o">=</span> <span class="n">cloned</span><span class="p">)</span>
        <span class="n">creategermlines</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_light&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germtypes</span> <span class="o">=</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;light&#39;</span><span class="p">,</span> <span class="n">genotype_fasta</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">v_field</span> <span class="o">=</span> <span class="s1">&#39;v_call&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">cloned</span> <span class="o">=</span> <span class="n">cloned</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      For convenience, entries for heavy chain in `v_call` are copied to `v_call_genotyped`.&#39;</span><span class="p">)</span>
        <span class="n">heavy</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">germpass_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
        <span class="n">heavy</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heavy</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      For convenience, entries for light chain `v_call` are copied to `v_call_genotyped`.&#39;</span><span class="p">)</span>
        <span class="n">light</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_light&#39;</span><span class="o">+</span><span class="n">germpass_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>        
        <span class="n">light</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">light</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">creategermlines</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_light&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germtypes</span> <span class="o">=</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;light&#39;</span><span class="p">,</span> <span class="n">genotype_fasta</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">v_field</span> <span class="o">=</span> <span class="s1">&#39;v_call&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">cloned</span> <span class="o">=</span> <span class="n">cloned</span><span class="p">)</span>
        <span class="n">heavy</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">fileformat_passed_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      For convenience, entries for light chain `v_call` are copied to `v_call_genotyped`.&#39;</span><span class="p">)</span>
        <span class="n">light</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_light&#39;</span><span class="o">+</span><span class="n">germpass_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
        <span class="n">light</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">light</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">]</span>
    
    <span class="n">sampledict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">heavy</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">],</span> <span class="n">light</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sampleNames_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">dat_f</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">dat_f</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampleNames_dict</span><span class="p">[</span><span class="n">file</span><span class="p">]</span>
        <span class="n">heavy</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dat_f</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">])</span>
        <span class="n">light</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dat_f</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">])</span>

    <span class="n">dat_</span> <span class="o">=</span> <span class="n">heavy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">light</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;cell_id&#39;</span> <span class="ow">in</span> <span class="n">dat_</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">dat_</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dat_</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;sequence_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;tigger_failed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Returning summary plot&#39;</span><span class="p">)</span>
            <span class="n">inferred_genotype</span> <span class="o">=</span> <span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">inferred_fileformat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]</span>
            <span class="n">inf_geno</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">inferred_genotype</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span>
    
            <span class="n">s2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inf_geno</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">])</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">samp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">heavy</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">])):</span>
                <span class="n">res_x</span> <span class="o">=</span> <span class="n">heavy</span><span class="p">[(</span><span class="n">heavy</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">samp</span><span class="p">)]</span>
                <span class="n">V_</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res_x</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">]]</span>
                <span class="n">V_g</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res_x</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]]</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">V_</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>
                <span class="n">setdiff</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">-</span> <span class="n">s2</span>
                <span class="n">ambiguous</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">V_</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">V_</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">V_g</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">V_g</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">not_in_genotype</span><span class="o">=</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="n">setdiff</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">V_</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">V_</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="ow">in</span> <span class="n">setdiff</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">V_g</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">V_g</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">ambiguous</span><span class="p">,</span><span class="n">not_in_genotype</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ambiguous&#39;</span><span class="p">,</span> <span class="s1">&#39;not_in_genotype&#39;</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">([</span><span class="s1">&#39;vgroup&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samp</span>
                <span class="c1"># stats[&#39;donor&#39;] = str(combined_folder)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">ambiguous_table</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;vgroup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ambiguous&#39;</span><span class="p">]</span>
            <span class="n">not_in_genotype_table</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;vgroup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;not_in_genotype&#39;</span><span class="p">]</span>
            <span class="n">ambiguous_table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">not_in_genotype_table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="c1"># melting the dataframe</span>
            <span class="n">ambiguous_table_before</span> <span class="o">=</span> <span class="n">ambiguous_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ambiguous_table_before</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;before&quot;</span><span class="p">:</span> <span class="s2">&quot;var&quot;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">ambiguous_table_before</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;before&#39;</span>
            <span class="n">ambiguous_table_after</span> <span class="o">=</span> <span class="n">ambiguous_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ambiguous_table_after</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="s2">&quot;var&quot;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">ambiguous_table_after</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;after&#39;</span>
            <span class="n">ambiguous_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ambiguous_table_before</span><span class="p">,</span> <span class="n">ambiguous_table_after</span><span class="p">])</span>
            <span class="n">not_in_genotype_table_before</span> <span class="o">=</span> <span class="n">not_in_genotype_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">not_in_genotype_table_before</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;before&quot;</span><span class="p">:</span> <span class="s2">&quot;var&quot;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">not_in_genotype_table_before</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;before&#39;</span>
            <span class="n">not_in_genotype_table_after</span> <span class="o">=</span> <span class="n">not_in_genotype_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">not_in_genotype_table_after</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="s2">&quot;var&quot;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">not_in_genotype_table_after</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;after&#39;</span>
            <span class="n">not_in_genotype_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">not_in_genotype_table_before</span><span class="p">,</span> <span class="n">not_in_genotype_table_after</span><span class="p">])</span>
            <span class="n">ambiguous_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ambiguous_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
            <span class="n">not_in_genotype_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_in_genotype_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
            <span class="n">ambiguous_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">reorder_categories</span><span class="p">([</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">not_in_genotype_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">reorder_categories</span><span class="p">([</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
            <span class="n">options</span><span class="o">.</span><span class="n">figure_size</span> <span class="o">=</span> <span class="n">figsize</span>
            <span class="n">final_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ambiguous_table</span><span class="p">,</span> <span class="n">not_in_genotype_table</span><span class="p">])</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ggplot</span><span class="p">(</span><span class="n">final_table</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;var_group&#39;</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">coord_flip</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="s2">&quot;sample_id&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">% a</span><span class="s2">llele calls&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Genotype reassignment with TIgGER&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">facet_grid</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;vgroup&#39;</span><span class="p">),</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;#86bcb6&#39;</span><span class="p">,</span> <span class="s1">&#39;#F28e2b&#39;</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_title</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">()))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># if split_write_out:</span>
    <span class="k">if</span> <span class="s1">&#39;tigger_failed&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Although tigger-genotype was not run successfully, file will still be saved with `_genotyped.tsv` extension for convenience.&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Writing out to individual folders &#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample_id_dictionary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">dat_</span><span class="p">[</span><span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sample_id_dictionary</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">dat_</span><span class="p">[</span><span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span>
        <span class="n">outfilepath</span> <span class="o">=</span> <span class="n">filePath_dict</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">out_file</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfilepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;_genotyped.tsv&#39;</span><span class="p">),</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">reassign_alleles_</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">combined_folder</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="s1">&#39;human&#39;</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="s1">&#39;blast&#39;</span><span class="p">,</span> <span class="n">seq_field</span> <span class="o">=</span> <span class="s1">&#39;sequence_alignment&#39;</span><span class="p">,</span> <span class="n">v_field</span><span class="o">=</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">,</span> <span class="n">d_field</span><span class="o">=</span><span class="s1">&#39;d_call&#39;</span><span class="p">,</span> <span class="n">j_field</span><span class="o">=</span><span class="s1">&#39;j_call&#39;</span><span class="p">,</span> <span class="n">germ_types</span><span class="o">=</span><span class="s1">&#39;dmask&#39;</span><span class="p">,</span> <span class="n">novel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">sample_id_dictionary</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct allele calls based on a personalized genotype using tigger-reassignAlleles. It uses a subject-specific genotype to correct correct preliminary allele assignments of a set of sequences derived from a single subject.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : list</span>
<span class="sd">        list or sequence of data folders containing the .tsv files. if provided as a single string, it will first be converted to a list; this allows for the function to be run on single/multiple samples.</span>
<span class="sd">    combined_folder : str</span>
<span class="sd">        name of folder for concatenated data file and genotyped files.</span>
<span class="sd">    germline : str, optional</span>
<span class="sd">        path to germline database folder. Defaults to `$GERMLINE` environmental variable.</span>
<span class="sd">    org : str</span>
<span class="sd">        organism of germline database. Default is &#39;human&#39;.</span>
<span class="sd">    fileformat : str</span>
<span class="sd">        format of V(D)J file/objects. Default is &#39;blast&#39;. Also accepts &#39;changeo&#39; (same behaviour as &#39;blast&#39;) and &#39;airr&#39;.</span>
<span class="sd">    org : str</span>
<span class="sd">        organism of germline database. Default is &#39;human&#39;.</span>
<span class="sd">    seq_field : str</span>
<span class="sd">        name of column containing the aligned sequence. Default is &#39;sequence_alignment&#39; (airr).</span>
<span class="sd">    v_field : str</span>
<span class="sd">        name of column containing the germline V segment call. Default is &#39;v_call_genotyped&#39; (airr) after tigger.</span>
<span class="sd">    d_field : str</span>
<span class="sd">        name of column containing the germline d segment call. Default is &#39;d_call&#39; (airr).</span>
<span class="sd">    j_field : str</span>
<span class="sd">        name of column containing the germline j segment call. Default is &#39;j_call&#39; (airr).</span>
<span class="sd">    germ_types : str</span>
<span class="sd">        Specify type(s) of germlines to include full germline, germline with D segment masked, or germline for V segment only. Default is &#39;dmask&#39;.</span>
<span class="sd">    novel : bool</span>
<span class="sd">        whether or not to run novel allele discovery during tigger-genotyping. Default is True (yes).</span>
<span class="sd">    plot : bool</span>
<span class="sd">        whether or not to plot reassignment summary metrics. Default is True.</span>
<span class="sd">    figsize : tuple[float, float]</span>
<span class="sd">        size of figure. Default is (4, 3).</span>
<span class="sd">    sample_id_dictionary : dict, optional</span>
<span class="sd">        dictionary for creating a sample_id column in the concatenated file.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Whether or not to print the command used in the terminal. Default is False.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Individual V(D)J data files with v_call_genotyped column containing reassigned heavy chain v calls</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>

    <span class="n">informat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap.tsv&#39;</span><span class="p">}</span>
    <span class="n">fileformat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_genotyped.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_genotyped.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap_genotyped.tsv&#39;</span><span class="p">}</span>
    <span class="n">inferred_fileformat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_inferredGenotype.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_inferredGenotype.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap_inferredGenotype.txt&#39;</span><span class="p">}</span>
    <span class="n">germline_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_genotype.fasta&#39;</span><span class="p">,</span> <span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_db-pass_genotype.fasta&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;_igblast_gap_genotype.fasta&#39;</span><span class="p">}</span>
    <span class="n">fform_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;blast&#39;</span><span class="p">:</span><span class="s1">&#39;airr&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span><span class="s1">&#39;airr&#39;</span><span class="p">,</span> <span class="s1">&#39;changeo&#39;</span><span class="p">:</span><span class="s1">&#39;changeo&#39;</span><span class="p">}</span>

    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filePath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Processing data file(s) &#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]):</span>
            <span class="n">filePath</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;dandelion&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
                            <span class="n">out_</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/data/&#39;</span>
                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]):</span>
                                    <span class="n">filePath</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="n">x</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out_</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]):</span>
                                <span class="n">filePath</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">filePath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Path to .tsv file for </span><span class="si">{}</span><span class="s1"> is unknown. Please specify path to reannotated .tsv file or folder containing reannotated .tsv file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

        <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_id_dictionary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_id_dictionary</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

    <span class="c1"># concatenate</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Concatenating objects&#39;</span><span class="p">)</span>
        <span class="n">dat_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dat_</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># write out this file for tigger</span>
    <span class="n">outDir</span> <span class="o">=</span> <span class="n">combined_folder</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outDir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outDir</span><span class="p">)</span>

    <span class="n">novel_dict</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span><span class="s1">&#39;YES&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span><span class="s1">&#39;NO&#39;</span><span class="p">}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Writing out concatenated object&#39;</span><span class="p">)</span>
    <span class="c1"># dat_.to_csv(outDir+&#39;filtered_contig&#39;+informat_dict[fileformat], index = False, sep = &#39;\t&#39;, na_rep=&#39;&#39;)</span>
    <span class="n">dat_h</span> <span class="o">=</span> <span class="n">dat_</span><span class="p">[</span><span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">]</span>
    <span class="n">dat_h</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">novel</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Running tigger-genotype with novel allele discovery.&#39;</span><span class="p">)</span>
            <span class="n">tigger_genotype</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="n">fform_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">novel_</span> <span class="o">=</span> <span class="n">novel_dict</span><span class="p">[</span><span class="n">novel</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">out_h</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">fileformat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
            <span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">out_h</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Novel allele discovery exceution halted.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Attempting to run tigger-genotype without novel allele discovery.&#39;</span><span class="p">)</span>
                <span class="n">tigger_genotype</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="n">fform_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">novel_</span> <span class="o">=</span> <span class="n">novel_dict</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">out_h</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">fileformat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
                <span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">out_h</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">])</span>
                <span class="n">tigger_novel_failed</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Insufficient contigs for running tigger-genotype. Defaulting to using original v_calls.&#39;</span><span class="p">)</span>
                <span class="n">out_h</span> <span class="o">=</span> <span class="n">dat_h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      For convenience, entries in `v_call` are copied to `v_call_genotyped`.&#39;</span><span class="p">)</span>
                <span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">out_h</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">])</span>
                <span class="n">tigger_failed</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Running tigger-genotype without novel allele discovery.&#39;</span><span class="p">)</span>
            <span class="n">tigger_genotype</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="n">fform_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">novel_</span> <span class="o">=</span> <span class="n">novel_dict</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">out_h</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">fileformat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>
            <span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">out_h</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">])</span>
            <span class="n">tigger_novel_failed</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      Insufficient contigs for running tigger-genotype. Defaulting to using original v_calls.&#39;</span><span class="p">)</span>
            <span class="n">out_h</span> <span class="o">=</span> <span class="n">dat_h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      For convenience, entries in `v_call` are copied to `v_call_genotyped`.&#39;</span><span class="p">)</span>
            <span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">out_h</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">])</span>
            <span class="n">tigger_failed</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>


    <span class="c1"># transfer light chain V calls to v_call_genotyped as well</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      For convenience, entries for light chain `v_call` are copied to `v_call_genotyped`.&#39;</span><span class="p">)</span>
    <span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dat_</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;v_call&#39;</span><span class="p">])</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">dat_</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="c1"># update with the personalized germline database</span>
    <span class="n">res</span><span class="o">.</span><span class="n">update_germline</span><span class="p">(</span><span class="n">corrected</span> <span class="o">=</span> <span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">germline_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="n">org</span><span class="p">)</span>
    <span class="n">create_germlines</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="n">org</span><span class="p">,</span> <span class="n">seq_field</span> <span class="o">=</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span> <span class="o">=</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span> <span class="o">=</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span> <span class="o">=</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span> <span class="o">=</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="n">fform_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>

    <span class="n">germtypedict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dmask&#39;</span><span class="p">:</span><span class="s1">&#39;germline_alignment_d_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span><span class="s1">&#39;germline_alignment&#39;</span><span class="p">,</span> <span class="s1">&#39;vonly&#39;</span><span class="p">:</span><span class="s1">&#39;germline_alignment_v_region&#39;</span><span class="p">,</span> <span class="s1">&#39;regions&#39;</span><span class="p">:</span><span class="s1">&#39;germline_regions&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">novel</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;tigger_novel_failed&#39;</span> <span class="ow">or</span> <span class="s1">&#39;tigger_failed&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Germline reconstruction with `</span><span class="si">{}</span><span class="s1">` has failed. Re-running with original v_call.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_field</span><span class="p">))</span>
            <span class="n">res</span><span class="o">.</span><span class="n">update_germline</span><span class="p">(</span><span class="n">corrected</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="n">org</span><span class="p">)</span>
            <span class="n">create_germlines</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">germline</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="n">org</span><span class="p">,</span> <span class="n">seq_field</span> <span class="o">=</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span> <span class="o">=</span> <span class="s1">&#39;v_call&#39;</span><span class="p">,</span> <span class="n">d_field</span> <span class="o">=</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span> <span class="o">=</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span> <span class="o">=</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span> <span class="o">=</span> <span class="n">fform_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Saving corrected genotyped object&#39;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="n">fileformat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># reset dat_</span>
    <span class="n">dat_</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Returning summary plot&#39;</span><span class="p">)</span>
        <span class="n">inferred_genotype</span> <span class="o">=</span> <span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">outDir</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="o">+</span><span class="n">inferred_fileformat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]</span>
        <span class="n">inf_geno</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">inferred_genotype</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span>

        <span class="n">s2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inf_geno</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">samp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">out_h</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">])):</span>
            <span class="n">res_x</span> <span class="o">=</span> <span class="n">out_h</span><span class="p">[(</span><span class="n">out_h</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">samp</span><span class="p">)]</span>
            <span class="n">V_</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res_x</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">]]</span>
            <span class="n">V_g</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res_x</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]]</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">V_</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>
            <span class="n">setdiff</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">-</span> <span class="n">s2</span>
            <span class="n">ambiguous</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">V_</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">V_</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">V_g</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">V_g</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">not_in_genotype</span><span class="o">=</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="n">setdiff</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">V_</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">V_</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="ow">in</span> <span class="n">setdiff</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">V_g</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">V_g</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">ambiguous</span><span class="p">,</span><span class="n">not_in_genotype</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ambiguous&#39;</span><span class="p">,</span> <span class="s1">&#39;not_in_genotype&#39;</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">([</span><span class="s1">&#39;vgroup&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samp</span>
            <span class="c1"># stats[&#39;donor&#39;] = str(combined_folder)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">ambiguous_table</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;vgroup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ambiguous&#39;</span><span class="p">]</span>
        <span class="n">not_in_genotype_table</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;vgroup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;not_in_genotype&#39;</span><span class="p">]</span>
        <span class="n">ambiguous_table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">not_in_genotype_table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># melting the dataframe</span>
        <span class="n">ambiguous_table_before</span> <span class="o">=</span> <span class="n">ambiguous_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ambiguous_table_before</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;before&quot;</span><span class="p">:</span> <span class="s2">&quot;var&quot;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">ambiguous_table_before</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;before&#39;</span>
        <span class="n">ambiguous_table_after</span> <span class="o">=</span> <span class="n">ambiguous_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ambiguous_table_after</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="s2">&quot;var&quot;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">ambiguous_table_after</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;after&#39;</span>
        <span class="n">ambiguous_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ambiguous_table_before</span><span class="p">,</span> <span class="n">ambiguous_table_after</span><span class="p">])</span>
        <span class="n">not_in_genotype_table_before</span> <span class="o">=</span> <span class="n">not_in_genotype_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">not_in_genotype_table_before</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;before&quot;</span><span class="p">:</span> <span class="s2">&quot;var&quot;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">not_in_genotype_table_before</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;before&#39;</span>
        <span class="n">not_in_genotype_table_after</span> <span class="o">=</span> <span class="n">not_in_genotype_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">not_in_genotype_table_after</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="s2">&quot;var&quot;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">not_in_genotype_table_after</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;after&#39;</span>
        <span class="n">not_in_genotype_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">not_in_genotype_table_before</span><span class="p">,</span> <span class="n">not_in_genotype_table_after</span><span class="p">])</span>
        <span class="n">ambiguous_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ambiguous_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">not_in_genotype_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_in_genotype_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">ambiguous_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">reorder_categories</span><span class="p">([</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">not_in_genotype_table</span><span class="p">[</span><span class="s1">&#39;var_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">reorder_categories</span><span class="p">([</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">options</span><span class="o">.</span><span class="n">figure_size</span> <span class="o">=</span> <span class="n">figsize</span>
        <span class="n">final_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ambiguous_table</span><span class="p">,</span> <span class="n">not_in_genotype_table</span><span class="p">])</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ggplot</span><span class="p">(</span><span class="n">final_table</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;var_group&#39;</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">coord_flip</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="s2">&quot;sample_id&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">% a</span><span class="s2">llele calls&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Genotype reassignment with TIgGER&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">facet_grid</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;vgroup&#39;</span><span class="p">),</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;#86bcb6&#39;</span><span class="p">,</span> <span class="s1">&#39;#F28e2b&#39;</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_title</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">()))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># if split_write_out:</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Writing out to individual folders &#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample_id_dictionary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">dat_</span><span class="p">[</span><span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sample_id_dictionary</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">dat_</span><span class="p">[</span><span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]):</span>
            <span class="n">filePath</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;dandelion&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
                            <span class="n">out_</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/data/&#39;</span>
                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]):</span>
                                    <span class="n">filePath</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="n">x</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out_</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">informat_dict</span><span class="p">[</span><span class="n">fileformat</span><span class="p">]):</span>
                                <span class="n">filePath</span> <span class="o">=</span> <span class="n">out_</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">x</span>
        <span class="n">out_file</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filePath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;_genotyped.tsv&#39;</span><span class="p">),</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="create_germlines"><a class="viewcode-back" href="../../../modules/dandelion.preprocessing.create_germlines.html#dandelion.preprocessing.create_germlines">[docs]</a><span class="k">def</span> <span class="nf">create_germlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="s1">&#39;human&#39;</span><span class="p">,</span> <span class="n">seq_field</span><span class="o">=</span><span class="s1">&#39;sequence_alignment&#39;</span><span class="p">,</span> <span class="n">v_field</span><span class="o">=</span><span class="s1">&#39;v_call&#39;</span><span class="p">,</span> <span class="n">d_field</span><span class="o">=</span><span class="s1">&#39;d_call&#39;</span><span class="p">,</span> <span class="n">j_field</span><span class="o">=</span><span class="s1">&#39;j_call&#39;</span><span class="p">,</span> <span class="n">germ_types</span><span class="o">=</span><span class="s1">&#39;dmask&#39;</span><span class="p">,</span> <span class="n">fileformat</span><span class="o">=</span><span class="s1">&#39;airr&#39;</span><span class="p">,</span> <span class="n">initialize_metadata</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs CreateGermlines.py to reconstruct the germline V(D)J sequence, from which the Ig lineage and mutations can be inferred.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion, DataFrame, str</span>
<span class="sd">        `Dandelion` object, pandas `DataFrame` in changeo/airr format, or file path to changeo/airr file after clones have been determined.</span>
<span class="sd">    germline : str, optional</span>
<span class="sd">        path to germline database folder. Defaults to `$GERMLINE` environmental variable.</span>
<span class="sd">    org : str</span>
<span class="sd">        organism of germline database. Default is &#39;human&#39;.</span>
<span class="sd">    seq_field : str</span>
<span class="sd">        name of column containing the aligned sequence. Default is &#39;sequence_alignment&#39; (airr).</span>
<span class="sd">    v_field : str</span>
<span class="sd">        name of column containing the germline V segment call. Default is &#39;v_call&#39; (airr).</span>
<span class="sd">    d_field : str</span>
<span class="sd">        name of column containing the germline d segment call. Default is &#39;d_call&#39; (airr).</span>
<span class="sd">    j_field : str</span>
<span class="sd">        name of column containing the germline j segment call. Default is &#39;j_call&#39; (airr).</span>
<span class="sd">    germ_types : str</span>
<span class="sd">        Specify type(s) of germlines to include full germline, germline with D segment masked, or germline for V segment only. Default is &#39;dmask&#39;.</span>
<span class="sd">    fileformat : str</span>
<span class="sd">        format of V(D)J file/objects. Default is &#39;airr&#39;. Also accepts &#39;changeo&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    V(D)J data file with reconstructed germline sequences.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reconstructing germline sequences&#39;</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">germline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gml</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;GERMLINE&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Environmental variable GERMLINE must be set. Otherwise, please provide path to folder containing germline fasta files.&#39;</span><span class="p">)</span>
        <span class="n">gml</span> <span class="o">=</span> <span class="n">gml</span><span class="o">+</span><span class="s1">&#39;imgt/&#39;</span><span class="o">+</span><span class="n">org</span><span class="o">+</span><span class="s1">&#39;/vdj/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">germline</span><span class="p">):</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;GERMLINE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">germline</span>
            <span class="n">gml</span> <span class="o">=</span> <span class="n">germline</span>

    <span class="k">def</span> <span class="nf">_parseChangeO</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses a dictionary to a Receptor object</span>

<span class="sd">        Arguments:</span>
<span class="sd">          record : dict with fields and values in the Change-O format</span>

<span class="sd">        Returns:</span>
<span class="sd">        changeo.Receptor.Receptor : parsed Receptor object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Parse fields</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">ChangeoSchema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">Receptor</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parseAIRR</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses a dictionary of AIRR records to a Receptor object</span>

<span class="sd">        Arguments:</span>
<span class="sd">          record : dict with fields and values in the AIRR format.</span>

<span class="sd">        Returns:</span>
<span class="sd">        changeo.Receptor.Receptor : parsed Receptor object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Parse fields</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Rename fields</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">AIRRSchema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="c1"># Convert start positions to 0-based</span>
            <span class="c1"># if k in ReceptorData.start_fields and v is not None and v != &#39;&#39;:</span>
            <span class="c1">#     v = str(int(v) + 1)</span>
            <span class="c1"># Assign new field</span>
            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">for</span> <span class="n">end</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ReceptorData</span><span class="o">.</span><span class="n">end_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="n">end</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">end</span><span class="p">])</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">start</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">return</span> <span class="n">Receptor</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_germlines_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">references</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write germline sequences to tab-delimited database file</span>

<span class="sd">        Arguments:</span>
<span class="sd">        self : dandelion_class object</span>
<span class="sd">        references : folders and/or files containing germline repertoire data in FASTA format.</span>
<span class="sd">        seq_field : field in which to look for sequence.</span>
<span class="sd">        v_field : field in which to look for V call.</span>
<span class="sd">        d_field : field in which to look for D call.</span>
<span class="sd">        j_field : field in which to look for J call.</span>
<span class="sd">        # cloned : if True build germlines by clone, otherwise build individual germlines.</span>
<span class="sd">        # clone_field : field containing clone identifiers; ignored if cloned=False.</span>
<span class="sd">        germ_types : list of germline sequence types to be output from the set of &#39;full&#39;, &#39;dmask&#39;, &#39;vonly&#39;, &#39;regions&#39;</span>
<span class="sd">        fileformat : str</span>
<span class="sd">            format of V(D)J file/objects. Default is &#39;airr&#39;. Also accepts &#39;changeo&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define format operators</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">getFormatOperators</span><span class="p">(</span><span class="n">fileformat</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid format </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fileformat</span><span class="p">)</span>

        <span class="c1"># Define output germline fields</span>
        <span class="n">germline_fields</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">seq_type</span> <span class="o">=</span> <span class="n">seq_field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;full&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
            <span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;germline_&#39;</span> <span class="o">+</span> <span class="n">seq_type</span>
        <span class="k">if</span> <span class="s1">&#39;dmask&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
            <span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;dmask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;germline_&#39;</span> <span class="o">+</span> <span class="n">seq_type</span> <span class="o">+</span> <span class="s1">&#39;_d_mask&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;vonly&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
            <span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;vonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;germline_&#39;</span> <span class="o">+</span> <span class="n">seq_type</span> <span class="o">+</span> <span class="s1">&#39;_v_region&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;regions&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
            <span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;germline_regions&#39;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">references</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">reference_dict</span> <span class="o">=</span> <span class="n">references</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">references</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="p">[</span><span class="n">references</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">references</span>
            <span class="n">reference_dict</span> <span class="o">=</span> <span class="n">readGermlines</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="c1"># Check for IMGT-gaps in germlines</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reference_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">(</span><span class="s1">&#39;Germline reference sequences do not appear to contain IMGT-numbering spacers. Results may be incorrect.&#39;</span><span class="p">))</span>

        <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v_germ_start_imgt&#39;</span><span class="p">,</span> <span class="s1">&#39;d_germ_start&#39;</span><span class="p">,</span> <span class="s1">&#39;j_germ_start&#39;</span><span class="p">,</span> <span class="s1">&#39;np1_length&#39;</span><span class="p">,</span> <span class="s1">&#39;np2_length&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="c1"># Check for required columns</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">checkFields</span><span class="p">(</span><span class="n">required</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">LookupError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                <span class="c1"># Count input</span>
                <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

                <span class="c1"># Check for existence of fields</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> field does not exist in input database file.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
                <span class="c1"># Translate to Receptor attribute names</span>
                <span class="n">v_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">v_field</span><span class="p">)</span>
                <span class="n">d_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">d_field</span><span class="p">)</span>
                <span class="n">j_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">j_field</span><span class="p">)</span>
                <span class="n">seq_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">seq_field</span><span class="p">)</span>
                <span class="c1"># clone_field = schema.toReceptor(clone_field)</span>

                <span class="c1"># Define Receptor iterator</span>
                <span class="n">receptor_iter</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">]</span><span class="o">.</span><span class="n">sequence_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s1">&#39;Please initialise the Dandelion object with a dataframe in data slot.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">checkFields</span><span class="p">(</span><span class="n">required</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">LookupError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="c1"># Count input</span>
            <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="c1"># Check for existence of fields</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> field does not exist in input database file.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
            <span class="c1"># Translate to Receptor attribute names</span>
            <span class="n">v_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">v_field</span><span class="p">)</span>
            <span class="n">d_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">d_field</span><span class="p">)</span>
            <span class="n">j_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">j_field</span><span class="p">)</span>
            <span class="n">seq_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">seq_field</span><span class="p">)</span>
            <span class="c1"># clone_field = schema.toReceptor(clone_field)</span>
            <span class="c1"># Define Receptor iterator</span>
            <span class="n">receptor_iter</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">]</span><span class="o">.</span><span class="n">sequence_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Iterate over rows</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">records</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">receptor_iter</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;   Building </span><span class="si">{}</span><span class="s2"> germline sequences&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">germ_types</span><span class="p">)):</span>
            <span class="c1"># Define iteration variables</span>
            <span class="c1"># Build germline for records</span>
            <span class="k">if</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span>
                <span class="n">germ_log</span><span class="p">,</span> <span class="n">glines</span><span class="p">,</span> <span class="n">genes</span> <span class="o">=</span> <span class="n">buildGermline</span><span class="p">(</span><span class="n">_parseAIRR</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">records</span><span class="p">)),</span> <span class="n">reference_dict</span><span class="p">,</span> <span class="n">seq_field</span><span class="o">=</span><span class="n">seq_field_</span><span class="p">,</span> <span class="n">v_field</span><span class="o">=</span><span class="n">v_field_</span><span class="p">,</span> <span class="n">d_field</span><span class="o">=</span><span class="n">d_field_</span><span class="p">,</span> <span class="n">j_field</span><span class="o">=</span><span class="n">j_field_</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;changeo&#39;</span><span class="p">:</span>
                <span class="n">germ_log</span><span class="p">,</span> <span class="n">glines</span><span class="p">,</span> <span class="n">genes</span> <span class="o">=</span> <span class="n">buildGermline</span><span class="p">(</span><span class="n">_parseChangeO</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">records</span><span class="p">)),</span> <span class="n">reference_dict</span><span class="p">,</span> <span class="n">seq_field</span><span class="o">=</span><span class="n">seq_field_</span><span class="p">,</span> <span class="n">v_field</span><span class="o">=</span><span class="n">v_field_</span><span class="p">,</span> <span class="n">d_field</span><span class="o">=</span><span class="n">d_field_</span><span class="p">,</span> <span class="n">j_field</span><span class="o">=</span><span class="n">j_field_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not acceptable file format.&#39;</span> <span class="o">%</span> <span class="n">fileformat</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">glines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Add glines to Receptor record</span>
                <span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="s1">&#39;full&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
                    <span class="n">annotations</span><span class="p">[</span><span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">glines</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;dmask&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
                    <span class="n">annotations</span><span class="p">[</span><span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;dmask&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">glines</span><span class="p">[</span><span class="s1">&#39;dmask&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;vonly&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
                    <span class="n">annotations</span><span class="p">[</span><span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;vonly&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">glines</span><span class="p">[</span><span class="s1">&#39;vonly&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;regions&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
                    <span class="n">annotations</span><span class="p">[</span><span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">glines</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">]</span>
                <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="n">annotations</span><span class="p">})</span>
        <span class="n">germline_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="c1"># datx = load_data(self.data)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">germline_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">germline_df</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="n">datx</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">germline_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">datx</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">germline_df</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">datx</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">reference_dict</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">datx</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">reference_dict</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
        <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Updated Dandelion object: </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">data</span><span class="se">\&#39;</span><span class="s1">, updated germline alignment in contig-indexed clone table</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">germline</span><span class="se">\&#39;</span><span class="s1">, updated germline reference</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_create_germlines_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">references</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write germline sequences to tab-delimited database file</span>

<span class="sd">        Arguments:</span>
<span class="sd">        file : airr/changeo tsv file</span>
<span class="sd">        references : folders and/or files containing germline repertoire data in FASTA format.</span>
<span class="sd">        seq_field : field in which to look for sequence.</span>
<span class="sd">        v_field : field in which to look for V call.</span>
<span class="sd">        d_field : field in which to look for D call.</span>
<span class="sd">        j_field : field in which to look for J call.</span>
<span class="sd">        cloned : if True build germlines by clone, otherwise build individual germlines.</span>
<span class="sd">        germ_types : list of germline sequence types to be output from the set of &#39;full&#39;, &#39;dmask&#39;, &#39;vonly&#39;, &#39;regions&#39;</span>
<span class="sd">        fileformat : str</span>
<span class="sd">                format of V(D)J file/objects. Default is &#39;airr&#39;. Also accepts &#39;changeo&#39;.</span>
<span class="sd">        Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define format operators</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">getFormatOperators</span><span class="p">(</span><span class="n">fileformat</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid format </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fileformat</span><span class="p">)</span>

        <span class="c1"># Define output germline fields</span>
        <span class="n">germline_fields</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">seq_type</span> <span class="o">=</span> <span class="n">seq_field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;full&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
            <span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;germline_&#39;</span> <span class="o">+</span> <span class="n">seq_type</span>
        <span class="k">if</span> <span class="s1">&#39;dmask&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
            <span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;dmask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;germline_&#39;</span> <span class="o">+</span> <span class="n">seq_type</span> <span class="o">+</span> <span class="s1">&#39;_d_mask&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;vonly&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
            <span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;vonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;germline_&#39;</span> <span class="o">+</span> <span class="n">seq_type</span> <span class="o">+</span> <span class="s1">&#39;_v_region&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;regions&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
            <span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;germline_regions&#39;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">references</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">reference_dict</span> <span class="o">=</span> <span class="n">references</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">references</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="p">[</span><span class="n">references</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">references</span>
            <span class="n">reference_dict</span> <span class="o">=</span> <span class="n">readGermlines</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="c1"># Check for IMGT-gaps in germlines</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reference_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">(</span><span class="s1">&#39;Germline reference sequences do not appear to contain IMGT-numbering spacers. Results may be incorrect.&#39;</span><span class="p">))</span>

        <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v_germ_start_imgt&#39;</span><span class="p">,</span> <span class="s1">&#39;d_germ_start&#39;</span><span class="p">,</span> <span class="s1">&#39;j_germ_start&#39;</span><span class="p">,</span> <span class="s1">&#39;np1_length&#39;</span><span class="p">,</span> <span class="s1">&#39;np2_length&#39;</span><span class="p">]</span>

        <span class="c1"># Get repertoire and open Db reader</span>
        <span class="n">db_handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span>
        <span class="n">db_iter</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">db_handle</span><span class="p">)</span>
        <span class="c1"># Check for required columns</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">checkFields</span><span class="p">(</span><span class="n">required</span><span class="p">,</span> <span class="n">db_iter</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">LookupError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="c1"># Count input</span>
        <span class="n">total_count</span> <span class="o">=</span> <span class="n">countDbFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="c1"># Check for existence of fields</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db_iter</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> field does not exist in input database file.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
        <span class="c1"># Translate to Receptor attribute names</span>
        <span class="n">v_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">v_field</span><span class="p">)</span>
        <span class="n">d_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">d_field</span><span class="p">)</span>
        <span class="n">j_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">j_field</span><span class="p">)</span>
        <span class="n">seq_field_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toReceptor</span><span class="p">(</span><span class="n">seq_field</span><span class="p">)</span>
        <span class="c1"># clone_field = schema.toReceptor(clone_field)</span>
        <span class="c1"># Define Receptor iterator</span>
        <span class="n">receptor_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">sequence_id</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">db_iter</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Iterate over rows</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">records</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">receptor_iter</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;   Building </span><span class="si">{}</span><span class="s2"> germline sequences&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">germ_types</span><span class="p">)):</span>
            <span class="c1"># Define iteration variables</span>
            <span class="c1"># Build germline for records</span>
            <span class="c1"># if not isinstance(self.data, pd.DataFrame):</span>
            <span class="n">records</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
            <span class="n">germ_log</span><span class="p">,</span> <span class="n">glines</span><span class="p">,</span> <span class="n">genes</span> <span class="o">=</span> <span class="n">buildGermline</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reference_dict</span><span class="p">,</span> <span class="n">seq_field</span><span class="o">=</span><span class="n">seq_field_</span><span class="p">,</span> <span class="n">v_field</span><span class="o">=</span><span class="n">v_field_</span><span class="p">,</span> <span class="n">d_field</span><span class="o">=</span><span class="n">d_field_</span><span class="p">,</span> <span class="n">j_field</span><span class="o">=</span><span class="n">j_field_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">glines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Add glines to Receptor record</span>
                <span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="s1">&#39;full&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
                    <span class="n">annotations</span><span class="p">[</span><span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">glines</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;dmask&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
                    <span class="n">annotations</span><span class="p">[</span><span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;dmask&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">glines</span><span class="p">[</span><span class="s1">&#39;dmask&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;vonly&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
                    <span class="n">annotations</span><span class="p">[</span><span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;vonly&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">glines</span><span class="p">[</span><span class="s1">&#39;vonly&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;regions&#39;</span> <span class="ow">in</span> <span class="n">germ_types</span><span class="p">:</span>
                    <span class="n">annotations</span><span class="p">[</span><span class="n">germline_fields</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">glines</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">]</span>
                <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="n">annotations</span><span class="p">})</span>
        <span class="n">germline_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">reference_dict</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">reference_dict</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">germline_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">germline_df</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_germline_</span><span class="si">{}</span><span class="s2">.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">germ_types</span><span class="p">),</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">germline</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">germline</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="n">_create_germlines_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">germline</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">_create_germlines_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">germline</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">_create_germlines_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">germline</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_create_germlines_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_create_germlines_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gml</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">_create_germlines_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gml</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">_create_germlines_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gml</span><span class="p">,</span> <span class="n">seq_field</span><span class="p">,</span> <span class="n">v_field</span><span class="p">,</span> <span class="n">d_field</span><span class="p">,</span> <span class="n">j_field</span><span class="p">,</span> <span class="n">germ_types</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">))</span></div>

<div class="viewcode-block" id="filter_bcr"><a class="viewcode-back" href="../../../modules/dandelion.preprocessing.filter_bcr.html#dandelion.preprocessing.filter_bcr">[docs]</a><span class="k">def</span> <span class="nf">filter_bcr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">adata</span><span class="p">,</span> <span class="n">filter_bcr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filter_rna</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filter_poorqualitybcr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rescue_igh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">umi_foldchange_cutoff</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">filter_lightchains</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filter_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ncpu</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filters doublets and poor quality cells and corresponding contigs based on provided V(D)J `DataFrame` and `AnnData` objects. Depends on a `AnnData`.obs slot populated with &#39;filter_rna&#39; column.</span>
<span class="sd">    If the aligned sequence is an exact match between contigs, the contigs will be merged into the one with the highest umi count, adding the summing the umi count of the duplicated contigs to duplicate_count column. After this check, if there are still multiple contigs, cells with multiple IGH contigs are filtered unless `rescue_igh` is True, where by the umi counts for each IGH contig will then be compared. The contig with the highest umi that is &gt; umi_foldchange_cutoff (default is empirically set at 5) from the lowest will be retained.</span>
<span class="sd">    If there&#39;s multiple contigs that survive the &#39;rescue&#39;, then all contigs will be filtered. The default behaviour is to also filter cells with multiple lightchains but this may sometimes be a true biological occurrence; toggling filter_lightchains to False will rescue the mutltiplet light chains.</span>
<span class="sd">    Lastly, contigs with no corresponding cell barcode in the AnnData object is filtered if filter_missing is True. However, this may be useful to toggle to False if more contigs are preferred to be kept or for integrating with bulk reperotire seq data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : DataDrame, str</span>
<span class="sd">        V(D)J airr/changeo data to filter. Can be pandas `DataFrame` object or file path as string.</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        AnnData object to filter.</span>
<span class="sd">    filter_bcr : bool</span>
<span class="sd">        If True, V(D)J `DataFrame` object returned will be filtered. Default is True.</span>
<span class="sd">    filter_rna : bool</span>
<span class="sd">        If True, `AnnData` object returned will be filtered. Default is True.</span>
<span class="sd">    filter_poorqualitybcr : bool</span>
<span class="sd">        If True, barcodes marked with poor quality BCR contigs will be filtered. Default is False; only relevant contigs are removed and RNA barcodes are kept.</span>
<span class="sd">    rescue_igh : bool</span>
<span class="sd">        If True, rescues IGH contigs with highest umi counts with a requirement that it passes the `umi_foldchange_cutoff` option. In addition, the sum of the all the heavy chain contigs must be greater than 3 umi or all contigs will be filtered. Default is True.</span>
<span class="sd">    umi_foldchange_cutoff : int</span>
<span class="sd">        related to minimum fold change required to rescue heavy chain contigs/barcode otherwise they will be marked as doublets. Default is empirically set at 2-fold.</span>
<span class="sd">    filter_lightchains : bool</span>
<span class="sd">        cells with multiple light chains will be marked to filter. Default is True.</span>
<span class="sd">    filter_missing : bool</span>
<span class="sd">        cells in V(D)J data not found in `AnnData` object will be marked to filter. Default is True. This may be useful for toggling to False if integrating with bulk data.</span>
<span class="sd">    parallel : bool</span>
<span class="sd">        whether or not to use parallelization. Default is True.</span>
<span class="sd">    ncpu : int</span>
<span class="sd">        number of cores to use if parallel is True. Default is all available - 1.</span>
<span class="sd">    save : str, optional</span>
<span class="sd">        Only used if a pandas dataframe or dandelion object is provided. Specifying will save the formatted vdj table.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    V(D)J `DataFrame` object in airr/changeo format and `AnnData` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filtering BCRs&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="n">h_umi</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="n">h_dup</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="n">l_umi</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="c1"># l_dup = Tree()</span>
    <span class="n">h_seq</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="n">l_seq</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="n">h_ccall</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="c1"># l_ccall = Tree()</span>

    <span class="n">locus_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="s1">&#39;cell_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;VDJ data does not contain &#39;cell_id&#39; column. Please make sure this is populated before filtering.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;filter_rna&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;AnnData obs does not contain &#39;filter_rna&#39; column. Please run `pp.recipe_scanpy_qc` before continuing.&quot;</span><span class="p">)</span>

    <span class="n">barcode</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]))</span>

    <span class="n">bcr_check</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span>
    <span class="n">bc_</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">barcode</span><span class="p">:</span>
        <span class="n">bc_</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">b</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>
    <span class="n">bcr_check</span><span class="p">[</span><span class="s1">&#39;has_bcr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bc_</span><span class="p">)</span>
    <span class="n">bcr_check</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;has_bcr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bcr_check</span><span class="p">[</span><span class="s1">&#39;has_bcr&#39;</span><span class="p">])</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;has_bcr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;has_bcr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">v_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">]))</span>
    <span class="n">j_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;j_call&#39;</span><span class="p">]))</span>
    <span class="n">c_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span><span class="p">]))</span>

    <span class="c1"># rather than leaving a nan cell, i will create a 0 column for now</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;duplicate_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">global</span> <span class="n">parallel_marking</span>

    <span class="k">def</span> <span class="nf">parallel_marking</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="n">poor_qual</span><span class="p">,</span> <span class="n">h_doublet</span><span class="p">,</span> <span class="n">l_doublet</span><span class="p">,</span> <span class="n">drop_contig</span>  <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="n">hc_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">])</span>
        <span class="n">hc_umi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;umi_count&#39;</span><span class="p">]]</span>
        <span class="n">hc_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;sequence_alignment&#39;</span><span class="p">]]</span>
        <span class="n">hc_dup</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;duplicate_count&#39;</span><span class="p">]]</span>
        <span class="n">hc_ccall</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;c_call&#39;</span><span class="p">]]</span>

        <span class="n">lc_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">]))][</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">])</span>
        <span class="n">lc_umi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">]))][</span><span class="s1">&#39;umi_count&#39;</span><span class="p">]]</span>
        <span class="n">lc_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">]))][</span><span class="s1">&#39;sequence_alignment&#39;</span><span class="p">]]</span>
        <span class="c1"># lc_ccall = [x for x in dat[(dat[&#39;cell_id&#39;].isin([b])) &amp; (dat[&#39;locus&#39;].isin([&#39;IGK&#39;, &#39;IGL&#39;]))][&#39;c_call&#39;]]</span>

        <span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_id</span>
        <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_umi</span>
        <span class="n">h_seq</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_seq</span>
        <span class="n">h_dup</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_dup</span>
        <span class="n">h_ccall</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_ccall</span>

        <span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_id</span>
        <span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_umi</span>
        <span class="n">l_seq</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_seq</span>
        <span class="c1"># l_ccall[b] = lc_ccall</span>

        <span class="c1"># marking doublets defined by heavy chains</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ccall</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">h_seq</span><span class="p">[</span><span class="n">b</span><span class="p">])))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">highest_umi_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="n">highest_umi_h_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">highest_umi_h</span><span class="p">]</span>
                <span class="n">keep_index_h</span> <span class="o">=</span> <span class="n">highest_umi_h_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_h</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="o">+</span><span class="mi">1</span> <span class="p">:])</span>
                <span class="n">keep_hc_contig</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="p">]</span>
                <span class="n">dat</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keep_hc_contig</span><span class="p">,</span> <span class="s1">&#39;duplicate_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_h</span><span class="p">]</span> <span class="o">+</span> <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="o">+</span><span class="mi">1</span> <span class="p">:]))</span>
                <span class="n">hc_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">])</span>
                <span class="n">hc_umi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;umi_count&#39;</span><span class="p">]]</span>
                <span class="n">hc_dup</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;duplicate_count&#39;</span><span class="p">]]</span>
                <span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_id</span>
                <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_umi</span>
                <span class="n">h_dup</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_dup</span>
                <span class="n">h_seq</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_seq</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rescue_igh</span><span class="p">:</span>
                    <span class="n">highest_umi_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">lowest_umi_h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">highest_umi_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">highest_umi_h</span><span class="p">]</span>
                    <span class="n">keep_index_h</span> <span class="o">=</span> <span class="n">highest_umi_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">umi_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">highest_umi_h</span><span class="o">/</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">umi_foldchange_cutoff</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_h</span><span class="p">]</span> <span class="o">+</span> <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="o">+</span><span class="mi">1</span> <span class="p">:]]</span>
                    <span class="n">sum_umi</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">+</span><span class="n">h_dup</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">highest_umi_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">h_doublet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sum_umi</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">h_doublet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">umi_test</span><span class="p">):</span>
                        <span class="n">h_doublet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">highest_umi_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">other_umi_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">highest_umi_h</span><span class="p">]</span>
                        <span class="n">umi_test_</span> <span class="o">=</span> <span class="p">[</span><span class="n">highest_umi_h</span><span class="o">/</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">umi_foldchange_cutoff</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_h</span><span class="p">]</span> <span class="o">+</span> <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="o">+</span><span class="mi">1</span> <span class="p">:]]</span>
                        <span class="n">umi_test_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">other_umi_idx</span><span class="p">,</span> <span class="n">umi_test_</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">otherindex</span> <span class="ow">in</span> <span class="n">umi_test_dict</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">umi_test_dict</span><span class="p">[</span><span class="n">otherindex</span><span class="p">]:</span>
                                <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">otherindex</span><span class="p">])</span>
                                <span class="n">ccall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_ccall</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">otherindex</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccall</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># experimental: see if this can pick up any naive IgM+IgD+ cells?</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">call_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">h_ccall</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="p">])</span><span class="o">+</span><span class="n">ccall</span>
                                <span class="k">if</span> <span class="n">call_list</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;IGHM&#39;</span><span class="p">,</span> <span class="s1">&#39;IGHD&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">call_list</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;IGHD&#39;</span><span class="p">,</span> <span class="s1">&#39;IGHM&#39;</span><span class="p">]:</span>
                                    <span class="n">dat</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keep_hc_contig</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;IGHM|IGHD&#39;</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">h_doublet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">l_seq</span><span class="p">[</span><span class="n">b</span><span class="p">])))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">highest_umi_l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="n">highest_umi_l_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">highest_umi_l</span><span class="p">]</span>
                <span class="n">keep_index_l</span> <span class="o">=</span> <span class="n">highest_umi_l_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_l</span><span class="p">]</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_l</span><span class="o">+</span><span class="mi">1</span> <span class="p">:])</span>
                <span class="n">keep_lc_contig</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_l</span><span class="p">]</span>
                <span class="n">dat</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keep_lc_contig</span><span class="p">,</span> <span class="s1">&#39;duplicate_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_l</span><span class="p">]</span> <span class="o">+</span> <span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_l</span><span class="o">+</span><span class="mi">1</span> <span class="p">:]))</span>
                <span class="n">lc_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">]))][</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">])</span>
                <span class="n">lc_umi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">]))][</span><span class="s1">&#39;umi_count&#39;</span><span class="p">]]</span>
                <span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_id</span>
                <span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_umi</span>
                <span class="n">l_seq</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_seq</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">l_seq</span><span class="p">[</span><span class="n">b</span><span class="p">])))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># also apply the same cut off to multiple light chains</span>
                <span class="n">highest_umi_l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="n">highest_umi_l_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">highest_umi_l</span><span class="p">]</span>
                <span class="n">keep_index_l</span> <span class="o">=</span> <span class="n">highest_umi_l_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">other_umi_idx_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">highest_umi_l</span><span class="p">]</span>
                <span class="n">umi_test_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">highest_umi_l</span><span class="o">/</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">umi_foldchange_cutoff</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_l</span><span class="p">]</span> <span class="o">+</span> <span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_l</span><span class="o">+</span><span class="mi">1</span> <span class="p">:]]</span>
                <span class="n">umi_test_dict_l</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">other_umi_idx_l</span><span class="p">,</span> <span class="n">umi_test_l</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">otherindex</span> <span class="ow">in</span> <span class="n">umi_test_dict_l</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">umi_test_dict_l</span><span class="p">[</span><span class="n">otherindex</span><span class="p">]:</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">otherindex</span><span class="p">])</span>
        <span class="c1"># marking doublets defined by light chains</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">l_doublet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="c1"># marking poor bcr quality, defined as those with only light chains, those</span>
        <span class="c1"># that were have conflicting assignment of locus and heavy/light V/J calls,</span>
        <span class="c1"># and also those that are missing either v or j calls.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hc_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v_dict</span><span class="p">[</span><span class="n">hc_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">j_dict</span><span class="p">[</span><span class="n">hc_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c_dict</span><span class="p">[</span><span class="n">hc_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                        <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                        <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                        <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hc_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hx</span> <span class="ow">in</span> <span class="n">hc_id</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v_dict</span><span class="p">[</span><span class="n">hx</span><span class="p">]</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j_dict</span><span class="p">[</span><span class="n">hx</span><span class="p">]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">c_dict</span><span class="p">[</span><span class="n">hx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                            <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                            <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                            <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lx</span> <span class="ow">in</span> <span class="n">lc_id</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v_dict</span><span class="p">[</span><span class="n">lx</span><span class="p">]</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j_dict</span><span class="p">[</span><span class="n">lx</span><span class="p">]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">c_dict</span><span class="p">[</span><span class="n">lx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                                <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;IGK&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;IGL&#39;</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                                    <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                                <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                                <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;IGL&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;IGK&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                                    <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                                <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                            <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                        <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span> <span class="c1"># no/wrong annotations at all</span>

        <span class="n">poor_qual_</span><span class="p">,</span> <span class="n">h_doublet_</span><span class="p">,</span> <span class="n">l_doublet_</span><span class="p">,</span> <span class="n">drop_contig_</span> <span class="o">=</span> <span class="n">poor_qual</span><span class="p">,</span> <span class="n">h_doublet</span><span class="p">,</span> <span class="n">l_doublet</span><span class="p">,</span> <span class="n">drop_contig</span>
        <span class="k">return</span><span class="p">(</span><span class="n">poor_qual_</span><span class="p">,</span> <span class="n">h_doublet_</span><span class="p">,</span> <span class="n">l_doublet_</span><span class="p">,</span> <span class="n">drop_contig_</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">poor_qual</span><span class="p">,</span> <span class="n">h_doublet</span><span class="p">,</span> <span class="n">l_doublet</span><span class="p">,</span> <span class="n">drop_contig</span>  <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ncpu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ncpus</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ncpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ncpu</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scanning for poor quality/ambiguous contigs with </span><span class="si">{}</span><span class="s1"> cpus&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ncpus</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parallel_marking</span><span class="p">,</span> <span class="nb">iter</span><span class="p">(</span><span class="n">barcode</span><span class="p">))</span>

        <span class="n">pq</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="n">ld</span> <span class="p">,</span><span class="n">dc</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">pq</span> <span class="o">=</span> <span class="n">pq</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hd</span> <span class="o">=</span> <span class="n">hd</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="n">ld</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">poor_qual</span><span class="p">,</span> <span class="n">h_doublet</span><span class="p">,</span> <span class="n">l_doublet</span><span class="p">,</span> <span class="n">drop_contig</span> <span class="o">=</span> <span class="n">pq</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="n">dc</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">poor_qual</span><span class="p">,</span> <span class="n">h_doublet</span><span class="p">,</span> <span class="n">l_doublet</span><span class="p">,</span> <span class="n">drop_contig</span>  <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Scanning for poor quality/ambiguous contigs&#39;</span><span class="p">):</span>
            <span class="n">hc_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">])</span>
            <span class="n">hc_umi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;umi_count&#39;</span><span class="p">]]</span>
            <span class="n">hc_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;sequence_alignment&#39;</span><span class="p">]]</span>
            <span class="n">hc_dup</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;duplicate_count&#39;</span><span class="p">]]</span>
            <span class="n">hc_ccall</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;c_call&#39;</span><span class="p">]]</span>

            <span class="n">lc_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">]))][</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">])</span>
            <span class="n">lc_umi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">]))][</span><span class="s1">&#39;umi_count&#39;</span><span class="p">]]</span>
            <span class="n">lc_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">]))][</span><span class="s1">&#39;sequence_alignment&#39;</span><span class="p">]]</span>
            <span class="c1"># lc_ccall = [x for x in dat[(dat[&#39;cell_id&#39;].isin([b])) &amp; (dat[&#39;locus&#39;].isin([&#39;IGK&#39;, &#39;IGL&#39;]))][&#39;c_call&#39;]]</span>

            <span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_id</span>
            <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_umi</span>
            <span class="n">h_seq</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_seq</span>
            <span class="n">h_dup</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_dup</span>
            <span class="n">h_ccall</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_ccall</span>

            <span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_id</span>
            <span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_umi</span>
            <span class="n">l_seq</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_seq</span>
            <span class="c1"># l_ccall[b] = lc_ccall</span>
            <span class="c1"># l_dup[b] = lc_dup</span>

            <span class="c1"># marking doublets defined by heavy chains</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ccall</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">h_seq</span><span class="p">[</span><span class="n">b</span><span class="p">])))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">highest_umi_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">highest_umi_h_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">highest_umi_h</span><span class="p">]</span>
                    <span class="n">keep_index_h</span> <span class="o">=</span> <span class="n">highest_umi_h_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_h</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="o">+</span><span class="mi">1</span> <span class="p">:])</span>
                    <span class="n">keep_hc_contig</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="p">]</span>
                    <span class="n">dat</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keep_hc_contig</span><span class="p">,</span> <span class="s1">&#39;duplicate_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_h</span><span class="p">]</span> <span class="o">+</span> <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="o">+</span><span class="mi">1</span> <span class="p">:]))</span>

                    <span class="n">hc_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">])</span>
                    <span class="n">hc_umi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;umi_count&#39;</span><span class="p">]]</span>
                    <span class="n">hc_dup</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">)][</span><span class="s1">&#39;duplicate_count&#39;</span><span class="p">]]</span>
                    <span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_id</span>
                    <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_umi</span>
                    <span class="n">h_dup</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_dup</span>
                    <span class="n">h_seq</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_seq</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rescue_igh</span><span class="p">:</span>
                        <span class="n">highest_umi_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                        <span class="n">lowest_umi_h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                        <span class="n">highest_umi_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">highest_umi_h</span><span class="p">]</span>
                        <span class="n">keep_index_h</span> <span class="o">=</span> <span class="n">highest_umi_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="n">umi_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">highest_umi_h</span><span class="o">/</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">umi_foldchange_cutoff</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_h</span><span class="p">]</span> <span class="o">+</span> <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="o">+</span><span class="mi">1</span> <span class="p">:]]</span>
                        <span class="n">sum_umi</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">+</span><span class="n">h_dup</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">highest_umi_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">h_doublet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sum_umi</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">h_doublet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">umi_test</span><span class="p">):</span>
                            <span class="n">h_doublet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">highest_umi_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">other_umi_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">highest_umi_h</span><span class="p">]</span>
                            <span class="n">umi_test_</span> <span class="o">=</span> <span class="p">[</span><span class="n">highest_umi_h</span><span class="o">/</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">umi_foldchange_cutoff</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_h</span><span class="p">]</span> <span class="o">+</span> <span class="n">h_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="o">+</span><span class="mi">1</span> <span class="p">:]]</span>
                            <span class="n">umi_test_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">other_umi_idx</span><span class="p">,</span> <span class="n">umi_test_</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">otherindex</span> <span class="ow">in</span> <span class="n">umi_test_dict</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">umi_test_dict</span><span class="p">[</span><span class="n">otherindex</span><span class="p">]:</span>
                                    <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">otherindex</span><span class="p">])</span>
                                    <span class="n">ccall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_ccall</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">otherindex</span><span class="p">])</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccall</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># experimental: see if this can pick up any naive IgM+IgD+ cells?</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">call_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">h_ccall</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_h</span><span class="p">])</span><span class="o">+</span><span class="n">ccall</span>
                                    <span class="k">if</span> <span class="n">call_list</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;IGHM&#39;</span><span class="p">,</span> <span class="s1">&#39;IGHD&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">call_list</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;IGHD&#39;</span><span class="p">,</span> <span class="s1">&#39;IGHM&#39;</span><span class="p">]:</span>
                                        <span class="n">dat</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keep_hc_contig</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;IGHM|IGHD&#39;</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">h_doublet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">l_seq</span><span class="p">[</span><span class="n">b</span><span class="p">])))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">highest_umi_l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">highest_umi_l_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">highest_umi_l</span><span class="p">]</span>
                    <span class="n">keep_index_l</span> <span class="o">=</span> <span class="n">highest_umi_l_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_l</span><span class="p">]</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_l</span><span class="o">+</span><span class="mi">1</span> <span class="p">:])</span>
                    <span class="n">keep_lc_contig</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_l</span><span class="p">]</span>
                    <span class="n">dat</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keep_lc_contig</span><span class="p">,</span> <span class="s1">&#39;duplicate_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_l</span><span class="p">]</span> <span class="o">+</span> <span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_l</span><span class="o">+</span><span class="mi">1</span> <span class="p">:]))</span>
                    <span class="n">lc_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">]))][</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">])</span>
                    <span class="n">lc_umi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">b</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">]))][</span><span class="s1">&#39;umi_count&#39;</span><span class="p">]]</span>
                    <span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_id</span>
                    <span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_umi</span>
                    <span class="n">l_seq</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_seq</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">l_seq</span><span class="p">[</span><span class="n">b</span><span class="p">])))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># also apply the same cut off to multiple light chains</span>
                    <span class="n">highest_umi_l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">highest_umi_l_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">highest_umi_l</span><span class="p">]</span>
                    <span class="n">keep_index_l</span> <span class="o">=</span> <span class="n">highest_umi_l_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">other_umi_idx_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">highest_umi_l</span><span class="p">]</span>
                    <span class="n">umi_test_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">highest_umi_l</span><span class="o">/</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">umi_foldchange_cutoff</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][:</span><span class="n">keep_index_l</span><span class="p">]</span> <span class="o">+</span> <span class="n">l_umi</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">keep_index_l</span><span class="o">+</span><span class="mi">1</span> <span class="p">:]]</span>
                    <span class="n">umi_test_dict_l</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">other_umi_idx_l</span><span class="p">,</span> <span class="n">umi_test_l</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">otherindex</span> <span class="ow">in</span> <span class="n">umi_test_dict_l</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">umi_test_dict_l</span><span class="p">[</span><span class="n">otherindex</span><span class="p">]:</span>
                            <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">otherindex</span><span class="p">])</span>

            <span class="c1"># marking doublets defined by light chains</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">l_doublet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="c1"># marking poor bcr quality, defined as those with only light chains, those</span>
            <span class="c1"># that were have conflicting assignment of locus and heavy/light V/J calls,</span>
            <span class="c1"># and also those that are missing either v or j calls.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                    <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hc_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v_dict</span><span class="p">[</span><span class="n">hc_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j_dict</span><span class="p">[</span><span class="n">hc_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">c_dict</span><span class="p">[</span><span class="n">hc_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                            <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                            <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                            <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hc_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">hx</span> <span class="ow">in</span> <span class="n">hc_id</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v_dict</span><span class="p">[</span><span class="n">hx</span><span class="p">]</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">j_dict</span><span class="p">[</span><span class="n">hx</span><span class="p">]</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">c_dict</span><span class="p">[</span><span class="n">hx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                                <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                                <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                                <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">lx</span> <span class="ow">in</span> <span class="n">lc_id</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v_dict</span><span class="p">[</span><span class="n">lx</span><span class="p">]</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">j_dict</span><span class="p">[</span><span class="n">lx</span><span class="p">]</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">c_dict</span><span class="p">[</span><span class="n">lx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                            <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;IGK&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;IGL&#39;</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                                <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                            <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;IGL&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;IGK&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                                <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;IGH&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                                <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                            <span class="n">poor_qual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">drop_contig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span> <span class="c1"># no/wrong annotations at all</span>

    <span class="n">poorqual</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="n">hdoublet</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="n">ldoublet</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Annotating in anndata obs slot &#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">poor_qual</span><span class="p">:</span>
            <span class="n">poorqual</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">poorqual</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">h_doublet</span><span class="p">:</span>
            <span class="n">hdoublet</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdoublet</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">l_doublet</span><span class="p">:</span>
            <span class="n">ldoublet</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ldoublet</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr_quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">poorqual</span><span class="p">))</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr_quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr_quality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">hdoublet</span><span class="p">))</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr_heavy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr_light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">ldoublet</span><span class="p">))</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr_light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr_light&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

    <span class="n">drop_contig</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">drop_contig</span><span class="p">)))</span>

    <span class="n">filter_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">filter_bcr</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finishing up filtering&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_lightchains</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                <span class="n">filter_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">h_doublet</span> <span class="o">+</span> <span class="n">poor_qual</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filter_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">h_doublet</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_poorqualitybcr</span><span class="p">:</span>
                <span class="n">filter_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">h_doublet</span> <span class="o">+</span> <span class="n">l_doublet</span> <span class="o">+</span> <span class="n">poor_qual</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filter_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">h_doublet</span> <span class="o">+</span> <span class="n">l_doublet</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">filter_rna</span><span class="p">:</span>
            <span class="n">filter_ids</span> <span class="o">=</span> <span class="n">filter_ids</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_rna&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span>
            <span class="n">filter_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">filter_ids</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">filter_missing</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">:</span>
                    <span class="n">filter_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">_dat</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">filter_ids</span><span class="p">))]</span>
        <span class="n">_dat</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">_dat</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">drop_contig</span><span class="p">))]</span>
        <span class="k">if</span> <span class="n">_dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;No BCRs passed filtering. Are you sure that the cell barcodes are matching?&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">_dat</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_filtered.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">):</span>
                    <span class="n">_dat</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">save</span><span class="p">),</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Please provide a file name that ends with .tsv&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">barcode2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]))</span>
    <span class="n">bc_2</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">barcode2</span><span class="p">:</span>
        <span class="n">bc_2</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">b</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>
    <span class="n">bcr_check</span><span class="p">[</span><span class="s1">&#39;bcr_QC_pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bc_2</span><span class="p">)</span>
    <span class="n">bcr_check</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;bcr_QC_pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bcr_check</span><span class="p">[</span><span class="s1">&#39;bcr_QC_pass&#39;</span><span class="p">])</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;bcr_QC_pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;bcr_QC_pass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializing Dandelion object&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="n">out_dat</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">germline</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_dat</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">(</span><span class="s1">&#39;Dandelion metadata cannot be initialized due to duplicate barcodes. Recommending to run function with filter_bcr = True.&#39;</span><span class="p">))</span>
            <span class="n">out_dat</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">filter_ids</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filter_rna</span><span class="p">:</span>
        <span class="n">out_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter_bcr&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span> <span class="c1"># not saving the scanpy object because there&#39;s no need to at the moment</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
            <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Returning Dandelion and AnnData objects: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">out_dat</span><span class="p">,</span> <span class="n">out_adata</span><span class="p">)</span></div>

<div class="viewcode-block" id="quantify_mutations"><a class="viewcode-back" href="../../../modules/dandelion.preprocessing.quantify_mutations.html#dandelion.preprocessing.quantify_mutations">[docs]</a><span class="k">def</span> <span class="nf">quantify_mutations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_locus</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">region_definition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mutation_definition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs basic mutation load analysis implemented in `shazam &lt;https://shazam.readthedocs.io/en/stable/vignettes/Mutation-Vignette/&gt;`__.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion</span>
<span class="sd">        `Dandelion` object</span>
<span class="sd">    split_locus : bool</span>
<span class="sd">        whether to return the results for heavy chain and light chain separately. Default is False.</span>
<span class="sd">    region_definition : str, optional</span>
<span class="sd">        passed to shazam&#39;s `observedMutations &lt;https://shazam.readthedocs.io/en/stable/topics/observedMutations/&gt;`__.</span>
<span class="sd">    mutation_definition : str, optional</span>
<span class="sd">        passed to shazam&#39;s `observedMutations &lt;https://shazam.readthedocs.io/en/stable/topics/observedMutations/&gt;`__.</span>
<span class="sd">    frequency</span>
<span class="sd">        whether to return the results a frequency or counts. Default is True (frequency).</span>
<span class="sd">    combine</span>
<span class="sd">        whether to return the results for replacement and silent mutations separately (False). Default is True (sum).</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `Dandelion` object with updated `.metadata` slot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Quantifying mutations&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="kn">import</span> <span class="n">importr</span><span class="p">,</span> <span class="n">data</span>
        <span class="kn">from</span> <span class="nn">rpy2.rinterface</span> <span class="kn">import</span> <span class="n">NULL</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="kn">import</span> <span class="n">pandas2ri</span><span class="p">,</span> <span class="n">StrVector</span><span class="p">,</span> <span class="n">FloatVector</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span><span class="p">(</span><span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Unable to initialise R instance. Please run this separately through R with Shazam&#39;s tutorial.&quot;</span><span class="p">))</span>

    <span class="n">sh</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;shazam&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> object/file not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
    <span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">region_definition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reg_d</span> <span class="o">=</span> <span class="n">NULL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reg_d</span> <span class="o">=</span> <span class="n">data</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">region_definition</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mutation_definition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mut_d</span> <span class="o">=</span> <span class="n">NULL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mut_d</span> <span class="o">=</span> <span class="n">data</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">mutation_definition</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">split_locus</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="n">dat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dat_r</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2rpy</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">dat_r</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2rpy</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">observedMutations</span><span class="p">(</span><span class="n">dat_r</span><span class="p">,</span> <span class="n">sequenceColumn</span> <span class="o">=</span> <span class="s2">&quot;sequence_alignment&quot;</span><span class="p">,</span> <span class="n">germlineColumn</span> <span class="o">=</span> <span class="s2">&quot;germline_alignment_d_mask&quot;</span><span class="p">,</span> <span class="n">regionDefinition</span> <span class="o">=</span> <span class="n">reg_d</span><span class="p">,</span> <span class="n">mutationDefinition</span> <span class="o">=</span> <span class="n">mut_d</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">combine</span> <span class="o">=</span> <span class="n">combine</span><span class="p">)</span>
        <span class="c1"># pd_df = pandas2ri.rpy2py_dataframe(results)</span>
        <span class="n">pd_df</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dat_h</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">]</span>
        <span class="n">dat_l</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">])]</span>

        <span class="n">dat_h</span> <span class="o">=</span> <span class="n">dat_h</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dat_h</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="n">dat_h</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dat_h_r</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2rpy</span><span class="p">(</span><span class="n">dat_h</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">dat_h</span> <span class="o">=</span> <span class="n">dat_h</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">dat_h_r</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2rpy</span><span class="p">(</span><span class="n">dat_h</span><span class="p">)</span>

        <span class="n">dat_l</span> <span class="o">=</span> <span class="n">dat_l</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dat_l</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="n">dat_l</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dat_l_r</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2rpy</span><span class="p">(</span><span class="n">dat_l</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">dat_l</span> <span class="o">=</span> <span class="n">dat_l</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">dat_l_r</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2rpy</span><span class="p">(</span><span class="n">dat_l</span><span class="p">)</span>

        <span class="n">results_h</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">observedMutations</span><span class="p">(</span><span class="n">dat_h_r</span><span class="p">,</span> <span class="n">sequenceColumn</span> <span class="o">=</span> <span class="s2">&quot;sequence_alignment&quot;</span><span class="p">,</span> <span class="n">germlineColumn</span> <span class="o">=</span> <span class="s2">&quot;germline_alignment_d_mask&quot;</span><span class="p">,</span> <span class="n">regionDefinition</span> <span class="o">=</span> <span class="n">reg_d</span><span class="p">,</span> <span class="n">mutationDefinition</span> <span class="o">=</span> <span class="n">mut_d</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">combine</span> <span class="o">=</span> <span class="n">combine</span><span class="p">)</span>
        <span class="n">results_l</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">observedMutations</span><span class="p">(</span><span class="n">dat_l_r</span><span class="p">,</span> <span class="n">sequenceColumn</span> <span class="o">=</span> <span class="s2">&quot;sequence_alignment&quot;</span><span class="p">,</span> <span class="n">germlineColumn</span> <span class="o">=</span> <span class="s2">&quot;germline_alignment_d_mask&quot;</span><span class="p">,</span> <span class="n">regionDefinition</span> <span class="o">=</span> <span class="n">reg_d</span><span class="p">,</span> <span class="n">mutationDefinition</span> <span class="o">=</span> <span class="n">mut_d</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">combine</span> <span class="o">=</span> <span class="n">combine</span><span class="p">)</span>
        <span class="n">pd_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">results_h</span><span class="p">,</span> <span class="n">results_l</span><span class="p">])</span>

    <span class="n">pd_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">cols_to_return</span> <span class="o">=</span> <span class="n">pd_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="c1"># this doesn&#39;t actually catch overwritten columns</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols_to_return</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cols_to_return</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;mu_.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pd_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cols_to_return</span> <span class="o">=</span> <span class="n">cols_to_return</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols_to_return</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd_df</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="c1"># TODO: str will make it work for the back and forth conversion with rpy2. but maybe can use a better option?</span>
        <span class="k">if</span> <span class="n">split_locus</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">metadata_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">cols_to_return</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;locus&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">cols_to_return</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols_to_return</span><span class="p">:</span>
            <span class="n">metadata_</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">split_locus</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">metadata_</span> <span class="o">=</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cell_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_</span> <span class="o">=</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;locus&#39;</span><span class="p">,</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">])):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;locus&#39;</span><span class="p">),:]</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">droplevel</span><span class="p">()</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                <span class="n">metadatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">metadata_</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">left_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;outer&#39;</span><span class="p">),</span> <span class="n">metadatas</span><span class="p">)</span>

        <span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">metadata_</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
            <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Updated Dandelion object: </span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">data</span><span class="se">\&#39;</span><span class="s1">, contig-indexed clone table</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">metadata</span><span class="se">\&#39;</span><span class="s1">, cell-indexed clone table</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols_to_return</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd_df</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="c1"># TODO: str will make it work for the back and forth conversion with rpy2. but maybe can use a better option?</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Returning DataFrame</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">return</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;saving DataFrame at </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))))</span>
            <span class="n">dat</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="calculate_threshold"><a class="viewcode-back" href="../../../modules/dandelion.preprocessing.calculate_threshold.html#dandelion.preprocessing.calculate_threshold">[docs]</a><span class="k">def</span> <span class="nf">calculate_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manual_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cross</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specificity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ncpu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculating nearest neighbor distances for tuning clonal assignment with `shazam &lt;https://shazam.readthedocs.io/en/stable/vignettes/DistToNearest-Vignette/&gt;`__.</span>

<span class="sd">    Runs the following:</span>
<span class="sd">    </span>
<span class="sd">    distToNearest</span>
<span class="sd">        Get non-zero distance of every heavy chain (IGH) sequence (as defined by sequenceColumn) to its nearest sequence in a partition of heavy chains sharing the same V gene, J gene, and junction length (VJL), or in a partition of single cells with heavy chains sharing the same heavy chain VJL combination, or of single cells with heavy and light chains sharing the same heavy chain VJL and light chain VJL combinations.</span>
<span class="sd">    findThreshold</span>
<span class="sd">        automtically determines an optimal threshold for clonal assignment of Ig sequences using a vector of nearest neighbor distances. It provides two alternative methods using either a Gamma/Gaussian Mixture Model fit (threshold_method=&quot;gmm&quot;) or kernel density fit (threshold_method=&quot;density&quot;).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion, DataFrame, str</span>
<span class="sd">        `Dandelion` object, pandas `DataFrame` in changeo/airr format, or file path to changeo/airr file after clones have been determined.</span>
<span class="sd">    manual_threshold : float, optional</span>
<span class="sd">        value to manually plot in histogram.</span>
<span class="sd">    model : str, optional</span>
<span class="sd">        underlying SHM model, which must be one of c(&quot;ham&quot;, &quot;aa&quot;, &quot;hh_s1f&quot;, &quot;hh_s5f&quot;, &quot;mk_rs1nf&quot;, &quot;hs1f_compat&quot;, &quot;m1n_compat&quot;).</span>
<span class="sd">    normalize_method : str, optional</span>
<span class="sd">        method of normalization. The default is &quot;len&quot;, which divides the distance by the length of the sequence group. If &quot;none&quot; then no normalization if performed.</span>
<span class="sd">    threshold_method : str, optional</span>
<span class="sd">        string defining the method to use for determining the optimal threshold. One of &quot;gmm&quot; or &quot;density&quot;.</span>
<span class="sd">    edge : float, optional</span>
<span class="sd">        upper range as a fraction of the data density to rule initialization of Gaussian fit parameters. Default value is 0.9 (or 90). Applies only when threshold_method=&quot;density&quot;.</span>
<span class="sd">    cross : list, array, optional</span>
<span class="sd">        supplementary nearest neighbor distance vector output from distToNearest for initialization of the Gaussian fit parameters. Applies only when method=&quot;gmm&quot;.</span>
<span class="sd">    subsample : int, optional</span>
<span class="sd">        maximum number of distances to subsample to before threshold detection.</span>
<span class="sd">    threshold_model : str, optional</span>
<span class="sd">        allows the user to choose among four possible combinations of fitting curves: &quot;norm-norm&quot;, &quot;norm-gamma&quot;, &quot;gamma-norm&quot;, and &quot;gamma-gamma&quot;. Applies only when method=&quot;gmm&quot;.</span>
<span class="sd">    cutoff : str, optional</span>
<span class="sd">        method to use for threshold selection: the optimal threshold &quot;opt&quot;, the intersection point of the two fitted curves &quot;intersect&quot;, or a value defined by user for one of the sensitivity or specificity &quot;user&quot;. Applies only when method=&quot;gmm&quot;.</span>
<span class="sd">    sensitivity : float, optional</span>
<span class="sd">        sensitivity required. Applies only when method=&quot;gmm&quot; and cutoff=&quot;user&quot;.</span>
<span class="sd">    specificity : float, optional</span>
<span class="sd">        specificity required. Applies only when method=&quot;gmm&quot; and cutoff=&quot;user&quot;.</span>
<span class="sd">    ncpu : int, optional</span>
<span class="sd">        number of cpus for parallelization. Default is all available cpus.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        whether or not to return plot.</span>
<span class="sd">    plot_group : str, optional</span>
<span class="sd">        determines the fill color and facets.</span>
<span class="sd">    figsize : tuple[float, float]</span>
<span class="sd">        size of plot. Default is (4.5, 2.5).</span>
<span class="sd">    *args</span>
<span class="sd">        passed to shazam&#39;s `distToNearest &lt;https://shazam.readthedocs.io/en/stable/topics/distToNearest/&gt;`__.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plotnine plot showing histogram of length normalized ham model distance threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating threshold&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="kn">import</span> <span class="n">importr</span><span class="p">,</span> <span class="n">data</span>
        <span class="kn">from</span> <span class="nn">rpy2.rinterface</span> <span class="kn">import</span> <span class="n">NULL</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="kn">import</span> <span class="n">pandas2ri</span><span class="p">,</span> <span class="n">StrVector</span><span class="p">,</span> <span class="n">FloatVector</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span><span class="p">(</span><span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Unable to initialise R instance. Please run this separately through R with Shazam&#39;s tutorial.&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;shazam&#39;</span><span class="p">)</span>
    <span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">v_call</span> <span class="o">=</span> <span class="s1">&#39;v_call_genotyped&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v_call</span> <span class="o">=</span> <span class="s1">&#39;v_call&#39;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_</span> <span class="o">=</span> <span class="s1">&#39;ham&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_</span> <span class="o">=</span> <span class="n">model</span>
    <span class="k">if</span> <span class="n">normalize_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">norm_</span> <span class="o">=</span> <span class="s1">&#39;len&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm_</span> <span class="o">=</span> <span class="n">normalize_method</span>
    <span class="k">if</span> <span class="n">threshold_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threshold_method_</span> <span class="o">=</span> <span class="s2">&quot;density&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold_method_</span> <span class="o">=</span> <span class="n">threshold_method</span>
    <span class="k">if</span> <span class="n">subsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subsample_</span> <span class="o">=</span> <span class="n">NULL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subsample_</span> <span class="o">=</span> <span class="n">subsample</span>
    <span class="k">if</span> <span class="n">ncpu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncpu_</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ncpu_</span> <span class="o">=</span> <span class="n">ncpu</span>
    <span class="n">dat_h</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dat_h_r</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2rpy</span><span class="p">(</span><span class="n">dat_h</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">dat_h</span> <span class="o">=</span> <span class="n">dat_h</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">dat_h_r</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2rpy</span><span class="p">(</span><span class="n">dat_h</span><span class="p">)</span>
    <span class="n">dist_ham</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">distToNearest</span><span class="p">(</span><span class="n">dat_h_r</span><span class="p">,</span> <span class="n">vCallColumn</span><span class="o">=</span><span class="n">v_call</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">norm_</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">ncpu_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="c1"># Find threshold using density method</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dist_ham</span><span class="p">[</span><span class="s1">&#39;dist_nearest&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">threshold_method_</span> <span class="ow">is</span> <span class="s1">&#39;density&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">edge</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edge_</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edge_</span> <span class="o">=</span> <span class="n">edge</span>
        <span class="n">dist_threshold</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">findThreshold</span><span class="p">(</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dist</span><span class="p">)]),</span> <span class="n">method</span><span class="o">=</span><span class="n">threshold_method_</span><span class="p">,</span> <span class="n">subsample</span> <span class="o">=</span> <span class="n">subsample_</span><span class="p">,</span> <span class="n">edge</span> <span class="o">=</span> <span class="n">edge_</span><span class="p">)</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dist_threshold</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">threshold</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">(</span><span class="s2">&quot;Threshold method &#39;density&#39; did not return with any values. Switching to method = &#39;gmm&#39;.&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">threshold_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">threshold_model_</span> <span class="o">=</span> <span class="s2">&quot;gamma-gamma&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">threshold_model_</span> <span class="o">=</span> <span class="n">threshold_model</span>
            <span class="k">if</span> <span class="n">cross</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cross_</span> <span class="o">=</span> <span class="n">NULL</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cross_</span> <span class="o">=</span> <span class="n">cross</span>
            <span class="k">if</span> <span class="n">cutoff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cutoff_</span> <span class="o">=</span> <span class="s1">&#39;optimal&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cutoff_</span> <span class="o">=</span> <span class="n">cutoff</span>
            <span class="k">if</span> <span class="n">sensitivity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sen_</span> <span class="o">=</span> <span class="n">NULL</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sen_</span> <span class="o">=</span> <span class="n">sensitivity</span>
            <span class="k">if</span> <span class="n">specificity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spc_</span> <span class="o">=</span> <span class="n">NULL</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spc_</span> <span class="o">=</span> <span class="n">specificity</span>
            <span class="n">dist_threshold</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">findThreshold</span><span class="p">(</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dist</span><span class="p">)]),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;gmm&#39;</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">threshold_model_</span><span class="p">,</span> <span class="n">cross</span> <span class="o">=</span> <span class="n">cross_</span><span class="p">,</span> <span class="n">subsample</span> <span class="o">=</span> <span class="n">subsample_</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff_</span><span class="p">,</span> <span class="n">sen</span> <span class="o">=</span> <span class="n">sen_</span><span class="p">,</span> <span class="n">spc</span> <span class="o">=</span> <span class="n">spc_</span><span class="p">)</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dist_threshold</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">threshold_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">threshold_model_</span> <span class="o">=</span> <span class="s2">&quot;gamma-gamma&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">threshold_model_</span> <span class="o">=</span> <span class="n">threshold_model</span>
        <span class="k">if</span> <span class="n">cross</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cross_</span> <span class="o">=</span> <span class="n">NULL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cross_</span> <span class="o">=</span> <span class="n">cross</span>
        <span class="k">if</span> <span class="n">cutoff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cutoff_</span> <span class="o">=</span> <span class="s1">&#39;optimal&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cutoff_</span> <span class="o">=</span> <span class="n">cutoff</span>
        <span class="k">if</span> <span class="n">sensitivity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sen_</span> <span class="o">=</span> <span class="n">NULL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sen_</span> <span class="o">=</span> <span class="n">sensitivity</span>
        <span class="k">if</span> <span class="n">specificity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spc_</span> <span class="o">=</span> <span class="n">NULL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spc_</span> <span class="o">=</span> <span class="n">specificity</span>
        <span class="n">dist_threshold</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">findThreshold</span><span class="p">(</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dist</span><span class="p">)]),</span> <span class="n">method</span><span class="o">=</span><span class="n">threshold_method_</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">threshold_model_</span><span class="p">,</span> <span class="n">cross</span> <span class="o">=</span> <span class="n">cross_</span><span class="p">,</span> <span class="n">subsample</span> <span class="o">=</span> <span class="n">subsample_</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff_</span><span class="p">,</span> <span class="n">sen</span> <span class="o">=</span> <span class="n">sen_</span><span class="p">,</span> <span class="n">spc</span> <span class="o">=</span> <span class="n">spc_</span><span class="p">)</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dist_threshold</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">threshold</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">(</span><span class="s2">&quot;Automatic thresholding failed. Please visually inspect the resulting distribution fits and choose a threshold value manually.&quot;</span><span class="p">))</span>
    <span class="c1"># dist_ham = pandas2ri.rpy2py_dataframe(dist_ham)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">figure_size</span> <span class="o">=</span> <span class="n">figsize</span>
        <span class="k">if</span> <span class="n">plot_group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_group</span> <span class="o">=</span> <span class="s1">&#39;sample_id&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_group</span> <span class="o">=</span> <span class="n">plot_group</span>
        <span class="k">if</span> <span class="n">manual_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">manual_threshold</span>
        <span class="nb">print</span><span class="p">((</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dist_ham</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="s1">&#39;dist_nearest&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">plot_group</span><span class="p">)))</span>
             <span class="o">+</span> <span class="n">theme_bw</span><span class="p">()</span>
             <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="s2">&quot;Grouped Hamming distance&quot;</span><span class="p">)</span>
             <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
             <span class="o">+</span> <span class="n">geom_histogram</span><span class="p">(</span><span class="n">binwidth</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>
             <span class="o">+</span> <span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="n">tr</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
             <span class="o">+</span> <span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">tr</span><span class="o">+</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Threshold:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;Blue&#39;</span><span class="p">)</span>
             <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">plot_group</span><span class="p">),</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">)</span>
             <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_position</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Automatic Threshold : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> method = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">threshold_method</span><span class="p">)))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">tr</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
        <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Updated Dandelion object: </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">threshold</span><span class="se">\&#39;</span><span class="s1">, threshold value for tuning clonal assignment</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">tr</span>
        <span class="k">return</span><span class="p">(</span><span class="n">output</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, zktuong

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>