

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>dandelion.tools._diversity &mdash; dandelion  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/dandelion_logo.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/dandelion_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#required-database">Required database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#external-softwares">External softwares</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#basic-requirements">Basic requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#acknowledgements">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#citation">Citation</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/singularity_preprocessing.html">Dandelion preprocessing with Singularity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/gamma_delta.html">Dandelion for TCR gamma/delta reannotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1_dandelion_preprocessing-10x_data.html">Pre-processing (Re-annotation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/2_dandelion_filtering-10x_data.html">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1b_dandelion_noreannotation-10x_data.html">Reading 10X Cell Ranger output directly</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/3_dandelion_findingclones-10x_data.html">BCR clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1c_dandelion_scirpy.html">Interoperability with <code class="docutils literal notranslate"><span class="pre">scirpy</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/4_dandelion_visualization-10x_data.html">Visualizing BCR data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/5_dandelion_diversity_and_mutation-10x_data.html">Calculating diversity and mutation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/0_dandelion_primer.html"><em>Dandelion</em> class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/6_dandelion_running_from_R-10x_data.html">Running from R</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/7_dandelion_TCR_data_10x_data.html">Analyzing TCR data</a></li>
</ul>
<p class="caption"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Preprocessing: <cite>pp</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.preprocessing.external">Preprocessing (external): <cite>pp.external</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.tools">Tools: <cite>tl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.plotting">Plotting: <cite>pl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.utilities">Utilities: <cite>utl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.Dandelion">Dandelion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.logging">Logging</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dandelion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>dandelion.tools._diversity</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dandelion.tools._diversity</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># @Author: Kelvin</span>
<span class="c1"># @Date:   2020-08-13 21:08:53</span>
<span class="c1"># @Last Modified by:   Kelvin</span>
<span class="c1"># @Last Modified time: 2021-06-17 15:20:30</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">..utilities._utilities</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..utilities._core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..utilities._io</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..tools._network</span> <span class="kn">import</span> <span class="n">clone_centrality</span><span class="p">,</span> <span class="n">clone_degree</span><span class="p">,</span> <span class="n">generate_network</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">gammaln</span>
<span class="kn">from</span> <span class="nn">anndata</span> <span class="kn">import</span> <span class="n">AnnData</span>
<span class="kn">from</span> <span class="nn">skbio.diversity.alpha</span> <span class="kn">import</span> <span class="n">chao1</span><span class="p">,</span> <span class="n">gini_index</span><span class="p">,</span> <span class="n">shannon</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scanpy</span> <span class="kn">import</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">logg</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="nn">warnings</span>


<div class="viewcode-block" id="clone_rarefaction"><a class="viewcode-back" href="../../../modules/dandelion.tools.clone_rarefaction.html#dandelion.tools.clone_rarefaction">[docs]</a><span class="k">def</span> <span class="nf">clone_rarefaction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">],</span>
        <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">diversity_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AnnData</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns rarefaction predictions for cell numbers vs clone size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion, AnnData</span>
<span class="sd">        `Dandelion` or `AnnData` object.</span>
<span class="sd">    groupby : str</span>
<span class="sd">        Column name to split the calculation of clone numbers for a given number of cells for e.g. sample, patient etc.</span>
<span class="sd">    clone_key : str, optional</span>
<span class="sd">        Column name specifying the clone_id column in metadata/obs.</span>
<span class="sd">    diversity_key : str, optional</span>
<span class="sd">        key for &#39;diversity&#39; results in AnnData&#39;s `.uns`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dictionary containing rarefaction results or updated `.uns` slot if `AnnData` object is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Constructing rarefaction curve&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">clone_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clonekey</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clonekey</span> <span class="o">=</span> <span class="n">clone_key</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]))</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;contig_QC_pass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">])]</span>
    <span class="n">metadata</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">remove_unused_categories</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span>
        <span class="n">res</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">_metadata</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">res_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

    <span class="c1"># remove those with no counts</span>
    <span class="n">rowsum</span> <span class="o">=</span> <span class="n">res_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;removing due to zero counts:&#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="n">res_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]))</span>
    <span class="n">res_</span> <span class="o">=</span> <span class="n">res_</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">res_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>

    <span class="c1"># set up for calculating rarefaction</span>
    <span class="n">tot</span> <span class="o">=</span> <span class="n">res_</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">res_</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nr</span> <span class="o">=</span> <span class="n">res_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># append the results to a dictionary</span>
    <span class="n">rarecurve</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Calculating rarefaction curve &#39;</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tot</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">tot</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">tot</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">rarecurve</span><span class="p">[</span><span class="n">res_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">rarefun</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res_</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">]),</span> <span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">n</span>
        <span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">rarecurve</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rarecurve</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">res_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span>
        <span class="n">index</span><span class="o">=</span><span class="n">res_</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">diversity_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">diversitykey</span> <span class="o">=</span> <span class="s1">&#39;diversity&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diversitykey</span> <span class="o">=</span> <span class="n">diversity_key</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">diversitykey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">diversitykey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">diversitykey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;rarefaction_cells_x&#39;</span><span class="p">:</span> <span class="n">pred</span><span class="p">,</span>
            <span class="s1">&#39;rarefaction_clones_y&#39;</span><span class="p">:</span> <span class="n">y</span>
        <span class="p">}</span>
    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
              <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
              <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.uns` with rarefaction curves.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">({</span><span class="s1">&#39;rarefaction_cells_x&#39;</span><span class="p">:</span> <span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;rarefaction_clones_y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span></div>


<div class="viewcode-block" id="clone_diversity"><a class="viewcode-back" href="../../../modules/dandelion.tools.clone_diversity.html#dandelion.tools.clone_diversity">[docs]</a><span class="k">def</span> <span class="nf">clone_diversity</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">],</span>
    <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;chao1&#39;</span><span class="p">,</span> <span class="s1">&#39;shannon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gini&#39;</span><span class="p">,</span>
    <span class="n">metric</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;clone_vertexsize&#39;</span><span class="p">,</span> <span class="s1">&#39;clone_degree&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;clone_centrality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_obs_meta</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">diversity_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">downsample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_resample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">reconstruct_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">expanded_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_contracted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">key_added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">locus</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;ig&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute B cell clones diversity : Gini indices, Chao1 estimates, or Shannon entropy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion, AnnData</span>
<span class="sd">        `Dandelion` or `AnnData` object.</span>
<span class="sd">    groupby : str</span>
<span class="sd">        Column name to calculate the gini indices on, for e.g. sample, patient etc.</span>
<span class="sd">    method : str</span>
<span class="sd">        Method for diversity estimation. Either one of [&#39;gini&#39;, &#39;chao1&#39;, &#39;shannon&#39;].</span>
<span class="sd">    metric : str, optional</span>
<span class="sd">        Metric to use for calculating Gini indices of clones. Accepts one of [&#39;clone_vertexsize&#39;, &#39;clone_degree&#39;, &#39;clone_centrality&#39;]. `None` defaults to &#39;clone_vertexsize&#39;.</span>
<span class="sd">    clone_key : str, optional</span>
<span class="sd">        Column name specifying the clone_id column in metadata.</span>
<span class="sd">    update_obs_meta : bool</span>
<span class="sd">        If True, a `pandas` dataframe is returned. If False, function will try to populate the input object&#39;s metadata/obs slot.</span>
<span class="sd">    diversity_key : str, optional</span>
<span class="sd">        key for &#39;diversity&#39; results in `.uns`.</span>
<span class="sd">    downsample : int, optional</span>
<span class="sd">        number of cells to downsample to. If None, defaults to size of smallest group.</span>
<span class="sd">    resample : bool</span>
<span class="sd">        Whether or not to randomly sample cells without replacement to the minimum size of groups for the diversity calculation. Default is False.</span>
<span class="sd">    n_resample : int</span>
<span class="sd">        Number of times to perform resampling. Default is 50.</span>
<span class="sd">    normalize : bool</span>
<span class="sd">        Whether or not to return normalized Shannon Entropy according to https://math.stackexchange.com/a/945172. Default is True.</span>
<span class="sd">    reconstruct_network : bool</span>
<span class="sd">        Whether or not to reconstruct the network for Gini Index based measures. Default is True and will reconstruct for each group specified by groupby option.</span>
<span class="sd">    expanded_only : bool</span>
<span class="sd">        Whether or not to calculate gini indices using expanded clones only. Default is False i.e. use all cells/clones.</span>
<span class="sd">    use_contracted : bool</span>
<span class="sd">        Whether or not to perform the gini calculation after contraction of clone network. Only applies to calculation of clone size gini index. Default is False. This is to try and preserve the single-cell properties of the network.</span>
<span class="sd">    key_added : str, list, optional</span>
<span class="sd">        column names for output.</span>
<span class="sd">    locus : str</span>
<span class="sd">        Mode of data. Only used for method = &#39;gini&#39;, Accepts one of &#39;ig&#39;, &#39;tr-ab&#39; or &#39;tr-gd&#39;. None defaults to &#39;ig&#39;.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `pandas` dataframe, `Dandelion` object with updated `.metadata` slot or `AnnData` object with updated `.obs` slot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">downsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resample</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;gini&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">update_obs_meta</span><span class="p">:</span>
            <span class="n">diversity_gini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
                           <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                           <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                           <span class="n">update_obs_meta</span><span class="o">=</span><span class="n">update_obs_meta</span><span class="p">,</span>
                           <span class="n">diversity_key</span><span class="o">=</span><span class="n">diversity_key</span><span class="p">,</span>
                           <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
                           <span class="n">n_resample</span><span class="o">=</span><span class="n">n_resample</span><span class="p">,</span>
                           <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">,</span>
                           <span class="n">reconstruct_network</span><span class="o">=</span><span class="n">reconstruct_network</span><span class="p">,</span>
                           <span class="n">expanded_only</span><span class="o">=</span><span class="n">expanded_only</span><span class="p">,</span>
                           <span class="n">use_contracted</span><span class="o">=</span><span class="n">use_contracted</span><span class="p">,</span>
                           <span class="n">key_added</span><span class="o">=</span><span class="n">key_added</span><span class="p">,</span>
                           <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">diversity_gini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
                                   <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                                   <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                                   <span class="n">update_obs_meta</span><span class="o">=</span><span class="n">update_obs_meta</span><span class="p">,</span>
                                   <span class="n">diversity_key</span><span class="o">=</span><span class="n">diversity_key</span><span class="p">,</span>
                                   <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
                                   <span class="n">n_resample</span><span class="o">=</span><span class="n">n_resample</span><span class="p">,</span>
                                   <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">,</span>
                                   <span class="n">reconstruct_network</span><span class="o">=</span><span class="n">reconstruct_network</span><span class="p">,</span>
                                   <span class="n">expanded_only</span><span class="o">=</span><span class="n">expanded_only</span><span class="p">,</span>
                                   <span class="n">use_contracted</span><span class="o">=</span><span class="n">use_contracted</span><span class="p">,</span>
                                   <span class="n">key_added</span><span class="o">=</span><span class="n">key_added</span><span class="p">,</span>
                                   <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;chao1&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">update_obs_meta</span><span class="p">:</span>
            <span class="n">diversity_chao1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
                            <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                            <span class="n">update_obs_meta</span><span class="o">=</span><span class="n">update_obs_meta</span><span class="p">,</span>
                            <span class="n">diversity_key</span><span class="o">=</span><span class="n">diversity_key</span><span class="p">,</span>
                            <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
                            <span class="n">n_resample</span><span class="o">=</span><span class="n">n_resample</span><span class="p">,</span>
                            <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">,</span>
                            <span class="n">key_added</span><span class="o">=</span><span class="n">key_added</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">diversity_chao1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
                                    <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                                    <span class="n">update_obs_meta</span><span class="o">=</span><span class="n">update_obs_meta</span><span class="p">,</span>
                                    <span class="n">diversity_key</span><span class="o">=</span><span class="n">diversity_key</span><span class="p">,</span>
                                    <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
                                    <span class="n">n_resample</span><span class="o">=</span><span class="n">n_resample</span><span class="p">,</span>
                                    <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">,</span>
                                    <span class="n">key_added</span><span class="o">=</span><span class="n">key_added</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;shannon&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">update_obs_meta</span><span class="p">:</span>
            <span class="n">diversity_shannon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
                              <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                              <span class="n">update_obs_meta</span><span class="o">=</span><span class="n">update_obs_meta</span><span class="p">,</span>
                              <span class="n">diversity_key</span><span class="o">=</span><span class="n">diversity_key</span><span class="p">,</span>
                              <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
                              <span class="n">n_resample</span><span class="o">=</span><span class="n">n_resample</span><span class="p">,</span>
                              <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span>
                              <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">,</span>
                              <span class="n">key_added</span><span class="o">=</span><span class="n">key_added</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">diversity_shannon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                      <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
                                      <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                                      <span class="n">update_obs_meta</span><span class="o">=</span><span class="n">update_obs_meta</span><span class="p">,</span>
                                      <span class="n">diversity_key</span><span class="o">=</span><span class="n">diversity_key</span><span class="p">,</span>
                                      <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
                                      <span class="n">n_resample</span><span class="o">=</span><span class="n">n_resample</span><span class="p">,</span>
                                      <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span>
                                      <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">,</span>
                                      <span class="n">key_added</span><span class="o">=</span><span class="n">key_added</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">clone_networkstats</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Dandelion</span><span class="p">,</span>
                       <span class="n">expanded_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">network_clustersize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating vertex size of nodes after contraction&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expanded_only</span><span class="p">:</span>
                <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="ow">is</span> <span class="n">csr_matrix</span>
            <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_weighted_edges_from</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                    <span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s1">&#39;Graph not found. Plase run tl.generate_network.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remove_edges</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">vertexsizes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">clustersizes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">nodes_names</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">subg</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">),</span>
                                 <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Reducing graph &#39;</span><span class="p">):</span>
                    <span class="n">nodes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subg</span><span class="p">))</span>
                    <span class="c1"># just assign the value in a single cell, because this will be representative of the clone</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">nodes_names</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>  <span class="c1"># keep so i can reference later</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">G_</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">remove_edges</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                             <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G_</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                             <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remove_edges</span><span class="p">[</span><span class="n">tmp</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">G_</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">(</span><span class="n">remove_edges</span><span class="p">[</span><span class="n">tmp</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">connected</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G_</span><span class="p">):</span>
                                <span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connected</span><span class="p">))</span>
                            <span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">],</span>
                                                      <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">G_</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
                            <span class="p">]</span>
                        <span class="k">if</span> <span class="n">network_clustersize</span><span class="p">:</span>
                            <span class="n">clustersizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">clustersizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">clustersizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">subg</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
                    <span class="n">nodes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subg</span><span class="p">))</span>
                    <span class="c1"># just assign the value in a single cell, because this will be representative of the clone</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">nodes_names</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>  <span class="c1"># keep so i can reference later</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">G_</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">remove_edges</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                             <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G_</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                             <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remove_edges</span><span class="p">[</span><span class="n">tmp</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">G_</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">(</span><span class="n">remove_edges</span><span class="p">[</span><span class="n">tmp</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">connected</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G_</span><span class="p">):</span>
                                <span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connected</span><span class="p">))</span>
                            <span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">],</span>
                                                      <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">G_</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
                            <span class="p">]</span>
                        <span class="k">if</span> <span class="n">network_clustersize</span><span class="p">:</span>
                            <span class="n">clustersizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">clustersizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vertexsizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">clustersizes</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">nodes_names</span><span class="p">,</span> <span class="n">vertexsizes</span><span class="p">,</span> <span class="n">clustersizes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input object must be of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Dandelion</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">diversity_gini</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">],</span>
    <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">metric</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_obs_meta</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">diversity_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">n_resample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">downsample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reconstruct_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">expanded_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_contracted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">key_added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">locus</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;ig&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Dandelion</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute B cell clones Gini indices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion, AnnData</span>
<span class="sd">        `Dandelion` or `AnnData` object.</span>
<span class="sd">    groupby : str</span>
<span class="sd">        Column name to calculate the Gini indices on, for e.g. sample, patient etc.</span>
<span class="sd">    metric : str, optional</span>
<span class="sd">        Metric to use for calculating Gini indices of clones. Accepts &#39;clone_degree&#39; and &#39;clone_centrality&#39;. Defaults to &#39;clone_centrality&#39;.</span>
<span class="sd">    clone_key : str, optional</span>
<span class="sd">        Column name specifying the clone_id column in metadata.</span>
<span class="sd">    update_obs_meta : bool</span>
<span class="sd">        If True, a `pandas` dataframe is returned. If False, function will try to populate the input object&#39;s metadata/obs slot.</span>
<span class="sd">    diversity_key : str, optional</span>
<span class="sd">        Key for &#39;diversity&#39; results in `.uns`.</span>
<span class="sd">    resample : bool</span>
<span class="sd">        Whether or not to randomly sample cells without replacement to the minimum size of groups for the diversity calculation. Default is False. Resampling will automatically trigger reconstruction of network.</span>
<span class="sd">    n_resample : int</span>
<span class="sd">        Number of times to perform resampling. Default is 50.</span>
<span class="sd">    downsample : int, optional</span>
<span class="sd">        number of cells to downsample to. If None, defaults to size of smallest group.</span>
<span class="sd">    reconstruct_network : bool</span>
<span class="sd">        Whether or not to reconstruct the network for Gini Index based measures. Default is True and will reconstruct for each group specified by groupby option.</span>
<span class="sd">    expanded_only : bool</span>
<span class="sd">        Whether or not to calculate gini indices using expanded clones only. Default is False i.e. use all cells/clones.</span>
<span class="sd">    use_contracted : bool</span>
<span class="sd">        Whether or not to perform the gini calculation after contraction of clone network. Only applies to calculation of clone size gini index. Default is False. This is to try and preserve the single-cell properties of the network.</span>
<span class="sd">    key_added : str, list, optional</span>
<span class="sd">        column names for output.</span>
<span class="sd">    locus : str</span>
<span class="sd">        Mode of data. Accepts one of &#39;ig&#39;, &#39;tr-ab&#39; or &#39;tr-gd&#39;. None defaults to &#39;ig&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `pandas` dataframe or `Dandelion` object with updated `.metadata` slot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating Gini indices&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gini_indices</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Dandelion</span><span class="p">,</span>
        <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">n_resample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">downsample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reconstruct_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">expanded_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">contracted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">key_added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">locus</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;ig&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Only Dandelion class object accepted.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clone_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clonekey</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clonekey</span> <span class="o">=</span> <span class="n">clone_key</span>

        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">met</span> <span class="o">=</span> <span class="s1">&#39;clone_network&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">met</span> <span class="o">=</span> <span class="n">metric</span>

        <span class="c1"># split up the table by groupby</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">remove_unused_categories</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">downsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minsize</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minsize</span> <span class="o">=</span> <span class="n">downsample</span>
            <span class="k">if</span> <span class="n">minsize</span> <span class="o">&gt;</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;Downsampling size provided of </span><span class="si">{}</span><span class="s1"> was larger than the smallest group size. Defaulting to the smallest group size for downsampling.&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">downsample</span><span class="p">))</span>
                <span class="n">minsize</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">minsize</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The minimum cell numbers when grouped by </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2"> (group </span><span class="si">{}</span><span class="s2">). Exercise caution when interpreting diversity measures.&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">minsize</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()))</span>

        <span class="n">res1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_network&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Computing Gini indices for cluster and vertex size using network.&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reconstruct_network</span><span class="p">:</span>
                <span class="n">n_n</span><span class="p">,</span> <span class="n">v_s</span><span class="p">,</span> <span class="n">c_s</span> <span class="o">=</span> <span class="n">clone_networkstats</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">expanded_only</span><span class="o">=</span><span class="n">expanded_only</span><span class="p">,</span>
                    <span class="n">network_clustersize</span><span class="o">=</span><span class="n">contracted</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">g_c_v</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                <span class="n">g_c_v_res</span><span class="p">,</span> <span class="n">g_c_c_res</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">v_s</span><span class="p">:</span>
                    <span class="n">v_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v_s</span><span class="p">[</span><span class="n">vs</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">v_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_sizes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">v_sizes</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]):</span>
                        <span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">n_n</span><span class="p">:</span>
                        <span class="n">g_c_v_res</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cell</span><span class="p">:</span> <span class="n">g_c_v</span><span class="p">[</span><span class="n">n_n</span><span class="p">[</span><span class="n">cell</span><span class="p">]]})</span>
                <span class="n">c_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">c_s</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
                                    <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">c_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_sizes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">g_c_c</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">c_sizes</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g_c_c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c_c</span><span class="p">):</span>
                    <span class="n">g_c_c</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">n_n</span><span class="p">:</span>
                    <span class="n">g_c_c_res</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cell</span><span class="p">:</span> <span class="n">g_c_c</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;clone_network_vertex_size_gini&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">g_c_v_res</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;clone_network_cluster_size_gini&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">g_c_c_res</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_size&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing gini indices for clone size using metadata.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_centrality&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Computing gini indices for clone size using metadata and node closeness centrality using network.&quot;</span>
            <span class="p">)</span>
            <span class="n">clone_centrality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_degree&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Computing gini indices for clone size using metadata and node degree using network.&quot;</span>
            <span class="p">)</span>
            <span class="n">clone_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res2</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Downsampling each group specified in `</span><span class="si">{}</span><span class="s2">` to </span><span class="si">{}</span><span class="s2"> cells for calculating gini indices.&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">minsize</span><span class="p">))</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="c1"># clone size distribution</span>
            <span class="n">_dat</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_dat</span><span class="o">.</span><span class="n">index</span><span class="p">))]</span>
            <span class="n">ddl_dat</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">_dat</span><span class="p">,</span> <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
                <span class="n">sizelist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
                    <span class="n">graphlist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_resample</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
                        <span class="n">resampled</span> <span class="o">=</span> <span class="n">generate_network</span><span class="p">(</span><span class="n">ddl_dat</span><span class="p">,</span>
                                                     <span class="n">clone_key</span><span class="o">=</span><span class="n">clonekey</span><span class="p">,</span>
                                                     <span class="n">downsample</span><span class="o">=</span><span class="n">minsize</span><span class="p">,</span>
                                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_network&#39;</span><span class="p">:</span>
                            <span class="n">n_n</span><span class="p">,</span> <span class="n">v_s</span><span class="p">,</span> <span class="n">c_s</span> <span class="o">=</span> <span class="n">clone_networkstats</span><span class="p">(</span>
                                <span class="n">resampled</span><span class="p">,</span>
                                <span class="n">expanded_only</span><span class="o">=</span><span class="n">expanded_only</span><span class="p">,</span>
                                <span class="n">network_clustersize</span><span class="o">=</span><span class="n">contracted</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">g_c_v</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                            <span class="n">g_c_v_res</span><span class="p">,</span> <span class="n">g_c_c_res</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">v_s</span><span class="p">:</span>
                                <span class="n">v_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v_s</span><span class="p">[</span><span class="n">vs</span><span class="p">])</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">v_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_sizes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">v_sizes</span><span class="p">,</span>
                                                       <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]):</span>
                                    <span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">n_n</span><span class="p">:</span>
                                    <span class="n">g_c_v_res</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cell</span><span class="p">:</span> <span class="n">g_c_v</span><span class="p">[</span><span class="n">n_n</span><span class="p">[</span><span class="n">cell</span><span class="p">]]})</span>
                            <span class="n">c_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">c_s</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
                                       <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">c_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_sizes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">g_c_c</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">c_sizes</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">g_c_c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c_c</span><span class="p">):</span>
                                <span class="n">g_c_c</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">n_n</span><span class="p">:</span>
                                <span class="n">g_c_c_res</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cell</span><span class="p">:</span> <span class="n">g_c_c</span><span class="p">})</span>
                            <span class="n">resampled</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span>
                                <span class="s1">&#39;clone_network_vertex_size_gini&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                                    <span class="n">g_c_v_res</span><span class="p">)</span>
                            <span class="n">resampled</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span>
                                <span class="s1">&#39;clone_network_cluster_size_gini&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                                    <span class="n">g_c_c_res</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_centrality&#39;</span><span class="p">:</span>
                            <span class="n">clone_centrality</span><span class="p">(</span><span class="n">resampled</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_degree&#39;</span><span class="p">:</span>
                            <span class="n">clone_degree</span><span class="p">(</span><span class="n">resampled</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s1">&#39;Unknown metric for calculating network stats. Please specify one of `clone_centrality` or `clone_degree`.&#39;</span>
                            <span class="p">)</span>
                        <span class="c1"># clone size gini</span>
                        <span class="n">_dat</span> <span class="o">=</span> <span class="n">resampled</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">_tab</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s1">&#39;nan&#39;</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_network&#39;</span><span class="p">:</span>
                            <span class="n">sizelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dat</span><span class="p">[</span><span class="n">met</span> <span class="o">+</span>
                                                 <span class="s1">&#39;_cluster_size_gini&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                        <span class="k">elif</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_size&#39;</span><span class="p">:</span>
                            <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_tab</span><span class="p">)</span>
                            <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">clonesizecounts</span><span class="p">[</span>
                                <span class="n">clonesizecounts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># append a single zero for lorenz curve calculation</span>
                                <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">g_c</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">,</span>
                                                 <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                                <span class="c1"># probably not needed anymore but keep just in case</span>
                                <span class="k">if</span> <span class="n">g_c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c</span><span class="p">):</span>
                                    <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">sizelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g_c</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_tab</span><span class="p">)</span>
                            <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">clonesizecounts</span><span class="p">[</span>
                                <span class="n">clonesizecounts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># append a single zero for lorenz curve calculation</span>
                                <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">g_c</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">,</span>
                                                 <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                                <span class="c1"># probably not needed anymore but keep just in case</span>
                                <span class="k">if</span> <span class="n">g_c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c</span><span class="p">):</span>
                                    <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">sizelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g_c</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_network&#39;</span><span class="p">:</span>
                            <span class="n">graphlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dat</span><span class="p">[</span><span class="n">met</span> <span class="o">+</span>
                                                  <span class="s1">&#39;_vertex_size_gini&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># vertex closeness centrality or weighted degree distribution</span>
                            <span class="c1"># only calculate for expanded clones. If including non-expanded clones, the centrality is just zero which doesn&#39;t help.</span>
                            <span class="n">connectednodes</span> <span class="o">=</span> <span class="n">resampled</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">met</span><span class="p">][</span>
                                <span class="n">resampled</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">met</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                            <span class="n">graphcounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="n">connectednodes</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
                            <span class="c1"># graphcounts = np.append(graphcounts, 0) # if I add a  zero here, it will skew the results when the centrality measure is uniform.... so leave it out for now.</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphcounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">g_c</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">graphcounts</span><span class="p">,</span>
                                                 <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">g_c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c</span><span class="p">):</span>
                                    <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">graphlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g_c</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">g_c</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizelist</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizelist</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">res1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span> <span class="n">g_c</span><span class="p">})</span>
                <span class="k">if</span> <span class="s1">&#39;graphlist&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                    <span class="n">g_c</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">graphlist</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphlist</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">g_c</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">graphlist</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphlist</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">res2</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span> <span class="n">g_c</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_tab</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;nan&#39;</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">met</span> <span class="o">!=</span> <span class="s1">&#39;clone_network&#39;</span><span class="p">:</span>
                    <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_tab</span><span class="p">)</span>
                    <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">clonesizecounts</span><span class="p">[</span><span class="n">clonesizecounts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># append a single zero for lorenz curve calculation</span>
                        <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">g_c</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                        <span class="c1"># probably not needed anymore but keep just in case</span>
                        <span class="k">if</span> <span class="n">g_c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c</span><span class="p">):</span>
                            <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">res1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span> <span class="n">g_c</span><span class="p">})</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_network&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">reconstruct_network</span><span class="p">:</span>
                            <span class="n">generate_network</span><span class="p">(</span><span class="n">ddl_dat</span><span class="p">,</span>
                                             <span class="n">clone_key</span><span class="o">=</span><span class="n">clonekey</span><span class="p">,</span>
                                             <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                             <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>
                            <span class="n">n_n</span><span class="p">,</span> <span class="n">v_s</span><span class="p">,</span> <span class="n">c_s</span> <span class="o">=</span> <span class="n">clone_networkstats</span><span class="p">(</span>
                                <span class="n">ddl_dat</span><span class="p">,</span>
                                <span class="n">expanded_only</span><span class="o">=</span><span class="n">expanded_only</span><span class="p">,</span>
                                <span class="n">network_clustersize</span><span class="o">=</span><span class="n">contracted</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">g_c_v</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                            <span class="n">g_c_v_res</span><span class="p">,</span> <span class="n">g_c_c_res</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">v_s</span><span class="p">:</span>
                                <span class="n">v_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v_s</span><span class="p">[</span><span class="n">vs</span><span class="p">])</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">v_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_sizes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">v_sizes</span><span class="p">,</span>
                                                       <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]):</span>
                                    <span class="n">g_c_v</span><span class="p">[</span><span class="n">vs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">n_n</span><span class="p">:</span>
                                    <span class="n">g_c_v_res</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cell</span><span class="p">:</span> <span class="n">g_c_v</span><span class="p">[</span><span class="n">n_n</span><span class="p">[</span><span class="n">cell</span><span class="p">]]})</span>
                            <span class="n">c_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">c_s</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
                                       <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">c_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_sizes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">g_c_c</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">c_sizes</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">g_c_c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c_c</span><span class="p">):</span>
                                <span class="n">g_c_c</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">n_n</span><span class="p">:</span>
                                <span class="n">g_c_c_res</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cell</span><span class="p">:</span> <span class="n">g_c_c</span><span class="p">})</span>
                            <span class="c1"># ddl_dat.metadata[&#39;clone_network_vertex_size_gini&#39;] = pd.Series(g_c_v_res)</span>
                            <span class="c1"># ddl_dat.metadata[&#39;clone_network_cluster_size_gini&#39;] = pd.Series(g_c_c_res)</span>
                            <span class="n">res2</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">g_c_v_res</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()})</span>
                            <span class="n">res1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">g_c_c_res</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">res2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="n">_dat</span><span class="p">[</span><span class="n">met</span> <span class="o">+</span> <span class="s1">&#39;_vertex_size_gini&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()})</span>
                            <span class="n">res1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="n">_dat</span><span class="p">[</span><span class="n">met</span> <span class="o">+</span> <span class="s1">&#39;_cluster_size_gini&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># vertex closeness centrality or weighted degree distribution</span>
                        <span class="c1"># only calculate for expanded clones. If including non-expanded clones, the centrality is just zero which doesn&#39;t help.</span>
                        <span class="n">connectednodes</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">[</span><span class="n">met</span><span class="p">][</span><span class="n">_dat</span><span class="p">[</span><span class="n">met</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="n">graphcounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">connectednodes</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
                        <span class="c1"># graphcounts = np.append(graphcounts, 0) # if I add a  zero here, it will skew the results when the centrality measure is uniform.... so leave it out for now.</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphcounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">g_c</span> <span class="o">=</span> <span class="n">gini_index</span><span class="p">(</span><span class="n">graphcounts</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapezoids&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">g_c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g_c</span><span class="p">):</span>
                                <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">res2</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span> <span class="n">g_c</span><span class="p">})</span>

        <span class="k">if</span> <span class="s1">&#39;res2&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">key_added</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">met</span> <span class="o">==</span> <span class="s1">&#39;clone_network&#39;</span><span class="p">:</span>
                    <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">met</span> <span class="o">+</span> <span class="s1">&#39;_cluster_size_gini&#39;</span><span class="p">,</span> <span class="n">met</span> <span class="o">+</span> <span class="s1">&#39;_vertex_size_gini&#39;</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clone_size_gini&#39;</span><span class="p">,</span> <span class="n">met</span> <span class="o">+</span> <span class="s1">&#39;_gini&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">key_added</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">key_added</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_added</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_added</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                    <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">key_added</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Please provide </span><span class="si">{}</span><span class="s1"> key(s) for new column names.&#39;</span><span class="o">.</span>
                        <span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="n">res1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">key_added</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clone_size_gini&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">key_added</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">key_added</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_added</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_added</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                    <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">key_added</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Please provide </span><span class="si">{}</span><span class="s1"> key(s) for new column names.&#39;</span><span class="o">.</span>
                        <span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">res_df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transfer_gini_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Dandelion</span><span class="p">,</span> <span class="n">gini_results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                              <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">gini_results</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">groupby</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">:</span>
                        <span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">gini_results</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">gini_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
                       <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                       <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                       <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
                       <span class="n">n_resample</span><span class="o">=</span><span class="n">n_resample</span><span class="p">,</span>
                       <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">,</span>
                       <span class="n">reconstruct_network</span><span class="o">=</span><span class="n">reconstruct_network</span><span class="p">,</span>
                       <span class="n">expanded_only</span><span class="o">=</span><span class="n">expanded_only</span><span class="p">,</span>
                       <span class="n">contracted</span><span class="o">=</span><span class="n">use_contracted</span><span class="p">,</span>
                       <span class="n">key_added</span><span class="o">=</span><span class="n">key_added</span><span class="p">,</span>
                       <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">diversity_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">diversitykey</span> <span class="o">=</span> <span class="s1">&#39;diversity&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diversitykey</span> <span class="o">=</span> <span class="n">diversity_key</span>

    <span class="k">if</span> <span class="n">update_obs_meta</span><span class="p">:</span>
        <span class="n">res_</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">transfer_gini_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_</span><span class="p">,</span> <span class="n">groupby</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                      <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                      <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.metadata` with Gini indices.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res_</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">res_</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">diversity_chao1</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">],</span>
    <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_obs_meta</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">diversity_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">n_resample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">downsample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">key_added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span>
                     <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute B cell clones Chao1 estimates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion, AnnData</span>
<span class="sd">        `Dandelion` or `AnnData` object.</span>
<span class="sd">    groupby : str</span>
<span class="sd">        Column name to calculate the Chao1 estimates on, for e.g. sample, patient etc.</span>
<span class="sd">    clone_key : str, optional</span>
<span class="sd">        Column name specifying the clone_id column in metadata.</span>
<span class="sd">    update_obs_meta : bool</span>
<span class="sd">        If True, a `pandas` dataframe is returned. If False, function will try to populate the input object&#39;s metadata/obs slot.</span>
<span class="sd">    diversity_key : str, optional</span>
<span class="sd">        key for &#39;diversity&#39; results in `.uns`.</span>
<span class="sd">    resample : bool</span>
<span class="sd">        Whether or not to randomly sample cells without replacement to the minimum size of groups for the diversity calculation. Default is False.</span>
<span class="sd">    n_resample : int</span>
<span class="sd">        Number of times to perform resampling. Default is 50.</span>
<span class="sd">    downsample : int, optional</span>
<span class="sd">        number of cells to downsample to. If None, defaults to size of smallest group.</span>
<span class="sd">    key_added : str, list, optional</span>
<span class="sd">        column names for output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `pandas` dataframe, `Dandelion` object with updated `.metadata` slot or `AnnData` object with updated `.obs` slot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating Chao1 estimates&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">chao1_estimates</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">],</span>
                        <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">n_resample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                        <span class="n">downsample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">key_added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clone_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clonekey</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clonekey</span> <span class="o">=</span> <span class="n">clone_key</span>

        <span class="c1"># split up the table by groupby</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">remove_unused_categories</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">downsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minsize</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minsize</span> <span class="o">=</span> <span class="n">downsample</span>
            <span class="k">if</span> <span class="n">minsize</span> <span class="o">&gt;</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;Downsampling size provided of </span><span class="si">{}</span><span class="s1"> was larger than the smallest group size. Defaulting to the smallest group size for downsampling.&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">downsample</span><span class="p">))</span>
                <span class="n">minsize</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">minsize</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;The minimum cell numbers when grouped by </span><span class="si">{}</span><span class="s1"> is </span><span class="si">{}</span><span class="s1">. Exercise caution when interpreting diversity measures.&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">minsize</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Downsampling each group specified in `</span><span class="si">{}</span><span class="s2">` to </span><span class="si">{}</span><span class="s2"> cells for calculating Chao1 estimates.&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">minsize</span><span class="p">))</span>
        <span class="n">res1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="c1"># clone size distribution</span>
            <span class="n">_dat</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
                <span class="n">sizelist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">graphlist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_resample</span><span class="p">)):</span>
                    <span class="n">_dat</span> <span class="o">=</span> <span class="n">_dat</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">minsize</span><span class="p">)</span>
                    <span class="n">_tab</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;nan&#39;</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_tab</span><span class="p">)</span>
                    <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">clonesizecounts</span><span class="p">[</span><span class="n">clonesizecounts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">g_c</span> <span class="o">=</span> <span class="n">chao1</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">sizelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g_c</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">g_c</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizelist</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizelist</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">res1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span> <span class="n">g_c</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_tab</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;nan&#39;</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_tab</span><span class="p">)</span>
                <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">clonesizecounts</span><span class="p">[</span><span class="n">clonesizecounts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">g_c</span> <span class="o">=</span> <span class="n">chao1</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">res1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span> <span class="n">g_c</span><span class="p">})</span>

        <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="n">res1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">key_added</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clone_size_chao1&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key_added</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">key_added</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_added</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">res_df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transfer_chao1_estimates</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">],</span>
                                 <span class="n">chao1_results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chao1_results</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">groupby</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">:</span>
                        <span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">chao1_results</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">chao1_estimates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
                          <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                          <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
                          <span class="n">n_resample</span><span class="o">=</span><span class="n">n_resample</span><span class="p">,</span>
                          <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">diversity_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">diversitykey</span> <span class="o">=</span> <span class="s1">&#39;diversity&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diversitykey</span> <span class="o">=</span> <span class="n">diversity_key</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">diversitykey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">diversitykey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">diversitykey</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;chao1&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">update_obs_meta</span><span class="p">:</span>
        <span class="n">res_</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">transfer_chao1_estimates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_</span><span class="p">,</span> <span class="n">groupby</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                      <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                      <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.metadata` with Chao1 estimates.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.obs` and `.uns` with Chao1 estimates.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res_</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                      <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                      <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.uns` with Chao1 estimates.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">res_</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">diversity_shannon</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">],</span>
    <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_obs_meta</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">diversity_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">n_resample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">downsample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">key_added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span>
                     <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute B cell clones Shannon entropy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion, AnnData</span>
<span class="sd">        `Dandelion` or `AnnData` object.</span>
<span class="sd">    groupby : str</span>
<span class="sd">        Column name to calculate the Shannon entropy on, for e.g. sample, patient etc.</span>
<span class="sd">    clone_key : str, optional</span>
<span class="sd">        Column name specifying the clone_id column in metadata.</span>
<span class="sd">    update_obs_meta : bool</span>
<span class="sd">        If True, a `pandas` dataframe is returned. If False, function will try to populate the input object&#39;s metadata/obs slot.</span>
<span class="sd">    diversity_key : str, optional</span>
<span class="sd">        key for &#39;diversity&#39; results in `.uns`.</span>
<span class="sd">    resample : bool</span>
<span class="sd">        Whether or not to randomly sample cells without replacement to the minimum size of groups for the diversity calculation. Default is False.</span>
<span class="sd">    n_resample : int</span>
<span class="sd">        Number of times to perform resampling. Default is 50.</span>
<span class="sd">    normalize : bool</span>
<span class="sd">        Whether or not to return normalized Shannon Entropy according to https://math.stackexchange.com/a/945172. Default is True.</span>
<span class="sd">    downsample : int, optional</span>
<span class="sd">        number of cells to downsample to. If None, defaults to size of smallest group.</span>
<span class="sd">    key_added : str, list, optional</span>
<span class="sd">        column names for output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `pandas` dataframe, `Dandelion` object with updated `.metadata` slot or `AnnData` object with updated `.obs` slot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating Shannon entropy&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shannon_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">],</span>
                        <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">n_resample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">downsample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">key_added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clone_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clonekey</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clonekey</span> <span class="o">=</span> <span class="n">clone_key</span>

        <span class="c1"># split up the table by groupby</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">remove_unused_categories</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">downsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minsize</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minsize</span> <span class="o">=</span> <span class="n">downsample</span>
            <span class="k">if</span> <span class="n">minsize</span> <span class="o">&gt;</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;Downsampling size provided of </span><span class="si">{}</span><span class="s1"> was larger than the smallest group size. Defaulting to the smallest group size for downsampling.&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">downsample</span><span class="p">))</span>
                <span class="n">minsize</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">minsize</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;The minimum cell numbers when grouped by </span><span class="si">{}</span><span class="s1"> is </span><span class="si">{}</span><span class="s1">. Exercise caution when interpreting diversity measures.&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">minsize</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Downsampling each group specified in `</span><span class="si">{}</span><span class="s2">` to </span><span class="si">{}</span><span class="s2"> cells for calculating Shannon entropy.&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">minsize</span><span class="p">))</span>

        <span class="n">res1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="c1"># clone size distribution</span>
            <span class="n">_dat</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
                <span class="n">sizelist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">graphlist</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_resample</span><span class="p">)):</span>
                    <span class="n">_dat</span> <span class="o">=</span> <span class="n">_dat</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">minsize</span><span class="p">)</span>
                    <span class="n">_tab</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;nan&#39;</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_tab</span><span class="p">)</span>
                    <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">clonesizecounts</span><span class="p">[</span><span class="n">clonesizecounts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">clonesizecounts_freqs</span> <span class="o">=</span> <span class="n">clonesizecounts</span> <span class="o">/</span> \
                                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span>
                                <span class="n">g_c</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">clonesizecounts_freqs</span> <span class="o">*</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">clonesizecounts_freqs</span><span class="p">))</span> <span class="o">/</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts_freqs</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">g_c</span> <span class="o">=</span> <span class="n">shannon</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                            <span class="n">g_c</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">sizelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g_c</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">g_c</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizelist</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizelist</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">res1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span> <span class="n">g_c</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_tab</span> <span class="o">=</span> <span class="n">_dat</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;nan&#39;</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">in</span> <span class="n">_tab</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">_tab</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_tab</span><span class="p">)</span>
                <span class="n">clonesizecounts</span> <span class="o">=</span> <span class="n">clonesizecounts</span><span class="p">[</span><span class="n">clonesizecounts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">clonesizecounts_freqs</span> <span class="o">=</span> <span class="n">clonesizecounts</span> <span class="o">/</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span>
                            <span class="n">g_c</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">clonesizecounts_freqs</span> <span class="o">*</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">clonesizecounts_freqs</span><span class="p">))</span> <span class="o">/</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clonesizecounts_freqs</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g_c</span> <span class="o">=</span> <span class="n">shannon</span><span class="p">(</span><span class="n">clonesizecounts</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                        <span class="n">g_c</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g_c</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">res1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span> <span class="n">g_c</span><span class="p">})</span>

        <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="n">res1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">key_added</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clone_size_normalized_shannon&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clone_size_shannon&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key_added</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">key_added</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_added</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">res_df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transfer_shannon_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">],</span>
                                 <span class="n">shannon_results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">groupby</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">shannon_results</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">groupby</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">:</span>
                        <span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">shannon_results</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">shannon_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
                          <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                          <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
                          <span class="n">n_resample</span><span class="o">=</span><span class="n">n_resample</span><span class="p">,</span>
                          <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span>
                          <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">diversity_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">diversitykey</span> <span class="o">=</span> <span class="s1">&#39;diversity&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diversitykey</span> <span class="o">=</span> <span class="n">diversity_key</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">diversitykey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">diversitykey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">diversitykey</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;shannon&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">update_obs_meta</span><span class="p">:</span>
        <span class="n">res_</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">transfer_shannon_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_</span><span class="p">,</span> <span class="n">groupby</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                    <span class="n">deep</span><span class="o">=</span><span class="p">(</span>
                        <span class="s1">&#39;updated `.metadata` with normalized Shannon entropy.</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                          <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                          <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.metadata` with Shannon entropy.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                    <span class="n">deep</span><span class="o">=</span>
                    <span class="p">(</span><span class="s1">&#39;updated `.obs` and `.uns` with normalized Shannon entropy.</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                    <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.obs` and `.uns` with Shannon entropy.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res_</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                    <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.uns` with normalized Shannon entropy.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                          <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                          <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.uns` with Shannon entropy.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">res_</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chooseln</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    R&#39;s lchoose in python</span>
<span class="sd">    from https://stackoverflow.com/questions/21767690/python-log-n-choose-k</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">gammaln</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">gammaln</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">gammaln</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">rarefun</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Adapted from rarefun from vegan:</span>
<span class="sd">    https://github.com/vegandevs/vegan/blob/master/R/rarefy.R</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">ldiv</span> <span class="o">=</span> <span class="n">chooseln</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">J</span> <span class="o">-</span> <span class="n">y</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">sample</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">chooseln</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span> <span class="o">-</span> <span class="n">ldiv</span><span class="p">))</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, zktuong.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>