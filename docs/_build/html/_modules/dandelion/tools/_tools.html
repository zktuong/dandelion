

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>dandelion.tools._tools &mdash; dandelion  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/dandelion_logo.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/dandelion_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#required-database">Required database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#external-softwares">External softwares</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#basic-requirements">Basic requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#acknowledgements">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#citation">Citation</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/singularity_preprocessing.html">Dandelion preprocessing with Singularity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/gamma_delta.html">Dandelion for TCR gamma/delta reannotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1_dandelion_preprocessing-10x_data.html">Pre-processing (Re-annotation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/2_dandelion_filtering-10x_data.html">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1b_dandelion_noreannotation-10x_data.html">Reading 10X Cell Ranger output directly</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/3_dandelion_findingclones-10x_data.html">BCR clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1c_dandelion_scirpy.html">Interoperability with <code class="docutils literal notranslate"><span class="pre">scirpy</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/4_dandelion_visualization-10x_data.html">Visualizing BCR data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/5_dandelion_diversity_and_mutation-10x_data.html">Calculating diversity and mutation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/0_dandelion_primer.html"><em>Dandelion</em> class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/6_dandelion_running_from_R-10x_data.html">Running from R</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/7_dandelion_TCR_data_10x_data.html">Analyzing TCR data</a></li>
</ul>
<p class="caption"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Preprocessing: <cite>pp</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.preprocessing.external">Preprocessing (external): <cite>pp.external</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.tools">Tools: <cite>tl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.plotting">Plotting: <cite>pl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.utilities">Utilities: <cite>utl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.Dandelion">Dandelion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.logging">Logging</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dandelion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>dandelion.tools._tools</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dandelion.tools._tools</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># @Author: Kelvin</span>
<span class="c1"># @Date:   2020-05-13 23:22:18</span>
<span class="c1"># @Last Modified by:   Kelvin</span>
<span class="c1"># @Last Modified time: 2021-06-17 15:06:05</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">..utilities._utilities</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..utilities._core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..utilities._io</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">._network</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">pdist</span><span class="p">,</span> <span class="n">squareform</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">distance</span> <span class="kn">import</span> <span class="n">hamming</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scanpy</span> <span class="kn">import</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">logg</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">changeo.Gene</span> <span class="kn">import</span> <span class="n">getGene</span>
<span class="kn">from</span> <span class="nn">anndata</span> <span class="kn">import</span> <span class="n">AnnData</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span>


<div class="viewcode-block" id="find_clones"><a class="viewcode-back" href="../../../modules/dandelion.tools.find_clones.html#dandelion.tools.find_clones">[docs]</a><span class="k">def</span> <span class="nf">find_clones</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
                <span class="n">identity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.85</span><span class="p">,</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">locus</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;ig&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">by_alleles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">key_added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">recalculate_length</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">productive_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dandelion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find clones based on heavy chain and light chain CDR3 junction hamming distance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion, DataFrame, str</span>
<span class="sd">        `Dandelion` object, pandas `DataFrame` in changeo/airr format, or file path to changeo/airr file after clones have been determined.</span>
<span class="sd">    identity : float</span>
<span class="sd">        Junction similarity parameter. Default 0.85</span>
<span class="sd">    key : str, optional</span>
<span class="sd">        column name for performing clone clustering. None defaults to &#39;junction_aa&#39;.</span>
<span class="sd">    locus : str, optional</span>
<span class="sd">        Mode of data. Accepts one of &#39;ig&#39;, &#39;tr-ab&#39; or &#39;tr-gd&#39;. None defaults to &#39;ig&#39;.</span>
<span class="sd">    by_alleles : bool</span>
<span class="sd">        Whether or not to collapse alleles to genes. None defaults to False.</span>
<span class="sd">    key_added : str, optional</span>
<span class="sd">        If specified, this will be the column name for clones. None defaults to &#39;clone_id&#39;</span>
<span class="sd">    recalculate_length : bool</span>
<span class="sd">        Whether or not to re-calculate junction length, rather than rely on parsed assignment (which occasionally is wrong). Default is True</span>
<span class="sd">    productive_only : bool</span>
<span class="sd">        Whether or not to perform clone_clustering only on productive clones.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `Dandelion` object with clone_id annotated in `.data` slot and `.metadata` initialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding clonotypes&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="n">dat_</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dat_</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">productive_only</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">dat_</span><span class="p">[</span><span class="n">dat_</span><span class="p">[</span><span class="s1">&#39;productive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">dat_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">locus_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;IGH&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;TRB&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;TRG&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key_</span> <span class="o">=</span> <span class="s1">&#39;junction_aa&#39;</span>  <span class="c1"># default</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">key_</span> <span class="o">=</span> <span class="n">key</span>

    <span class="k">if</span> <span class="n">key_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;key </span><span class="si">{}</span><span class="s2"> not found in input table.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">locus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">locus_</span> <span class="o">=</span> <span class="s1">&#39;IGH&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">locus_</span> <span class="o">=</span> <span class="n">locus_dict</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>

    <span class="n">locus_log1_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IGH&#39;</span><span class="p">:</span> <span class="s1">&#39;IGH&#39;</span><span class="p">,</span> <span class="s1">&#39;TRB&#39;</span><span class="p">:</span> <span class="s1">&#39;TRB&#39;</span><span class="p">,</span> <span class="s1">&#39;TRD&#39;</span><span class="p">:</span> <span class="s1">&#39;TRD&#39;</span><span class="p">}</span>
    <span class="n">locus_log2_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IGH&#39;</span><span class="p">:</span> <span class="s1">&#39;IGL/IGL&#39;</span><span class="p">,</span> <span class="s1">&#39;TRB&#39;</span><span class="p">:</span> <span class="s1">&#39;TRA&#39;</span><span class="p">,</span> <span class="s1">&#39;TRD&#39;</span><span class="p">:</span> <span class="s1">&#39;TRG&#39;</span><span class="p">}</span>

    <span class="n">dat_light</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">locus_</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dat_heavy</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">locus_</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">dat_light</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="n">dat_light</span><span class="p">[</span><span class="o">~</span><span class="p">(</span>
            <span class="n">dat_light</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dat_heavy</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dump</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dump</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dat_heavy</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">locus_</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;mode.chained_assignment&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">key_added</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clone_key</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clone_key</span> <span class="o">=</span> <span class="n">key_added</span>

    <span class="c1"># retrieve the J genes and J genes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">by_alleles</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">dat_heavy</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">V</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dat_heavy</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">V</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dat_heavy</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">]]</span>
        <span class="n">J</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dat_heavy</span><span class="p">[</span><span class="s1">&#39;j_call&#39;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">dat_heavy</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">V</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dat_heavy</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">V</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dat_heavy</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">]]</span>
        <span class="n">J</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dat_heavy</span><span class="p">[</span><span class="s1">&#39;j_call&#39;</span><span class="p">]]</span>

    <span class="c1"># collapse the alleles to just genes</span>
    <span class="n">V</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">V</span><span class="p">]</span>
    <span class="n">J</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">J</span><span class="p">]</span>

    <span class="n">seq</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_heavy</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dat_heavy</span><span class="p">[</span><span class="n">key_</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">recalculate_length</span><span class="p">:</span>
        <span class="n">seq_length</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dat_heavy</span><span class="p">[</span><span class="n">key_</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">seq_length</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dat_heavy</span><span class="p">[</span><span class="n">key_</span> <span class="o">+</span> <span class="s1">&#39;_length&#39;</span><span class="p">]]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not found in </span><span class="si">{}</span><span class="s2"> input table.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">key_</span> <span class="o">+</span> <span class="s1">&#39;_length&#39;</span><span class="p">,</span> <span class="n">locus_log1_dict</span><span class="p">[</span><span class="n">locus_</span><span class="p">]))</span>
    <span class="n">seq_length_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_heavy</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">seq_length</span><span class="p">))</span>

    <span class="c1"># Create a dictionary and group sequence ids with same V and J genes</span>
    <span class="n">V_J</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_heavy</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">J</span><span class="p">)))</span>
    <span class="n">vj_grp</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">V_J</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">vj_grp</span><span class="p">[</span><span class="n">val</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c1"># and now we split the groups based on lengths of the seqs</span>
    <span class="n">vj_len_grp</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="n">seq_grp</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">vj_grp</span><span class="p">:</span>
        <span class="c1"># first, obtain what&#39;s the unique lengths</span>
        <span class="n">jlen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">contig_id</span> <span class="ow">in</span> <span class="n">vj_grp</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
            <span class="n">jlen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_length_dict</span><span class="p">[</span><span class="n">contig_id</span><span class="p">])</span>
        <span class="n">setjlen</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">jlen</span><span class="p">))</span>
        <span class="c1"># then for each unique length, we add the contigs to a new tree if it matches the length</span>
        <span class="c1"># and also the actual seq sequences into a another one</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setjlen</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">contig_id</span> <span class="ow">in</span> <span class="n">vj_grp</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
                <span class="n">jlen_</span> <span class="o">=</span> <span class="n">seq_length_dict</span><span class="p">[</span><span class="n">contig_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">jlen_</span> <span class="o">==</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">vj_len_grp</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">contig_id</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">seq_grp</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">seq</span><span class="p">[</span><span class="n">contig_id</span><span class="p">]]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">contig_id</span><span class="p">]:</span>
                        <span class="n">vj_len_grp</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="n">clones</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="c1"># for each seq group, calculate the hamming distance matrix</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">seq_grp</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Finding clones based on VDJ chains &#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">seq_grp</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
            <span class="n">seq_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">seq_grp</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">])</span>
            <span class="n">tdarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seq_</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">d_mat</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="n">tdarray</span><span class="p">,</span>
                                     <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">hamming</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="c1"># then calculate what the acceptable threshold is for each length of sequence</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">identity</span><span class="p">))</span>
            <span class="c1"># convert diagonal and upper triangle to zeroes</span>
            <span class="n">d_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">d_mat</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">d_mat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># get the coordinates/indices of seqs to match against the threshold later</span>
            <span class="n">indices_temp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">indices_temp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices_from</span><span class="p">(</span><span class="n">d_mat</span><span class="p">)]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indices_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="c1"># if there&#39;s more than 1 contig, remove the diagonal</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                    <span class="c1"># remove diagonals</span>
                    <span class="k">if</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">indices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
            <span class="n">indices_j</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># use the coordinates/indices to retrieve the seq sequences</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="n">indices_j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">a1</span><span class="p">])</span>
                <span class="n">indices_j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">b1</span><span class="p">])</span>
            <span class="c1"># retain only the unique sequences</span>
            <span class="n">indices_j_f</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">indices_j</span><span class="p">))</span>
            <span class="c1"># convert the distance matrix to coordinate (source) and distance (target) and create it as a dictionary</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">d_mat</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
            <span class="n">source_target</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">target</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">source_target</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">source_target</span><span class="p">:</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">st</span><span class="p">:</span> <span class="n">d_mat</span><span class="p">[</span><span class="n">st</span><span class="p">]})</span>

            <span class="n">cm1</span><span class="p">,</span> <span class="n">cm2</span><span class="p">,</span> <span class="n">cm3</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="c1"># now to calculate which contigs to group</span>
            <span class="n">tr2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">tr2</span> <span class="o">&lt;=</span> <span class="n">tr</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">:</span>
                    <span class="c1"># if the distance is equal to the minimum distance, which is lesser than or equal to the threshold. I will add the sequence to cm1, meaning they passed and should be a clone.</span>
                    <span class="k">if</span> <span class="n">dist</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">==</span> <span class="n">tr2</span><span class="p">:</span>
                        <span class="n">cm1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># otherwise add into cm3, which later on will get split into individual clones, despite being part of the acceptable threshold for this group of sequences</span>
                        <span class="n">cm3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if the value is greater than the the minimum threshold, I will add the entire group into cm3, so they shouldn&#39;t be grouped together as a clone</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">:</span>
                    <span class="n">cm3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="c1"># This is based on a simple scenario e.g. in 3x3 distance matrix where the acceptable distance threshold is 2.</span>
            <span class="c1"># SeqA is 1 sequence different from SeqB</span>
            <span class="c1"># SeqB is 2 sequences different from SeqC</span>
            <span class="c1"># SeqC can only be 2 sequences different from SeqA otherwise it will violate the pair-wise distance matrix calculation</span>
            <span class="c1"># Because the distance between SeqA and SeqB is below the threshold, and is essentially the smallest value, they will be grouped in cm1</span>
            <span class="c1"># While SeqC is below the acceptable threshold, really it&#39;s more different than SeqA and SeqB. Therefore, they will be grouped separately.</span>
            <span class="c1"># If there&#39;s more than 3 sequences in a particular distance matrix, it gets slightly complicated.</span>
            <span class="c1"># so i repeat the calculation to only catch those with more than 3 sequences</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">:</span>
                    <span class="c1"># This time, i will rely on the main threshold value; if the distance is lesser than the overall threshold, i will add it to cm2.</span>
                    <span class="k">if</span> <span class="n">dist</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tr</span><span class="p">:</span>
                        <span class="n">cm2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cm3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="c1"># any sequences that were already binned above in cm1, it will be removed from here.</span>
                <span class="n">cm2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cm2</span><span class="p">)</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">cm1</span><span class="p">))</span>
                <span class="n">cm3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cm3</span><span class="p">)</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">cm1</span><span class="p">))</span>

            <span class="c1"># now to actually retrieve the seq/contigs properly through a series of appending and removing</span>
            <span class="n">j_list1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm1</span><span class="p">)):</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">cm1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">j_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                    <span class="n">j_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="n">j_list1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">j_list1</span><span class="p">))</span>

            <span class="n">j_list2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm2</span><span class="p">)):</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">cm2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">j_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                    <span class="n">j_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="n">j_list2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">j_list2</span><span class="p">))</span>

            <span class="n">j_list3</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm3</span><span class="p">)):</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">cm3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">j_list3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                    <span class="n">j_list3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="n">j_list3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">j_list3</span><span class="p">))</span>

            <span class="c1"># this is to catch the overlapping seqs appearing in the lists because of the sequential appending</span>
            <span class="k">for</span> <span class="n">jl3_1</span> <span class="ow">in</span> <span class="n">j_list1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jl3_1</span> <span class="ow">in</span> <span class="n">j_list3</span><span class="p">:</span>
                    <span class="n">j_list3</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jl3_1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jl2_1</span> <span class="ow">in</span> <span class="n">j_list1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jl2_1</span> <span class="ow">in</span> <span class="n">j_list2</span><span class="p">:</span>
                    <span class="n">j_list2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jl2_1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jl3_2</span> <span class="ow">in</span> <span class="n">j_list2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jl3_2</span> <span class="ow">in</span> <span class="n">j_list3</span><span class="p">:</span>
                    <span class="n">j_list3</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jl3_2</span><span class="p">)</span>

            <span class="n">j_list3</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">j_list3</span><span class="p">))]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j_list1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">clones</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">j_list1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j_list2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">clones</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">j_list2</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j_list3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">j_list3</span><span class="p">)):</span>
                    <span class="c1"># the +2 here is so that the numbers come up after 1. It doesn&#39;t matter because i will reformat the clone ID numbers later</span>
                    <span class="n">clones</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">j_list3</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

    <span class="n">clone_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># now to retrieve the contig ids that are grouped together</span>
    <span class="n">cid</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">clones</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">clones</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
            <span class="c1"># retrieve the clone &#39;numbers&#39;</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clones</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">]:</span>
                <span class="n">grp_seq</span> <span class="o">=</span> <span class="n">clones</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">vj_len_grp</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">grp_seq</span><span class="p">:</span>
                        <span class="n">cid</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># rename clone ids - get dictionaries step by step</span>
    <span class="n">first_key</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">cid</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">first_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
    <span class="n">first_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">first_key</span><span class="p">))</span>
    <span class="n">first_key_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">first_key</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="c1"># and now for the middle key</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">cid</span><span class="p">:</span>
        <span class="n">second_key</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="n">cid</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">second_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
        <span class="n">second_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">second_key</span><span class="p">))</span>
        <span class="n">second_key_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">second_key</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">second_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cid</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
            <span class="c1"># and now for the last key</span>
            <span class="n">third_key</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k3</span> <span class="ow">in</span> <span class="n">cid</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">third_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span>
            <span class="n">third_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">third_key</span><span class="p">))</span>
            <span class="n">third_key_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">third_key</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">third_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cid</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">])</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">vL</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="c1"># instead of converting to another tree, i will just make it a dictionary</span>
                    <span class="n">clone_dict</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">first_key_dict</span><span class="p">[</span><span class="n">g</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="n">second_key_dict</span><span class="p">[</span><span class="n">l</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">third_key_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="c1"># add it to the original dataframes</span>
    <span class="n">dat_heavy</span><span class="p">[</span><span class="n">clone_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">clone_dict</span><span class="p">)</span>
    <span class="n">dat</span><span class="p">[</span><span class="n">clone_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dat_heavy</span><span class="p">[</span><span class="n">clone_key</span><span class="p">])</span>

    <span class="n">dat_light_c</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">locus_</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dat_light_c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">by_alleles</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">dat_light_c</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">Vlight</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dat_light_c</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Vlight</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dat_light_c</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="n">Jlight</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dat_light_c</span><span class="p">[</span><span class="s1">&#39;j_call&#39;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">dat_light_c</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">Vlight</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dat_light_c</span><span class="p">[</span><span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Vlight</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dat_light_c</span><span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">]]</span>
            <span class="n">Jlight</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dat_light_c</span><span class="p">[</span><span class="s1">&#39;j_call&#39;</span><span class="p">]]</span>
        <span class="c1"># collapse the alleles to just genes</span>
        <span class="n">Vlight</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Vlight</span><span class="p">]</span>
        <span class="n">Jlight</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">Jlight</span><span class="p">]</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_light_c</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dat_light_c</span><span class="p">[</span><span class="n">key_</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">recalculate_length</span><span class="p">:</span>
            <span class="n">seq_length</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dat_light_c</span><span class="p">[</span><span class="n">key_</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">seq_length</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dat_light_c</span><span class="p">[</span><span class="n">key_</span> <span class="o">+</span> <span class="s1">&#39;_length&#39;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not found in </span><span class="si">{}</span><span class="s2"> input table.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key_</span> <span class="o">+</span> <span class="s1">&#39;_length&#39;</span><span class="p">,</span> <span class="n">locus_log2_dict</span><span class="p">[</span><span class="n">locus_</span><span class="p">]))</span>
        <span class="n">seq_length_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_light_c</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">seq_length</span><span class="p">))</span>
        <span class="c1"># Create a dictionary and group sequence ids with same V and J genes</span>
        <span class="n">V_Jlight</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_light_c</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Vlight</span><span class="p">,</span> <span class="n">Jlight</span><span class="p">)))</span>
        <span class="n">vj_lightgrp</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">V_Jlight</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">vj_lightgrp</span><span class="p">[</span><span class="n">val</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="c1"># and now we split the groups based on lengths of the seqs</span>
        <span class="n">vj_len_lightgrp</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="n">seq_lightgrp</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">vj_lightgrp</span><span class="p">:</span>
            <span class="c1"># first, obtain what&#39;s the unique lengths</span>
            <span class="n">jlen</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">contig_id</span> <span class="ow">in</span> <span class="n">vj_lightgrp</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
                <span class="n">jlen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_length_dict</span><span class="p">[</span><span class="n">contig_id</span><span class="p">])</span>
            <span class="n">setjlen</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">jlen</span><span class="p">))</span>
            <span class="c1"># then for each unique length, we add the contigs to a new tree if it matches the length</span>
            <span class="c1"># and also the actual seq sequences into a another one</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setjlen</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">contig_id</span> <span class="ow">in</span> <span class="n">vj_lightgrp</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
                    <span class="n">jlen_</span> <span class="o">=</span> <span class="n">seq_length_dict</span><span class="p">[</span><span class="n">contig_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">jlen_</span> <span class="o">==</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">vj_len_lightgrp</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">contig_id</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">seq_lightgrp</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">seq</span><span class="p">[</span><span class="n">contig_id</span><span class="p">]]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">contig_id</span><span class="p">]:</span>
                            <span class="n">vj_len_lightgrp</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">clones_light</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">seq_lightgrp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">seq_lightgrp</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
                <span class="n">seq_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">seq_lightgrp</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">])</span>
                <span class="n">tdarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seq_</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">d_mat</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span>
                    <span class="n">pdist</span><span class="p">(</span><span class="n">tdarray</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">hamming</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">identity</span><span class="p">))</span>
                <span class="n">d_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">d_mat</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">d_mat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">indices_temp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">indices_temp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices_from</span><span class="p">(</span><span class="n">d_mat</span><span class="p">)]</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indices_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">indices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
                <span class="n">indices_j</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
                    <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="n">indices_j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">a1</span><span class="p">])</span>
                    <span class="n">indices_j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">b1</span><span class="p">])</span>
                <span class="n">indices_j_f</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">indices_j</span><span class="p">))</span>
                <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">d_mat</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
                <span class="n">source_target</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">target</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">source_target</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">source_target</span><span class="p">:</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">st</span><span class="p">:</span> <span class="n">d_mat</span><span class="p">[</span><span class="n">st</span><span class="p">]})</span>
                <span class="n">cm1</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">cm2</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">cm3</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tr2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">tr2</span> <span class="o">&lt;=</span> <span class="n">tr</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dist</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">==</span> <span class="n">tr2</span><span class="p">:</span>
                            <span class="n">cm1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cm3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">:</span>
                        <span class="n">cm3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dist</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tr</span><span class="p">:</span>
                            <span class="n">cm2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cm3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">cm2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cm2</span><span class="p">)</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">cm1</span><span class="p">))</span>
                    <span class="n">cm3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cm3</span><span class="p">)</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">cm1</span><span class="p">))</span>
                <span class="n">j_list1</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm1</span><span class="p">)):</span>
                        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">cm1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">j_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                        <span class="n">j_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">j_list1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">j_list1</span><span class="p">))</span>
                <span class="n">j_list2</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm2</span><span class="p">)):</span>
                        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">cm2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">j_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                        <span class="n">j_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">j_list2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">j_list2</span><span class="p">))</span>
                <span class="n">j_list3</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm3</span><span class="p">)):</span>
                        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">cm3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">j_list3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                        <span class="n">j_list3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">j_list3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">j_list3</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">jl3_1</span> <span class="ow">in</span> <span class="n">j_list1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jl3_1</span> <span class="ow">in</span> <span class="n">j_list3</span><span class="p">:</span>
                        <span class="n">j_list3</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jl3_1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">jl2_1</span> <span class="ow">in</span> <span class="n">j_list1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jl2_1</span> <span class="ow">in</span> <span class="n">j_list2</span><span class="p">:</span>
                        <span class="n">j_list2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jl2_1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">jl3_2</span> <span class="ow">in</span> <span class="n">j_list2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jl3_2</span> <span class="ow">in</span> <span class="n">j_list3</span><span class="p">:</span>
                        <span class="n">j_list3</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jl3_2</span><span class="p">)</span>
                <span class="n">j_list3</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">j_list3</span><span class="p">))]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j_list1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">clones_light</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">j_list1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j_list2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">clones_light</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">j_list2</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j_list3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">j_list3</span><span class="p">)):</span>
                        <span class="n">clones_light</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">j_list3</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">clone_dict_light</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cid_light</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">clones_light</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">clones_light</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clones_light</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">]:</span>
                    <span class="n">grp_seq</span> <span class="o">=</span> <span class="n">clones_light</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">vj_len_lightgrp</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">grp_seq</span><span class="p">:</span>
                            <span class="n">cid_light</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">first_key</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">cid_light</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">first_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
        <span class="n">first_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">first_key</span><span class="p">))</span>
        <span class="n">first_key_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">first_key</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">cid_light</span><span class="p">:</span>
            <span class="n">second_key</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="n">cid_light</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">second_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
            <span class="n">second_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">second_key</span><span class="p">))</span>
            <span class="n">second_key_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">second_key</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="nb">len</span><span class="p">(</span><span class="n">second_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cid_light</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
                <span class="n">third_key</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">k3</span> <span class="ow">in</span> <span class="n">cid_light</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">third_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span>
                <span class="n">third_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">third_key</span><span class="p">))</span>
                <span class="n">third_key_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">third_key</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="nb">len</span><span class="p">(</span><span class="n">third_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cid_light</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">l</span><span class="p">])</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">vL</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">clone_dict_light</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="n">first_key_dict</span><span class="p">[</span><span class="n">g</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                <span class="n">second_key_dict</span><span class="p">[</span><span class="n">l</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                    <span class="n">third_key_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">lclones</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">clone_dict_light</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># will just update the main dat directly</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lclones</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lclones_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lclones</span><span class="p">))),</span>
                    <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lclones</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lclones_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lclones</span><span class="p">))),</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">renamed_clone_dict_light</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clone_dict_light</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">renamed_clone_dict_light</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">lclones_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="n">cellclonetree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="n">seqcellclonetree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="n">clone_key</span><span class="p">]):</span>
            <span class="n">seqcellclonetree</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                <span class="n">cellclonetree</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cellclonetree</span><span class="p">:</span>
            <span class="n">cellclonetree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cellclonetree</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

        <span class="n">fintree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">cellclonetree</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Refining clone assignment based on VJ chain pairing &#39;</span><span class="p">):</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">renamed_clone_dict_light</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seqcellclonetree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">renamed_clone_dict_light</span>
            <span class="p">]</span>
            <span class="n">fintree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suffix</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">cellclonetree</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
                        <span class="n">fintree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
                <span class="n">fintree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fintree</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">cellclonetree</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">fintree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suffix</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fintree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
            <span class="n">fintree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fintree</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
        <span class="n">dat</span><span class="p">[</span><span class="n">clone_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fintree</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]]</span>

    <span class="n">dat_</span><span class="p">[</span><span class="n">clone_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">clone_key</span><span class="p">])</span>
    <span class="n">dat_</span><span class="p">[</span><span class="n">clone_key</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
        <span class="n">dat_</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_clone.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
              <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
              <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Updated Dandelion object: </span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">data</span><span class="se">\&#39;</span><span class="s1">, contig-indexed clone table</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">metadata</span><span class="se">\&#39;</span><span class="s1">, cell-indexed clone table</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">germline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">germline_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">germline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">germline_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dist_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edge_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edge_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layout_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layout_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">graph_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">threshold_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">threshold_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;clone_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key_added</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># TODO: need to check the following bits if it works properly if only heavy chain tables are provided</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat_</span><span class="p">,</span>
                          <span class="n">germline</span><span class="o">=</span><span class="n">germline_</span><span class="p">,</span>
                          <span class="n">distance</span><span class="o">=</span><span class="n">dist_</span><span class="p">,</span>
                          <span class="n">edges</span><span class="o">=</span><span class="n">edge_</span><span class="p">,</span>
                          <span class="n">layout</span><span class="o">=</span><span class="n">layout_</span><span class="p">,</span>
                          <span class="n">graph</span><span class="o">=</span><span class="n">graph_</span><span class="p">,</span>
                          <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>
            <span class="n">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reinitialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;clone_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key_added</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat_</span><span class="p">,</span>
                          <span class="n">germline</span><span class="o">=</span><span class="n">germline_</span><span class="p">,</span>
                          <span class="n">distance</span><span class="o">=</span><span class="n">dist_</span><span class="p">,</span>
                          <span class="n">edges</span><span class="o">=</span><span class="n">edge_</span><span class="p">,</span>
                          <span class="n">layout</span><span class="o">=</span><span class="n">layout_</span><span class="p">,</span>
                          <span class="n">graph</span><span class="o">=</span><span class="n">graph_</span><span class="p">,</span>
                          <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>
            <span class="n">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">reinitialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">clone_key</span><span class="o">=</span><span class="s1">&#39;clone_id&#39;</span><span class="p">,</span>
                            <span class="n">retrieve</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                            <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">collapse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat_</span><span class="p">,</span>
                          <span class="n">germline</span><span class="o">=</span><span class="n">germline_</span><span class="p">,</span>
                          <span class="n">distance</span><span class="o">=</span><span class="n">dist_</span><span class="p">,</span>
                          <span class="n">edges</span><span class="o">=</span><span class="n">edge_</span><span class="p">,</span>
                          <span class="n">layout</span><span class="o">=</span><span class="n">layout_</span><span class="p">,</span>
                          <span class="n">graph</span><span class="o">=</span><span class="n">graph_</span><span class="p">,</span>
                          <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                          <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>
            <span class="n">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">reinitialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                            <span class="n">locus</span><span class="o">=</span><span class="n">locus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold_</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat_</span><span class="p">,</span>
                        <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                        <span class="n">retrieve</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                        <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">collapse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">locus</span> <span class="o">=</span> <span class="n">locus</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="transfer"><a class="viewcode-back" href="../../../modules/dandelion.tools.transfer.html#dandelion.tools.transfer">[docs]</a><span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
             <span class="n">dandelion</span><span class="p">:</span> <span class="n">Dandelion</span><span class="p">,</span>
             <span class="n">expanded_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">neighbors_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">rna_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">vdj_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">overwrite</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnnData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transfer data in `Dandelion` slots to `AnnData` object, updating the `.obs`, `.uns`, `.obsm` and `.obsp`slots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : AnnData</span>
<span class="sd">        `AnnData` object.</span>
<span class="sd">    dandelion : Dandelion</span>
<span class="sd">        `Dandelion` object.</span>
<span class="sd">    expanded_only : bool</span>
<span class="sd">        Whether or not to transfer the embedding with all cells with BCR (False) or only for expanded clones (True).</span>
<span class="sd">    neighbors_key : str, optional</span>
<span class="sd">        key for &#39;neighbors&#39; slot in `.uns`.</span>
<span class="sd">    rna_key : str, optional</span>
<span class="sd">        prefix for stashed RNA connectivities and distances.</span>
<span class="sd">    vdj_key : str, optional</span>
<span class="sd">        prefix for stashed VDJ connectivities and distances.</span>
<span class="sd">    overwrite : str, bool, list, optional</span>
<span class="sd">        Whether or not to overwrite existing anndata columns. Specifying a string indicating column name or list of column names will overwrite that specific column(s).</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    `AnnData` object with updated `.obs`, `.obsm` and &#39;.obsp&#39; slots with data from `Dandelion` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Transferring network&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dandelion</span><span class="o">.</span><span class="n">graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">expanded_only</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">dandelion</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">dandelion</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">to_pandas_adjacency</span><span class="p">(</span><span class="n">G</span><span class="p">,</span>
                                           <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                           <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span>
                                           <span class="n">nonedge</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">connectivities</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">to_pandas_adjacency</span><span class="p">(</span><span class="n">G</span><span class="p">,</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                                <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span>
                                                <span class="n">nonedge</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">connectivities</span><span class="p">[</span><span class="o">~</span><span class="n">connectivities</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_names</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)))</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_connectivities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">A</span><span class="p">,</span>
                                         <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span>
                                         <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span>
        <span class="n">df_distances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">B</span><span class="p">,</span>
                                    <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span>
                                    <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;converting matrices&#39;</span><span class="p">)</span>
        <span class="n">df_connectivities</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">connectivities</span><span class="p">)</span>
        <span class="n">df_distances</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>

        <span class="n">df_connectivities_</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">df_connectivities</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">df_distances_</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">df_distances</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updating anndata slots&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neighbors_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">neighbors_key</span> <span class="o">=</span> <span class="s2">&quot;neighbors&quot;</span>
        <span class="k">if</span> <span class="n">neighbors_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`edges=True` requires `pp.neighbors` to be run before.&quot;</span><span class="p">)</span>

        <span class="n">rna_neighbors_key</span> <span class="o">=</span> <span class="s1">&#39;rna_&#39;</span> <span class="o">+</span> <span class="n">neighbors_key</span>
        <span class="n">vdj_neighbors_key</span> <span class="o">=</span> <span class="s1">&#39;vdj_&#39;</span> <span class="o">+</span> <span class="n">neighbors_key</span>
        <span class="k">if</span> <span class="n">rna_neighbors_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">rna_neighbors_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">neighbors_key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">neighbors_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`edges=True` requires `pp.neighbors` to be run before.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rna_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r_connectivities_key</span> <span class="o">=</span> <span class="s1">&#39;rna_connectivities&#39;</span>
            <span class="n">r_distances_key</span> <span class="o">=</span> <span class="s1">&#39;rna_distances&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r_connectivities_key</span> <span class="o">=</span> <span class="n">rna_key</span> <span class="o">+</span> <span class="s1">&#39;_connectivitites&#39;</span>
            <span class="n">r_distances_key</span> <span class="o">=</span> <span class="n">rna_key</span> <span class="o">+</span> <span class="s1">&#39;_distances&#39;</span>

        <span class="k">if</span> <span class="n">vdj_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b_connectivities_key</span> <span class="o">=</span> <span class="s1">&#39;vdj_connectivities&#39;</span>
            <span class="n">b_distances_key</span> <span class="o">=</span> <span class="s1">&#39;vdj_distances&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b_connectivities_key</span> <span class="o">=</span> <span class="n">vdj_key</span> <span class="o">+</span> <span class="s1">&#39;_connectivitites&#39;</span>
            <span class="n">b_distances_key</span> <span class="o">=</span> <span class="n">vdj_key</span> <span class="o">+</span> <span class="s1">&#39;_distances&#39;</span>

        <span class="c1"># stash_rna_connectivities:</span>
        <span class="k">if</span> <span class="n">r_connectivities_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="n">r_connectivities_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span>
                    <span class="s2">&quot;connectivities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="n">r_distances_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="n">r_connectivities_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">neighbors_key</span><span class="p">][</span>
                    <span class="s2">&quot;connectivities&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="n">r_distances_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">neighbors_key</span><span class="p">][</span>
                    <span class="s2">&quot;distances&quot;</span><span class="p">]</span>

        <span class="c1"># always overwrite the bcr slots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s1">&#39;connectivities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_connectivities_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s1">&#39;distances&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_distances_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="n">b_connectivities_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s2">&quot;connectivities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="n">b_distances_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># always overwrite with whatever columns are in dandelion&#39;s metadata:</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dandelion</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dandelion</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dandelion</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">dandelion</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;No_contig&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">overwrite</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">overwrite</span> <span class="o">=</span> <span class="p">[</span><span class="n">overwrite</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ow</span> <span class="ow">in</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">ow</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dandelion</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">ow</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">dandelion</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">ow</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">ow</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;No_contig&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dandelion</span><span class="o">.</span><span class="n">layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">expanded_only</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dandelion</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dandelion</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coord</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">tmp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="c1"># tmp[[1]] = tmp[[1]]*-1</span>
        <span class="n">X_vdj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmp</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_vdj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_vdj</span>

        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39; finished&#39;</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
            <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.obs` with `.metadata`</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;added to `.uns[</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">neighbors_key</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">]` and `.obsp`</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">distances</span><span class="se">\&#39;</span><span class="s1">, cluster-weighted adjacency matrix</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">connectivities</span><span class="se">\&#39;</span><span class="s1">, cluster-weighted adjacency matrix&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                  <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                  <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;updated `.obs` with `.metadata`</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="define_clones"><a class="viewcode-back" href="../../../modules/dandelion.tools.define_clones.html#dandelion.tools.define_clones">[docs]</a><span class="k">def</span> <span class="nf">define_clones</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                  <span class="n">dist</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">action</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span>
                  <span class="n">model</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;ham&#39;</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="s1">&#39;hh_s1f&#39;</span><span class="p">,</span> <span class="s1">&#39;hh_s5f&#39;</span><span class="p">,</span> <span class="s1">&#39;mk_rs1nf&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;mk_rs5nf&#39;</span><span class="p">,</span> <span class="s1">&#39;hs1f_compat&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;m1n_compat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ham&#39;</span><span class="p">,</span>
                  <span class="n">norm</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">,</span> <span class="s1">&#39;mut&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;len&#39;</span><span class="p">,</span>
                  <span class="n">doublets</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;drop&#39;</span><span class="p">,</span>
                  <span class="n">fileformat</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;changeo&#39;</span><span class="p">,</span> <span class="s1">&#39;airr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;airr&#39;</span><span class="p">,</span>
                  <span class="n">ncpu</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">dirs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">outFilePrefix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">key_added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dandelion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find clones using changeo&#39;s `DefineClones.py &lt;https://changeo.readthedocs.io/en/stable/tools/DefineClones.html&gt;`__.</span>

<span class="sd">    Only callable for BCR data at the moment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion, DataFrame, str</span>
<span class="sd">        `Dandelion` object, pandas `DataFrame` in changeo/airr format, or file path to changeo/airr file after clones have been determined.</span>
<span class="sd">    dist : float, optional</span>
<span class="sd">        The distance threshold for clonal grouping. If None, the value will be retrieved from the Dandelion class .threshold slot.</span>
<span class="sd">    action : str</span>
<span class="sd">        Specifies how to handle multiple V(D)J assignments for initial grouping. Default is &#39;set&#39;. The first action will use only the first gene listed. The set action will use all gene assignments and construct a larger gene grouping composed of any sequences sharing an assignment or linked to another sequence by a common assignment (similar to single-linkage).</span>
<span class="sd">    model : str</span>
<span class="sd">        Specifies which substitution model to use for calculating distance between sequences. Default is &#39;ham&#39;. The ham model is nucleotide Hamming distance and aa is amino acid Hamming distance. The hh_s1f and hh_s5f models are human specific single nucleotide and 5-mer content models, respectively, from Yaari et al, 2013. The mk_rs1nf and mk_rs5nf models are mouse specific single nucleotide and 5-mer content models, respectively, from Cui et al, 2016. The m1n_compat and hs1f_compat models are deprecated models provided backwards compatibility with the m1n and hs1f models in Change-O v0.3.3 and SHazaM v0.1.4. Both 5-mer models should be considered experimental.</span>
<span class="sd">    norm : str</span>
<span class="sd">        Specifies how to normalize distances. Default is &#39;len&#39;. &#39;none&#39; (do not normalize), &#39;len&#39; (normalize by length), or &#39;mut&#39; (normalize by number of mutations between sequences).</span>
<span class="sd">    doublets : str</span>
<span class="sd">        Option to control behaviour when dealing with heavy chain &#39;doublets&#39;. Default is &#39;drop&#39;. &#39;drop&#39; will filter out the doublets while &#39;count&#39; will retain only the highest umi count contig.</span>
<span class="sd">    fileformat : str</span>
<span class="sd">        format of V(D)J file/objects. Default is &#39;airr&#39;. Also accepts &#39;changeo&#39;.</span>
<span class="sd">    ncpu : int, optional</span>
<span class="sd">        number of cpus for parallelization. Default is all available cpus.</span>
<span class="sd">    dirs : str, optional</span>
<span class="sd">        If specified, out file will be in this location.</span>
<span class="sd">    outFilePrefix : str, optional</span>
<span class="sd">        If specified, the out file name will have this prefix. None defaults to &#39;dandelion_define_clones&#39;</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Whether or not to print the command used in terminal to call DefineClones.py. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `Dandelion` object with clone_id annotated in `.data` slot and `.metadata` initialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding clones&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ncpu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nproc</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nproc</span> <span class="o">=</span> <span class="n">ncpu</span>

    <span class="k">if</span> <span class="n">key_added</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clone_key</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clone_key</span> <span class="o">=</span> <span class="n">key_added</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">dat_h</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">]</span>
    <span class="n">dat_l</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">])]</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
        <span class="n">tmpFolder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/tmp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">outFolder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="n">tmpFolder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/tmp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">outFolder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmpFolder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tmpFolder</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outFolder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outFolder</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
        <span class="n">h_file1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_heavy-clone.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">tmpFolder</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">h_file2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_heavy-clone.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">outFolder</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">l_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_light.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">tmpFolder</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_clone.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">outFolder</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outFilePrefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_FilePrefix</span> <span class="o">=</span> <span class="n">outFilePrefix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_FilePrefix</span> <span class="o">=</span> <span class="s1">&#39;dandelion_define_clones&#39;</span>
        <span class="n">h_file1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_heavy-clone.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmpFolder</span><span class="p">,</span> <span class="n">out_FilePrefix</span><span class="p">)</span>
        <span class="n">h_file2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_heavy-clone.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outFolder</span><span class="p">,</span> <span class="n">out_FilePrefix</span><span class="p">)</span>
        <span class="n">l_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_light.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmpFolder</span><span class="p">,</span> <span class="n">out_FilePrefix</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_clone.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outFolder</span><span class="p">,</span> <span class="n">out_FilePrefix</span><span class="p">)</span>

    <span class="n">dat_h</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">h_file1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">dat_l</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">l_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">v_field</span> <span class="o">=</span> <span class="s1">&#39;v_call_genotyped&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v_field</span> <span class="o">=</span> <span class="s1">&#39;v_call&#39;</span>

    <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dist_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Threshold value in Dandelion object is None. Please run calculate_threshold first&#39;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Distance value is None. Please provide a distance value (float)&#39;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist_</span> <span class="o">=</span> <span class="n">dist</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;DefineClones.py&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="n">h_file1</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">h_file2</span><span class="p">,</span> <span class="s1">&#39;--act&#39;</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
        <span class="s1">&#39;--model&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="s1">&#39;--norm&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="s1">&#39;--dist&#39;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">dist_</span><span class="p">),</span> <span class="s1">&#39;--nproc&#39;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">nproc</span><span class="p">),</span> <span class="s1">&#39;--vf&#39;</span><span class="p">,</span> <span class="n">v_field</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">clusterLinkage</span><span class="p">(</span><span class="n">cell_series</span><span class="p">,</span> <span class="n">group_series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary of {cell_id : cluster_id} that identifies clusters of cells by analyzing their shared</span>
<span class="sd">        features (group_series) using single linkage.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        cell_series (iter): iter of cell ids.</span>
<span class="sd">        group_series (iter): iter of group ids.</span>

<span class="sd">        Returns:</span>
<span class="sd">        dict:  dictionary of {cell_id : cluster_id}.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># assign initial clusters</span>
        <span class="c1"># initial_dict = {cluster1: [cell1], cluster2: [cell1]}</span>
        <span class="n">initial_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cell_series</span><span class="p">,</span> <span class="n">group_series</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">initial_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">initial_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span><span class="p">]</span>

        <span class="c1"># naive single linkage clustering (ON^2 best case, ON^3 worst case) ...ie for cells with multiple light chains</span>
        <span class="c1"># cluster_dict = {cluster1: [cell1, cell2]}, 2 cells belong in same group if they share 1 light chain</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cluster_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">initial_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">cluster_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">cluster_dict</span><span class="p">:</span>
                    <span class="c1"># if initial_dict[group] and cluster_dict[cluster] share common cells, add initial_dict[group] to cluster</span>
                    <span class="k">if</span> <span class="n">cluster</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">cell</span> <span class="ow">in</span> <span class="n">initial_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                                            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cluster_dict</span><span class="p">[</span><span class="n">cluster</span><span class="p">]):</span>
                        <span class="n">cluster_dict</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_dict</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="n">initial_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">cluster_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="c1"># break if clusters stop changing, otherwise restart</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">initial_dict</span> <span class="o">=</span> <span class="n">cluster_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># invert cluster_dict for return</span>
        <span class="n">assign_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cell</span><span class="p">:</span> <span class="n">k</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cluster_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">assign_dict</span>

    <span class="k">def</span> <span class="nf">_lightCluster</span><span class="p">(</span><span class="n">heavy_file</span><span class="p">,</span> <span class="n">light_file</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="n">doublets</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split heavy chain clones based on light chains</span>

<span class="sd">        Arguments:</span>
<span class="sd">        heavy_file (str): heavy chain input file.</span>
<span class="sd">        light_file (str): light chain input file.</span>
<span class="sd">        out_file (str): heavy chain output file.</span>
<span class="sd">        doublets (str): method for handling multiple heavy chains per cell. one of &#39;drop&#39; or &#39;count&#39;.</span>
<span class="sd">        format (str): file format. one of &#39;changeo&#39; or &#39;airr&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set column names</span>
        <span class="k">if</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;changeo&#39;</span><span class="p">:</span>
            <span class="n">cell_id</span> <span class="o">=</span> <span class="s1">&#39;cell_id&#39;</span>
            <span class="n">clone_id</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
            <span class="n">v_call</span> <span class="o">=</span> <span class="s1">&#39;v_call&#39;</span>
            <span class="n">j_call</span> <span class="o">=</span> <span class="s1">&#39;j_call&#39;</span>
            <span class="n">junction_length</span> <span class="o">=</span> <span class="s1">&#39;junction_length&#39;</span>
            <span class="n">umi_count</span> <span class="o">=</span> <span class="s1">&#39;umicount&#39;</span>
        <span class="k">elif</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;airr&#39;</span><span class="p">:</span>
            <span class="n">cell_id</span> <span class="o">=</span> <span class="s1">&#39;cell_id&#39;</span>
            <span class="n">clone_id</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
            <span class="n">v_call</span> <span class="o">=</span> <span class="s1">&#39;v_call&#39;</span>
            <span class="n">j_call</span> <span class="o">=</span> <span class="s1">&#39;j_call&#39;</span>
            <span class="n">junction_length</span> <span class="o">=</span> <span class="s1">&#39;junction_length&#39;</span>
            <span class="n">umi_count</span> <span class="o">=</span> <span class="s1">&#39;umi_count&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Invalid format </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fileformat</span><span class="p">)</span>

        <span class="c1"># read in heavy and light DFs</span>
        <span class="n">heavy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">heavy_file</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">,</span>
                               <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;NA&#39;</span><span class="p">],</span>
                               <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">light_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">light_file</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">,</span>
                               <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;NA&#39;</span><span class="p">],</span>
                               <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># column checking</span>
        <span class="n">expected_heavy_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">cell_id</span><span class="p">,</span> <span class="n">clone_id</span><span class="p">,</span> <span class="n">v_call</span><span class="p">,</span> <span class="n">j_call</span><span class="p">,</span> <span class="n">junction_length</span><span class="p">,</span> <span class="n">umi_count</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected_heavy_columns</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">heavy_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Missing one or more columns in heavy chain file: &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expected_heavy_columns</span><span class="p">))</span>
        <span class="n">expected_light_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">cell_id</span><span class="p">,</span> <span class="n">v_call</span><span class="p">,</span> <span class="n">j_call</span><span class="p">,</span> <span class="n">junction_length</span><span class="p">,</span> <span class="n">umi_count</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected_light_columns</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">light_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Missing one or more columns in light chain file: &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expected_light_columns</span><span class="p">))</span>

        <span class="c1"># Fix types</span>
        <span class="n">heavy_df</span><span class="p">[</span><span class="n">junction_length</span><span class="p">]</span> <span class="o">=</span> <span class="n">heavy_df</span><span class="p">[</span><span class="n">junction_length</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">light_df</span><span class="p">[</span><span class="n">junction_length</span><span class="p">]</span> <span class="o">=</span> <span class="n">light_df</span><span class="p">[</span><span class="n">junction_length</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="c1"># filter multiple heavy chains</span>
        <span class="k">if</span> <span class="n">doublets</span> <span class="o">==</span> <span class="s1">&#39;drop&#39;</span><span class="p">:</span>
            <span class="n">heavy_df</span> <span class="o">=</span> <span class="n">heavy_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">heavy_df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Empty heavy chain data, after doublets drop. Are you combining experiments in a single file? If so, split your data into multiple files.&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">doublets</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
            <span class="n">heavy_df</span><span class="p">[</span><span class="n">umi_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">heavy_df</span><span class="p">[</span><span class="n">umi_count</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">heavy_df</span> <span class="o">=</span> <span class="n">heavy_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="n">cell_id</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">umi_count</span><span class="p">))</span>

        <span class="c1"># transfer clone IDs from heavy chain df to light chain df</span>
        <span class="n">clone_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">v</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]:</span> <span class="n">v</span><span class="p">[</span><span class="n">clone_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heavy_df</span><span class="p">[[</span><span class="n">clone_id</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">light_df</span> <span class="o">=</span> <span class="n">light_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">light_df</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clone_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="p">]</span>
        <span class="n">light_df</span><span class="p">[</span><span class="n">clone_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">light_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">clone_dict</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># generate a &quot;cluster_dict&quot; of CELL:CLONE dictionary from light df  (TODO: use receptor object V/J gene names)</span>
        <span class="n">cluster_dict</span> <span class="o">=</span> <span class="n">clusterLinkage</span><span class="p">(</span>
            <span class="n">light_df</span><span class="p">[</span><span class="n">cell_id</span><span class="p">],</span>
            <span class="n">light_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">getGene</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">v_call</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">getGene</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">j_call</span><span class="p">])</span> <span class="o">+</span>
                <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">junction_length</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="n">clone_id</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># add assignments to heavy_df</span>
        <span class="n">heavy_df</span> <span class="o">=</span> <span class="n">heavy_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">heavy_df</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cluster_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="p">:]</span>
        <span class="n">heavy_df</span><span class="p">[</span><span class="n">clone_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">heavy_df</span><span class="p">[</span><span class="n">clone_id</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> \
            <span class="n">heavy_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_dict</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># write heavy chains</span>
        <span class="n">heavy_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">heavy_df</span><span class="p">,</span> <span class="n">light_df</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running command: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
    <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="n">h_df</span><span class="p">,</span> <span class="n">l_df</span> <span class="o">=</span> <span class="n">_lightCluster</span><span class="p">(</span><span class="n">h_file2</span><span class="p">,</span>
                               <span class="n">l_file</span><span class="p">,</span>
                               <span class="n">outfile</span><span class="p">,</span>
                               <span class="n">doublets</span><span class="o">=</span><span class="n">doublets</span><span class="p">,</span>
                               <span class="n">fileformat</span><span class="o">=</span><span class="n">fileformat</span><span class="p">)</span>

    <span class="n">h_df</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">h_df</span><span class="p">)</span>
    <span class="c1"># create a dictionary for cell_id : clone_id from h_df</span>
    <span class="n">linked_clones</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">h_df</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">],</span> <span class="n">h_df</span><span class="p">[</span><span class="s1">&#39;clone_id&#39;</span><span class="p">]))</span>

    <span class="c1"># create a clone_reference</span>
    <span class="n">clone_ref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">h_df</span><span class="p">[</span><span class="s1">&#39;clone_id&#39;</span><span class="p">]))</span>
    <span class="n">clone_ref</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">else</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clone_ref</span><span class="p">]</span>
    <span class="n">l_df</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">l_df</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;clone_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">clone_ref</span><span class="p">:</span>
            <span class="n">l_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;clone_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linked_clones</span><span class="p">[</span><span class="n">l_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">l_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;clone_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_notlinked&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">cloned_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">h_df</span><span class="p">,</span> <span class="n">l_df</span><span class="p">])</span>
    <span class="c1"># transfer the new clone_id to the heavy + light file</span>
    <span class="n">dat</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clone_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">cloned_</span><span class="p">[</span><span class="s1">&#39;clone_id&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">germline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">germline_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">germline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">germline_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dist_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edge_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edge_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layout_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layout_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">graph_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">threshold_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">threshold_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;clone_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clone_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span>
                          <span class="n">germline</span><span class="o">=</span><span class="n">germline_</span><span class="p">,</span>
                          <span class="n">distance</span><span class="o">=</span><span class="n">dist_</span><span class="p">,</span>
                          <span class="n">edges</span><span class="o">=</span><span class="n">edge_</span><span class="p">,</span>
                          <span class="n">layout</span><span class="o">=</span><span class="n">layout_</span><span class="p">,</span>
                          <span class="n">graph</span><span class="o">=</span><span class="n">graph_</span><span class="p">,</span>
                          <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">retrieve</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                          <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">collapse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;clone_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clone_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span>
                          <span class="n">germline</span><span class="o">=</span><span class="n">germline_</span><span class="p">,</span>
                          <span class="n">distance</span><span class="o">=</span><span class="n">dist_</span><span class="p">,</span>
                          <span class="n">edges</span><span class="o">=</span><span class="n">edge_</span><span class="p">,</span>
                          <span class="n">layout</span><span class="o">=</span><span class="n">layout_</span><span class="p">,</span>
                          <span class="n">graph</span><span class="o">=</span><span class="n">graph_</span><span class="p">,</span>
                          <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                          <span class="n">retrieve</span><span class="o">=</span><span class="n">clone_key</span><span class="p">,</span>
                          <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">collapse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span>
                          <span class="n">germline</span><span class="o">=</span><span class="n">germline_</span><span class="p">,</span>
                          <span class="n">distance</span><span class="o">=</span><span class="n">dist_</span><span class="p">,</span>
                          <span class="n">edges</span><span class="o">=</span><span class="n">edge_</span><span class="p">,</span>
                          <span class="n">layout</span><span class="o">=</span><span class="n">layout_</span><span class="p">,</span>
                          <span class="n">graph</span><span class="o">=</span><span class="n">graph_</span><span class="p">,</span>
                          <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold_</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;clone_id&#39;</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clone_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">retrieve</span><span class="o">=</span><span class="n">clonekey</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;clone_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clone_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">clone_key</span><span class="o">=</span><span class="n">clone_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
              <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
              <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Updated Dandelion object: </span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">data</span><span class="se">\&#39;</span><span class="s1">, contig-indexed clone table</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">metadata</span><span class="se">\&#39;</span><span class="s1">, cell-indexed clone table</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="clone_size"><a class="viewcode-back" href="../../../modules/dandelion.tools.clone_size.html#dandelion.tools.clone_size">[docs]</a><span class="k">def</span> <span class="nf">clone_size</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Dandelion</span><span class="p">,</span>
               <span class="n">max_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">key_added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quantifies size of clones</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion</span>
<span class="sd">        `Dandelion` object</span>
<span class="sd">    max_size : int, optional</span>
<span class="sd">        The maximum size before value gets clipped. If None, the value will be returned as a numerical value.</span>
<span class="sd">    clone_key : str, optional</span>
<span class="sd">        Column name specifying the clone_id column in metadata.</span>
<span class="sd">    key_added : str, optional</span>
<span class="sd">        column name where clone size is tabulated into.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `Dandelion` object with clone size columns annotated in `.metadata` slot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Quantifying clone sizes&#39;</span><span class="p">)</span>

    <span class="n">metadata_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">clone_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clonekey</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clonekey</span> <span class="o">=</span> <span class="n">clone_key</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">tmp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span>

    <span class="n">clonesize</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clonesize_</span> <span class="o">=</span> <span class="n">clonesize</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clonesize</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clonesize</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_size</span><span class="p">:</span>
                <span class="n">clonesize_</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&gt;= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_size</span><span class="p">)</span>
        <span class="n">clonesize_</span> <span class="o">=</span> <span class="n">clonesize_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clonesize_</span> <span class="o">=</span> <span class="n">clonesize</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">clonesize_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">clonesize_</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key_added</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_size_max_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_size</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">[</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span>
                                <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                                    <span class="nb">set</span><span class="p">([</span>
                                        <span class="n">clonesize_dict</span><span class="p">[</span><span class="n">c_</span><span class="p">]</span>
                                        <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                                    <span class="p">])),</span>
                                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&gt;= &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                    <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span>
                                <span class="n">c</span> <span class="k">else</span> <span class="n">clonesize_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span>
                            <span class="p">]</span>
                        <span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_size_max_&#39;</span> <span class="o">+</span>
                          <span class="nb">str</span><span class="p">(</span><span class="n">max_size</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_size_max_&#39;</span> <span class="o">+</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">max_size</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key_added</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">[</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                                <span class="nb">set</span><span class="p">([</span>
                                    <span class="n">clonesize_dict</span><span class="p">[</span><span class="n">c_</span><span class="p">]</span> <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                                <span class="p">])),</span>
                                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&gt;= &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span>
                            <span class="n">c</span> <span class="k">else</span> <span class="n">clonesize_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span>
                        <span class="p">]</span>
                    <span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_size_max_&#39;</span> <span class="o">+</span>
                          <span class="nb">str</span><span class="p">(</span><span class="n">max_size</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_size_max_&#39;</span> <span class="o">+</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">max_size</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key_added</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">[</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                                <span class="nb">set</span><span class="p">([</span>
                                    <span class="n">clonesize_dict</span><span class="p">[</span><span class="n">c_</span><span class="p">]</span> <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                                <span class="p">])),</span>
                                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&gt;= &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span>
                            <span class="n">c</span> <span class="k">else</span> <span class="n">clonesize_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span>
                        <span class="p">]</span>
                    <span class="p">])))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_size&#39;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key_added</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">[</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                                <span class="nb">set</span><span class="p">([</span>
                                    <span class="n">clonesize_dict</span><span class="p">[</span><span class="n">c_</span><span class="p">]</span> <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                                <span class="p">])),</span>
                                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&gt;= &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span>
                            <span class="n">c</span> <span class="k">else</span> <span class="n">clonesize_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span>
                        <span class="p">]</span>
                    <span class="p">])))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key_added</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_size&#39;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
              <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
              <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Updated Dandelion object: </span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">metadata</span><span class="se">\&#39;</span><span class="s1">, cell-indexed clone table&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="clone_overlap"><a class="viewcode-back" href="../../../modules/dandelion.tools.clone_overlap.html#dandelion.tools.clone_overlap">[docs]</a><span class="k">def</span> <span class="nf">clone_overlap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dandelion</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">],</span>
        <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">colorby</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">min_clone_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AnnData</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to tabulate clonal overlap for input as a circos-style plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion, AnnData</span>
<span class="sd">        `Dandelion` or `AnnData` object.</span>
<span class="sd">    groupby : str</span>
<span class="sd">        column name in obs/metadata for collapsing to nodes in circos plot.</span>
<span class="sd">    colorby : str</span>
<span class="sd">        column name in obs/metadata for grouping and color of nodes in circos plot.</span>
<span class="sd">    min_clone_size : int, optional</span>
<span class="sd">        minimum size of clone for plotting connections. Defaults to 2 if left as None.</span>
<span class="sd">    clone_key : str, optional</span>
<span class="sd">        column name for clones. None defaults to &#39;clone_id&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    a `pandas DataFrame`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding clones&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Dandelion</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">min_clone_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_size</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_clone_size</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">clone_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clone_</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clone_</span> <span class="o">=</span> <span class="n">clone_key</span>

    <span class="c1"># get rid of problematic rows that appear because of category conversion?</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">clone_</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;NaN&#39;</span><span class="p">,</span> <span class="s1">&#39;No_contig&#39;</span><span class="p">,</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]))]</span>

    <span class="c1"># prepare a summary table</span>
    <span class="n">datc_</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">clone_</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
    <span class="n">datc_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">datc_</span><span class="p">)</span>
    <span class="n">datc_</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">datc_</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="n">clone_</span><span class="p">]</span>
    <span class="n">datc_</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">datc_</span> <span class="o">=</span> <span class="n">datc_</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">datc_</span><span class="p">[</span><span class="n">clone_</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;NaN&#39;</span><span class="p">,</span> <span class="s1">&#39;No_contig&#39;</span><span class="p">,</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]))]</span>
    <span class="n">dictg_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">groupby</span><span class="p">])</span>
    <span class="n">datc_</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictg_</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">datc_</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]]</span>

    <span class="n">overlap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">datc_</span><span class="p">[</span><span class="n">clone_</span><span class="p">],</span> <span class="n">datc_</span><span class="p">[</span><span class="n">groupby</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">min_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;min_size must be greater than 0.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">overlap</span><span class="p">[</span><span class="n">overlap</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">overlap</span><span class="p">[</span><span class="n">overlap</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">min_size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">overlap</span><span class="p">[</span><span class="n">overlap</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">overlap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">overlap</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">AnnData</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;clone_overlap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                  <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                  <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Updated AnnData: </span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">uns</span><span class="se">\&#39;</span><span class="s1">, clone overlap table&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">overlap</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, zktuong.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>