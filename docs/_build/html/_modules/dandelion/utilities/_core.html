

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>dandelion.utilities._core &mdash; dandelion  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/dandelion_logo.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/dandelion_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#required-database">Required database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#external-softwares">External softwares</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#basic-requirements">Basic requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#acknowledgements">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#citation">Citation</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/singularity_preprocessing.html">Dandelion preprocessing with Singularity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/gamma_delta.html">Dandelion for TCR gamma/delta reannotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1_dandelion_preprocessing-10x_data.html">Pre-processing (Re-annotation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/2_dandelion_filtering-10x_data.html">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1b_dandelion_noreannotation-10x_data.html">Reading 10X Cell Ranger output directly</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/3_dandelion_findingclones-10x_data.html">BCR clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1c_dandelion_scirpy.html">Interoperability with <code class="docutils literal notranslate"><span class="pre">scirpy</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/4_dandelion_visualization-10x_data.html">Visualizing BCR data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/5_dandelion_diversity_and_mutation-10x_data.html">Calculating diversity and mutation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/0_dandelion_primer.html"><em>Dandelion</em> class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/6_dandelion_running_from_R-10x_data.html">Running from R</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/7_dandelion_TCR_data_10x_data.html">Analyzing TCR data</a></li>
</ul>
<p class="caption"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Preprocessing: <cite>pp</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.preprocessing.external">Preprocessing (external): <cite>pp.external</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.tools">Tools: <cite>tl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.plotting">Plotting: <cite>pl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.utilities">Utilities: <cite>utl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.Dandelion">Dandelion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.logging">Logging</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dandelion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>dandelion.utilities._core</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dandelion.utilities._core</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># @Author: Kelvin</span>
<span class="c1"># @Date:   2021-02-11 12:22:40</span>
<span class="c1"># @Last Modified by:   Kelvin</span>
<span class="c1"># @Last Modified time: 2021-07-17 00:35:14</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">changeo.IO</span> <span class="kn">import</span> <span class="n">readGermlines</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">from</span> <span class="nn">anndata</span> <span class="kn">import</span> <span class="n">AnnData</span>
<span class="kn">import</span> <span class="nn">_pickle</span> <span class="k">as</span> <span class="nn">cPickle</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scanpy</span> <span class="kn">import</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">logg</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">..utilities._utilities</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..utilities._io</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>

<span class="n">BOOLEAN_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;productive&#39;</span><span class="p">,</span> <span class="s1">&#39;rev_comp&#39;</span><span class="p">,</span> <span class="s1">&#39;vj_in_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;stop_codon&#39;</span><span class="p">,</span> <span class="s1">&#39;complete_vdj&#39;</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">Dandelion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    `Dandelion` class object.</span>

<span class="sd">    Main class object storing input/ouput slots for all functions.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">germline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">edges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">germline</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">germline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">germline</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sanitize_dandelion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_contigs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">initialize</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locus</span><span class="o">=</span><span class="s1">&#39;tr-ab&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locus</span><span class="o">=</span><span class="s1">&#39;tr-gd&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                                <span class="s1">&#39;Unable to read data. Are you sure this is an AIRR formatted data?&#39;</span>
                            <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_contigs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_gen_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">n_contigs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># inspire by AnnData&#39;s function</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Dandelion class object with n_obs = </span><span class="si">{</span><span class="n">n_obs</span><span class="si">}</span><span class="s2"> and n_contigs = </span><span class="si">{</span><span class="n">n_contigs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">,</span> <span class="s2">&quot;edges&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    layout: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;layout for &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; vertices&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    layout: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    graph: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;networkx graph of &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; vertices&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    graph: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">descr</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># inspire by AnnData&#39;s function</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_contigs</span><span class="p">)</span>

<div class="viewcode-block" id="Dandelion.copy"><a class="viewcode-back" href="../../../modules/dandelion.Dandelion.copy.html#dandelion.Dandelion.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a deep copy of all slots in `Dandelion` class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self : Dandelion</span>
<span class="sd">            `Dandelion` object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        a deep copy of `Dandelion` class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dandelion.update_germline"><a class="viewcode-back" href="../../../modules/dandelion.Dandelion.update_germline.html#dandelion.Dandelion.update_germline">[docs]</a>    <span class="k">def</span> <span class="nf">update_germline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">corrected</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">germline</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">org</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;human&#39;</span><span class="p">,</span> <span class="s1">&#39;mouse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;human&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update germline reference with corrected sequences and store in `Dandelion` object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self : Dandelion</span>
<span class="sd">            `Dandelion` object.</span>
<span class="sd">        corrected : dict, str, optional</span>
<span class="sd">            dictionary of corrected germline sequences or file path to corrected germline sequences fasta file.</span>
<span class="sd">        germline : str, optional</span>
<span class="sd">            path to germline database folder. Defaults to `$GERMLINE` environmental variable.</span>
<span class="sd">        org : str</span>
<span class="sd">            organism of reference folder. Default is &#39;human&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        updated germline reference diciontary in `.germline` slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating germline reference&#39;</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">germline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gml</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;GERMLINE&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                    <span class="s1">&#39;Environmental variable GERMLINE must be set. Otherwise, please provide path to folder containing germline IGHV, IGHD, and IGHJ fasta files.&#39;</span>
                <span class="p">)</span>
            <span class="n">gml</span> <span class="o">=</span> <span class="n">gml</span> <span class="o">+</span> <span class="s1">&#39;imgt/&#39;</span> <span class="o">+</span> <span class="n">org</span> <span class="o">+</span> <span class="s1">&#39;/vdj/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">germline</span><span class="p">):</span>
                <span class="n">gml</span> <span class="o">=</span> <span class="n">germline</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">germline</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">germline_</span> <span class="o">=</span> <span class="p">[</span><span class="n">germline</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">germline_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                        <span class="s1">&#39;Input for germline is incorrect. Please provide path to folder containing germline IGHV, IGHD, and IGHJ fasta files, or individual paths to the germline IGHV, IGHD, and IGHJ fasta files (with .fasta extension) as a list.&#39;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gml</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">germline_</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                                <span class="s1">&#39;Input for germline is incorrect. Please provide path to folder containing germline IGHV, IGHD, and IGHJ fasta files, or individual paths to the germline IGHV, IGHD, and IGHJ fasta files (with .fasta extension) as a list.&#39;</span>
                            <span class="p">)</span>
                        <span class="n">gml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">germline</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">germline</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                        <span class="s1">&#39;Input for germline is incorrect. Please provide path to folder containing germline IGHV, IGHD, and IGHJ fasta files, or individual paths to the germline IGHV, IGHD, and IGHJ fasta files (with .fasta extension) as a list.&#39;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gml</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">germline</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                                <span class="s1">&#39;Input for germline is incorrect. Please provide path to folder containing germline IGHV, IGHD, and IGHJ fasta files, or individual paths to the germline IGHV, IGHD, and IGHJ fasta files (with .fasta extension) as a list.&#39;</span>
                            <span class="p">)</span>
                        <span class="n">gml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">gml</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">gml</span> <span class="o">=</span> <span class="p">[</span><span class="n">gml</span><span class="p">]</span>

        <span class="n">germline_ref</span> <span class="o">=</span> <span class="n">readGermlines</span><span class="p">(</span><span class="n">gml</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">corrected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">corrected</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">personalized_ref_dict</span> <span class="o">=</span> <span class="n">corrected</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">corrected</span><span class="p">)):</span>
                <span class="n">personalized_ref_dict</span> <span class="o">=</span> <span class="n">readGermlines</span><span class="p">([</span><span class="n">corrected</span><span class="p">])</span>
            <span class="c1"># update with the personalized germline database</span>
            <span class="k">if</span> <span class="s1">&#39;personalized_ref_dict&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="n">germline_ref</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">personalized_ref_dict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                    <span class="s1">&#39;Input for corrected germline fasta is incorrect. Please provide path to file containing corrected germline fasta sequences.&#39;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">germline_ref</span><span class="p">)</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span>
                  <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                  <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Updated Dandelion object: </span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">germline</span><span class="se">\&#39;</span><span class="s1">, updated germline reference</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Dandelion.write_pkl"><a class="viewcode-back" href="../../../modules/dandelion.Dandelion.write_pkl.html#dandelion.Dandelion.write_pkl">[docs]</a>    <span class="k">def</span> <span class="nf">write_pkl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;dandelion_data.pkl.pbz2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a `Dandelion` class to .pkl format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename</span>
<span class="sd">            path to `.pkl` file.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            passed to `_pickle`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isBZIP</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">isGZIP</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Dandelion.write_h5"><a class="viewcode-back" href="../../../modules/dandelion.Dandelion.write_h5.html#dandelion.Dandelion.write_h5">[docs]</a>    <span class="k">def</span> <span class="nf">write_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;dandelion_data.h5&#39;</span><span class="p">,</span>
                 <span class="n">complib</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;zlib&#39;</span><span class="p">,</span> <span class="s1">&#39;lzo&#39;</span><span class="p">,</span> <span class="s1">&#39;bzip2&#39;</span><span class="p">,</span> <span class="s1">&#39;blosc&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;blosc:blosclz&#39;</span><span class="p">,</span> <span class="s1">&#39;blosc:lz4&#39;</span><span class="p">,</span> <span class="s1">&#39;blosc:lz4hc&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;blosc:snappy&#39;</span><span class="p">,</span> <span class="s1">&#39;blosc:zlib&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;blosc:zstd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">compression</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;zlib&#39;</span><span class="p">,</span> <span class="s1">&#39;lzo&#39;</span><span class="p">,</span> <span class="s1">&#39;bzip2&#39;</span><span class="p">,</span> <span class="s1">&#39;blosc&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;blosc:blosclz&#39;</span><span class="p">,</span> <span class="s1">&#39;blosc:lz4&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;blosc:lz4hc&#39;</span><span class="p">,</span> <span class="s1">&#39;blosc:snappy&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;blosc:zlib&#39;</span><span class="p">,</span> <span class="s1">&#39;blosc:zstd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">compression_level</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a `Dandelion` class to .h5 format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename</span>
<span class="sd">            path to `.h5` file.</span>
<span class="sd">        complib : str, optional</span>
<span class="sd">            method for compression for data frames. see (https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_hdf.html) for more options.</span>
<span class="sd">        compression : str, optional</span>
<span class="sd">            same call as complib. Just a convenience option.</span>
<span class="sd">        compression_opts : {0-9}, optional</span>
<span class="sd">            Specifies a compression level for data. A value of 0 disables compression.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            passed to `pd.DataFrame.to_hdf`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">compression_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">compression_level</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compression_level</span> <span class="o">=</span> <span class="n">compression_level</span>

        <span class="c1"># a little hack to overwrite the existing file?</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">datasetname</span> <span class="ow">in</span> <span class="n">hf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">hf</span><span class="p">[</span><span class="n">datasetname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">complib</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compression</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">complib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compression</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">complib</span>
        <span class="k">elif</span> <span class="n">complib</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">compression</span>
        <span class="k">if</span> <span class="n">complib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Please specify only complib or compression. They do the same thing.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># now to actually saving</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">weird</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span> <span class="o">!=</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">type</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">weird</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                         <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                         <span class="n">complib</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                         <span class="n">complevel</span><span class="o">=</span><span class="n">compression_level</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">weird</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span> <span class="o">!=</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">type</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">weird</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                 <span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
                                 <span class="n">complib</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                                 <span class="n">complevel</span><span class="o">=</span><span class="n">compression_level</span><span class="p">,</span>
                                 <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">,</span>
                                 <span class="n">nan_rep</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     warnings.warn(&quot;`metadata` slot not saved. Please check if there is incompatible dtypes in the metadata table.&quot;)</span>
        <span class="c1">#     pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                              <span class="s2">&quot;edges&quot;</span><span class="p">,</span>
                              <span class="n">complib</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                              <span class="n">complevel</span><span class="o">=</span><span class="n">compression_level</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">graph_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">:</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">to_pandas_adjacency</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">nonedge</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">G</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                         <span class="s2">&quot;graph/graph_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">graph_counter</span><span class="p">),</span>
                         <span class="n">complib</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                         <span class="n">complevel</span><span class="o">=</span><span class="n">compression_level</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">graph_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
                <span class="c1"># how to make this faster?</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>
                <span class="n">dat</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                           <span class="s2">&quot;distance/&quot;</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span>
                           <span class="n">complib</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                           <span class="n">complevel</span><span class="o">=</span><span class="n">compression_level</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="c1"># try:</span>
            <span class="c1">#     for d in self.distance:</span>
            <span class="c1">#         hf.create_dataset(&#39;distance/&#39;+d+&#39;/data&#39;, data=self.distance[d].data, compression = compression, compression_opts = compression_level)</span>
            <span class="c1">#         hf.create_dataset(&#39;distance/&#39;+d+&#39;/indptr&#39;, data=self.distance[d].indptr, compression = compression, compression_opts = compression_level)</span>
            <span class="c1">#         hf.create_dataset(&#39;distance/&#39;+d+&#39;/indices&#39;, data=self.distance[d].indices, compression = compression, compression_opts = compression_level)</span>
            <span class="c1">#         hf[&#39;distance/&#39;+d].attrs[&#39;shape&#39;] = self.distance[d].shape</span>
            <span class="c1"># except:</span>
            <span class="c1">#     pass</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">layout_counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;layout/layout_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layout_counter</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;layout/layout_&#39;</span> <span class="o">+</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">layout_counter</span><span class="p">)]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">layout_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;germline&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;germline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">tr</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">sanitize_dandelion</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Dandelion</span><span class="p">,</span>
                       <span class="n">boolean_columns</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">BOOLEAN_COLUMNS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick sanitize dtypes.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">boolean_columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                 <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sanitize_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick sanitize dtypes.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">retrieve_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                      <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">split</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">collapse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">combine</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">locus</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;ig&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ig&#39;</span><span class="p">,</span>
                      <span class="n">split_locus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">data_tmp</span> <span class="o">=</span> <span class="n">sanitize_data</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">dat_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">dict_</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">metadata_</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">locus_dict1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;IGH&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;TRB&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;TRD&#39;</span><span class="p">}</span>
    <span class="n">locus_dict2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">],</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;TRA&#39;</span><span class="p">],</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;TRG&#39;</span><span class="p">]}</span>
    <span class="n">locus_dict3</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">}</span>
    <span class="n">locus_dict4</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;G&#39;</span><span class="p">}</span>
    <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data_tmp</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="n">data_tmp</span><span class="p">[</span><span class="n">query</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">data_tmp</span><span class="p">[</span><span class="n">query</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;unassigned&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">typesoflocus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data_tmp</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">typesoflocus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">split_locus</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">loci</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">([</span><span class="n">locus_dict1</span><span class="p">[</span><span class="n">locus</span><span class="p">]]</span> <span class="o">+</span> <span class="n">locus_dict2</span><span class="p">[</span><span class="n">locus</span><span class="p">]):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">data_tmp</span><span class="p">[</span><span class="n">data_tmp</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">loci</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dat_dict</span><span class="p">[</span><span class="n">loci</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp3</span> <span class="o">=</span> <span class="n">data_tmp</span><span class="p">[</span><span class="n">data_tmp</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">locus_dict1</span><span class="p">[</span><span class="n">locus</span><span class="p">]])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">tmp4</span> <span class="o">=</span> <span class="n">data_tmp</span><span class="p">[</span><span class="n">data_tmp</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">locus_dict2</span><span class="p">[</span><span class="n">locus</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tmp3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dat_dict</span><span class="p">[</span><span class="n">locus_dict3</span><span class="p">[</span><span class="n">locus</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tmp3</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tmp4</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dat_dict</span><span class="p">[</span><span class="n">locus_dict4</span><span class="p">[</span><span class="n">locus</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tmp4</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="ne">UserWarning</span><span class="p">(</span>
                    <span class="s1">&#39;Single locus type detected. Ignoring split = True and split_locus = True.&#39;</span>
                <span class="p">))</span>
        <span class="n">dat_dict</span><span class="p">[</span><span class="n">locus_dict3</span><span class="p">[</span><span class="n">locus</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data_tmp</span><span class="p">[</span><span class="n">data_tmp</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
            <span class="p">[</span><span class="n">locus_dict1</span><span class="p">[</span><span class="n">locus</span><span class="p">]])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dat_dict</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dat_dict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;cell_id&#39;</span><span class="p">],</span>
                             <span class="n">dat_dict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">]):</span>
            <span class="n">tmp</span><span class="p">[</span><span class="n">cell</span><span class="p">][</span><span class="n">seq</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">seqs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">[</span><span class="n">t</span><span class="p">]])</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">seqs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">metadata_</span><span class="p">[</span><span class="n">d</span><span class="p">])]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">if</span> <span class="n">split_locus</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">locus_dict1</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">locus_dict3</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_</span><span class="p">[</span><span class="n">H</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="n">H</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_</span><span class="p">[</span><span class="n">H</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="n">H</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">typesoflocus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">split_locus</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">locus_dict2</span><span class="p">[</span><span class="n">locus</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">metadata_</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">L</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">metadata_</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">L</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">locus_dict4</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">metadata_</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">L</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metadata_</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">L</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">]</span>

    <span class="n">metadata_result</span> <span class="o">=</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">[</span><span class="n">l</span><span class="p">]:</span>
            <span class="n">metadata_result</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">query_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">i</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
            <span class="p">]</span>

    <span class="k">if</span> <span class="n">typesoflocus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">split_locus</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">retrieve_result_dict</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data_tmp</span><span class="p">,</span>
                                           <span class="n">metadata_result</span><span class="p">[</span><span class="n">locus_dict3</span><span class="p">[</span><span class="n">locus</span><span class="p">]],</span>
                                           <span class="n">metadata_result</span><span class="p">[</span><span class="n">locus_dict4</span><span class="p">[</span><span class="n">locus</span><span class="p">]],</span>
                                           <span class="n">locus</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">collapse</span><span class="p">,</span> <span class="n">combine</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">retrieve_result_dict</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span> <span class="n">data_tmp</span><span class="p">,</span> <span class="n">metadata_result</span><span class="p">[</span><span class="n">locus_dict1</span><span class="p">[</span><span class="n">locus</span><span class="p">]],</span>
                <span class="p">[</span><span class="n">metadata_result</span><span class="p">[</span><span class="n">L</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">locus_dict2</span><span class="p">[</span><span class="n">locus</span><span class="p">]],</span> <span class="n">locus</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">collapse</span><span class="p">,</span> <span class="n">combine</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">retrieve_result_dict_singular</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">data_tmp</span><span class="p">,</span> <span class="n">metadata_result</span><span class="p">[</span><span class="n">locus_dict3</span><span class="p">[</span><span class="n">locus</span><span class="p">]],</span> <span class="n">locus</span><span class="p">,</span>
            <span class="n">collapse</span><span class="p">,</span> <span class="n">combine</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">results</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">retrieve_result_dict</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                         <span class="n">meta_h</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                         <span class="n">meta_l</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                         <span class="n">locus</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;ig&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ig&#39;</span><span class="p">,</span>
                         <span class="n">split</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">collapse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">combine</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="n">df_hl</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">locus_dict1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;IGH&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;TRB&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;TRD&#39;</span><span class="p">}</span>
    <span class="n">locus_dict2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">],</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;TRA&#39;</span><span class="p">],</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;TRG&#39;</span><span class="p">]}</span>
    <span class="n">locus_dict3</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">}</span>
    <span class="n">locus_dict4</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;G&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">locus_dict1</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">locus_dict3</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">meta_h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">collapse</span><span class="p">:</span>
            <span class="n">newmeta_h</span> <span class="o">=</span> <span class="n">meta_h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
                <span class="n">newh</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">meta_h</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">newh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                            <span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">newmeta_h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="n">h</span>
                        <span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">newh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">newmeta_h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="n">h</span>
                        <span class="p">]))</span>
                <span class="n">newmeta_h</span><span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newh</span>
                <span class="n">meta_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">newmeta_h</span><span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span>
                                                <span class="s1">&#39;_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">collapse</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="ne">UserWarning</span><span class="p">(</span>
                            <span class="s1">&#39;Multiple VDJ contigs mapping to the same cell barcode and/or query dtype is </span><span class="si">{}</span><span class="s1">. Ignoring collapse = True.&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meta_h</span><span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span>
                                           <span class="s1">&#39;_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">meta_h</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_l</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">meta_h</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span>
    <span class="n">df_</span> <span class="o">=</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">:</span>
            <span class="n">df_hl</span><span class="p">[</span><span class="n">H</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">meta_h</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">locus_dict2</span><span class="p">[</span><span class="n">locus</span><span class="p">])):</span>
                    <span class="n">L</span> <span class="o">=</span> <span class="n">locus_dict2</span><span class="p">[</span><span class="n">locus</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                    <span class="n">df_hl</span><span class="p">[</span><span class="n">L</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">meta_l</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">L</span> <span class="o">=</span> <span class="n">locus_dict4</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>
                <span class="n">df_hl</span><span class="p">[</span><span class="n">L</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">meta_l</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_res_hl</span> <span class="o">=</span> <span class="n">df_hl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">res_</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">result_dict_hl</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">collapse</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df_res_hl</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df_hl</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">res_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                                    <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                                        <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">df_hl</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                                    <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">l</span>
                                <span class="p">]))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">res_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                                        <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">df_hl</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                                    <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">l</span>
                                <span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">res_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                                    <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_hl</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">l</span>
                                <span class="p">]))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">res_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_hl</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">l</span>
                                <span class="p">]))</span>
                    <span class="n">df_res_hl</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">query</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                    <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">df_res_hl</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">query</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span>
                        <span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">result_dict_</span> <span class="o">=</span> <span class="p">{</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">H</span><span class="p">:</span> <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">H</span><span class="p">]}</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">locus_dict2</span><span class="p">[</span><span class="n">locus</span><span class="p">])):</span>
                        <span class="n">L</span> <span class="o">=</span> <span class="n">locus_dict2</span><span class="p">[</span><span class="n">locus</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                        <span class="n">result_dict_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">L</span><span class="p">:</span> <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">L</span><span class="p">]})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result_dict_</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_VDJ&#39;</span><span class="p">:</span> <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">H</span><span class="p">],</span>
                        <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_VJ&#39;</span><span class="p">:</span> <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">L</span><span class="p">]</span>
                    <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df_res_hl</span><span class="p">:</span>
                    <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_res_hl</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_res</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">q_res</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">collapse</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
                        <span class="n">q_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                            <span class="n">qq</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">qq</span> <span class="o">==</span> <span class="n">qq</span>
                        <span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">q_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">qq</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">qq</span> <span class="o">==</span> <span class="n">qq</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">q_res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">qq</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">qq</span> <span class="o">==</span> <span class="n">qq</span><span class="p">])</span>
            <span class="n">df_res</span><span class="p">[</span><span class="n">query</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_res</span>
            <span class="n">result_dict_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">df_res</span><span class="p">[</span><span class="n">query</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result_dict_</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">df_</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_</span><span class="p">}</span>
    <span class="n">rs_dict1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;[HL]&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;[AB]&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;[GD]&#39;</span><span class="p">}</span>
    <span class="n">rs_dict2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;IG[HKL]&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;TR[AB]&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;TR[GD]&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="s1">&#39;_sequence_id_&#39;</span> <span class="o">+</span> <span class="n">rs_dict2</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="s1">&#39;_sequence_id_&#39;</span> <span class="o">+</span> <span class="n">rs_dict1</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>
    <span class="n">final_result_</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">split</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collapse</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result_dict_hl</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="n">final_result</span> <span class="o">=</span> <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result_dict_hl</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_sequence_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span>
                    <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
                        <span class="n">final_result_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_dict_hl</span><span class="p">[</span><span class="n">H</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">final_result_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">[</span><span class="n">H</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
                        <span class="n">final_result_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                            <span class="n">result_dict_hl</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">final_result_h</span> <span class="o">=</span> <span class="n">final_result_h</span><span class="p">[</span><span class="n">meta_h</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">final_result_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                            <span class="n">result_dict_</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">final_result_h</span> <span class="o">=</span> <span class="n">final_result_h</span><span class="p">[</span><span class="n">meta_h</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">final_result_h</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span>
                    <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_VDJ_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result_h</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
                        <span class="n">final_result_l</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                            <span class="n">result_dict_hl</span><span class="p">[</span><span class="n">locus_dict4</span><span class="p">[</span><span class="n">locus</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">final_result_l</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                            <span class="n">result_dict_</span><span class="p">[</span><span class="n">locus_dict4</span><span class="p">[</span><span class="n">locus</span><span class="p">]])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
                        <span class="n">final_result_l</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                            <span class="n">result_dict_hl</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">final_result_l</span> <span class="o">=</span> <span class="n">final_result_l</span><span class="p">[</span><span class="n">meta_l</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">final_result_l</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                            <span class="n">result_dict_</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">final_result_l</span> <span class="o">=</span> <span class="n">final_result_l</span><span class="p">[</span><span class="n">meta_l</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">final_result_l</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span>
                    <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_VJ_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result_l</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">final_result</span> <span class="o">=</span> <span class="n">final_result_h</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">final_result_l</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">result_dict_</span><span class="p">:</span>
                        <span class="n">final_result_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                            <span class="n">result_dict_</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
                        <span class="n">final_result_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span>
                                <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
                            <span class="p">]</span>
                        <span class="p">]</span>
                        <span class="n">final_result_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_[0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">final_result_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
                        <span class="p">]</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">final_result_</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">final_result_</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">final_result_</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">final_result_</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="ne">UserWarning</span><span class="p">(</span>
                                <span class="s1">&#39;Query dtype is </span><span class="si">{}</span><span class="s1">. Ignoring collapse = True.&#39;</span><span class="o">.</span>
                                <span class="nb">format</span><span class="p">(</span><span class="n">meta_h</span><span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span>
                                              <span class="s1">&#39;_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                          <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">query</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span>
                    <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
                    <span class="n">final_result_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                        <span class="n">result_dict_</span><span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_VDJ&#39;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
                    <span class="n">final_result_h</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_VDJ&#39;</span><span class="p">]</span>
                    <span class="n">final_result_l</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                        <span class="n">result_dict_</span><span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_VJ&#39;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
                    <span class="n">final_result_l</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_VJ&#39;</span><span class="p">]</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">final_result_h</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">final_result_l</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="ne">UserWarning</span><span class="p">(</span>
                                <span class="s1">&#39;Query dtype is </span><span class="si">{}</span><span class="s1">. Ignoring collapse = True.&#39;</span><span class="o">.</span>
                                <span class="nb">format</span><span class="p">(</span><span class="n">meta_h</span><span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span>
                                              <span class="s1">&#39;_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
                    <span class="n">final_result_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                            <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">final_result_h</span> <span class="o">=</span> <span class="n">final_result_h</span><span class="p">[</span><span class="n">meta_h</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">final_result_h</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_VDJ_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result_h</span><span class="o">.</span><span class="n">columns</span>
                        <span class="p">]</span>
                    <span class="p">]</span>
                    <span class="n">final_result_l</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                            <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">final_result_l</span> <span class="o">=</span> <span class="n">final_result_l</span><span class="p">[</span><span class="n">meta_l</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">final_result_l</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_VJ_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result_l</span><span class="o">.</span><span class="n">columns</span>
                        <span class="p">]</span>
                    <span class="p">]</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">final_result_h</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">final_result_l</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">collapse</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                          <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
                    <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span>
                        <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                          <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
                    <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span>
                        <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                    <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                          <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
                    <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                          <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
                    <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">collapse</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                          <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_sequence_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span>
                        <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                          <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span>
                        <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                    <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="ne">UserWarning</span><span class="p">(</span>
                            <span class="s1">&#39;Query dtype is </span><span class="si">{}</span><span class="s1">. Ignoring collapse = True and split = False.&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meta_h</span><span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span>
                                           <span class="s1">&#39;_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_l</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                          <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_sequence_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span>
                        <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">typedict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">locus_dict3</span><span class="p">[</span><span class="n">locus</span><span class="p">]:</span> <span class="s1">&#39;VDJ&#39;</span><span class="p">,</span>
                        <span class="n">locus_dict4</span><span class="p">[</span><span class="n">locus</span><span class="p">]:</span> <span class="s1">&#39;VJ&#39;</span>
                    <span class="p">}</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                          <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">typedict</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">l</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span>
                        <span class="p">]</span>
                    <span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">final_result</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">retrieve_result_dict_singular</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                  <span class="n">meta_h</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                  <span class="n">locus</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;ig&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;tr-gd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ig&#39;</span><span class="p">,</span>
                                  <span class="n">collapse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                  <span class="n">combine</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>

    <span class="n">df_hl</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">locus_dict1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;IGH&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;TRB&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;TRD&#39;</span><span class="p">}</span>
    <span class="n">locus_dict3</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">}</span>

    <span class="n">H</span> <span class="o">=</span> <span class="n">locus_dict3</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">meta_h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">collapse</span><span class="p">:</span>
            <span class="n">newmeta_h</span> <span class="o">=</span> <span class="n">meta_h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
                <span class="n">newh</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">meta_h</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">newh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                            <span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">newmeta_h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="n">h</span>
                        <span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">newh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">newmeta_h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="n">h</span>
                        <span class="p">]))</span>
                <span class="n">newmeta_h</span><span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newh</span>
                <span class="n">meta_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">newmeta_h</span><span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span>
                                                <span class="s1">&#39;_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">collapse</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="ne">UserWarning</span><span class="p">(</span>
                            <span class="s1">&#39;Multiple VDJ contigs mapping to the same cell barcode and/or query dtype is </span><span class="si">{}</span><span class="s1">. Ignoring collapse = True.&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meta_h</span><span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span>
                                           <span class="s1">&#39;_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>

    <span class="n">metadata_</span> <span class="o">=</span> <span class="n">meta_h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">df_</span> <span class="o">=</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
        <span class="n">df_res</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">q_res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">collapse</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">q_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                            <span class="n">qq</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">qq</span> <span class="o">==</span> <span class="n">qq</span>
                        <span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">q_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">qq</span><span class="p">)</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">qq</span> <span class="o">==</span> <span class="n">qq</span>
                        <span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">q_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">qq</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">qq</span> <span class="o">==</span> <span class="n">qq</span><span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">q_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">qq</span><span class="p">)</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">qq</span> <span class="o">==</span> <span class="n">qq</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">q_res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">qq</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">qq</span> <span class="o">==</span> <span class="n">qq</span><span class="p">])</span>
        <span class="n">df_res</span><span class="p">[</span><span class="n">query</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_res</span>
        <span class="n">result_dict_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">df_res</span><span class="p">[</span><span class="n">query</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result_dict_</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">df_</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_</span><span class="p">}</span>

    <span class="n">rs_dict1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ig&#39;</span><span class="p">:</span> <span class="s1">&#39;[H]&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">:</span> <span class="s1">&#39;[B]&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">:</span> <span class="s1">&#39;[D]&#39;</span><span class="p">}</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="s1">&#39;_sequence_id_&#39;</span> <span class="o">+</span> <span class="n">rs_dict1</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span>
    <span class="n">final_result_</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">type_check</span><span class="p">(</span><span class="n">meta_h</span><span class="p">,</span> <span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collapse</span><span class="p">:</span>
            <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collapse</span><span class="p">:</span>
            <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                  <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="ne">UserWarning</span><span class="p">(</span>
                        <span class="s1">&#39;Query dtype is </span><span class="si">{}</span><span class="s1">. Ignoring collapse = True and split = False.&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meta_h</span><span class="p">[</span><span class="s1">&#39;sequence_id_&#39;</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
            <span class="n">typedict</span> <span class="o">=</span> <span class="p">{</span><span class="n">locus_dict3</span><span class="p">[</span><span class="n">locus</span><span class="p">]:</span> <span class="s1">&#39;VDJ&#39;</span><span class="p">}</span>
            <span class="n">final_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict_</span><span class="p">,</span>
                                                  <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">typedict</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">l</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">final_result</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">]</span>
            <span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">final_result</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">initialize_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">locus_</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">clonekey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">collapse_alleles</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dandelion</span><span class="p">:</span>
    <span class="n">init_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">init_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="n">col</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;split&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;collapse&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;combine&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;locus&#39;</span><span class="p">:</span> <span class="n">locus_</span><span class="p">,</span>
                <span class="s1">&#39;split_locus&#39;</span><span class="p">:</span> <span class="kc">False</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">if</span> <span class="n">clonekey</span> <span class="ow">in</span> <span class="n">init_dict</span><span class="p">:</span>
        <span class="n">init_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="n">clonekey</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;split&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;collapse&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;combine&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;locus&#39;</span><span class="p">:</span> <span class="n">locus_</span><span class="p">,</span>
                <span class="s1">&#39;split_locus&#39;</span><span class="p">:</span> <span class="kc">False</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">if</span> <span class="s1">&#39;sample_id&#39;</span> <span class="ow">in</span> <span class="n">init_dict</span><span class="p">:</span>
        <span class="n">init_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;sample_id&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;split&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;collapse&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;combine&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;locus&#39;</span><span class="p">:</span> <span class="n">locus_</span><span class="p">,</span>
                <span class="s1">&#39;split_locus&#39;</span><span class="p">:</span> <span class="kc">False</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="n">meta_</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">init_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span><span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]])):</span>
            <span class="n">init_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">meta_</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">v</span><span class="p">)</span>

    <span class="n">tmp_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">meta_</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;locus_VDJ&#39;</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="p">:</span>
        <span class="n">suffix_h</span> <span class="o">=</span> <span class="s1">&#39;_VDJ&#39;</span>
        <span class="n">suffix_l</span> <span class="o">=</span> <span class="s1">&#39;_VJ&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">suffix_h</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">suffix_l</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">clonekey</span> <span class="ow">in</span> <span class="n">init_dict</span><span class="p">:</span>
        <span class="n">tmp_metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">)</span>

        <span class="n">clones</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tmpclones</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clones</span><span class="p">:</span>
            <span class="k">while</span> <span class="s1">&#39;unassigned&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">i</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;unassigned&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">tmpclones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">tmpclones</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">cmp_str_emptylast</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmpclones</span>
        <span class="p">]</span>
        <span class="n">tmpclonesdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tmp_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">tmpclones</span><span class="p">))</span>
        <span class="n">tmp_metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tmpclonesdict</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span>
        <span class="n">clone_size</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;&quot;</span> <span class="ow">in</span> <span class="n">clone_size</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">clone_size</span> <span class="o">=</span> <span class="n">clone_size</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">clonesize_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">clone_size</span><span class="p">)</span>
        <span class="n">size_of_clone</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">clonesize_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">size_of_clone</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">size_of_clone</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">),</span> <span class="s1">&#39;clone_size&#39;</span><span class="p">]</span>
        <span class="n">size_of_clone</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_by_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_of_clone</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">size_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">size_of_clone</span><span class="p">[</span><span class="n">clonekey</span><span class="p">],</span>
                <span class="n">size_of_clone</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_by_size&#39;</span><span class="p">]))</span>
        <span class="n">size_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">})</span>
        <span class="n">tmp_metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_by_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">size_dict</span><span class="p">[</span><span class="n">c_</span><span class="p">])</span> <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)]))))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">size_dict</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span>
        <span class="p">]</span>
        <span class="n">tmp_metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39;_by_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span>
                                                <span class="s1">&#39;_by_size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">tmp_metadata</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="p">[</span>
            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_by_size&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="n">cl</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">tmp_metadata</span> <span class="k">if</span> <span class="n">cl</span> <span class="ow">not</span> <span class="ow">in</span>
                <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_by_size&#39;</span><span class="p">]</span>
            <span class="p">]]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span> <span class="o">+</span>
                        <span class="n">suffix_h</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span> <span class="o">+</span>
                                                             <span class="n">suffix_l</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_only&#39;</span>
            <span class="k">elif</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_only&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unassigned&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unassigned&#39;</span>
    <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;status_summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Multi&#39;</span> <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span> <span class="o">+</span>
                            <span class="n">suffix_h</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span> <span class="o">+</span>
                                                          <span class="n">suffix_h</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span> <span class="o">+</span>
                        <span class="n">suffix_h</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span> <span class="o">+</span>
                                                             <span class="n">suffix_l</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span>
                                <span class="s1">&#39;productive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span>
                                                                 <span class="s1">&#39;productive&#39;</span> <span class="o">+</span>
                                                                 <span class="n">suffix_h</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unassigned&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unassigned&#39;</span>
    <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;productive_summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Multi&#39;</span> <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;productive&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">conversion_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;igha&#39;</span><span class="p">:</span> <span class="s1">&#39;IgA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;igha1&#39;</span><span class="p">:</span> <span class="s1">&#39;IgA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;igha2&#39;</span><span class="p">:</span> <span class="s1">&#39;IgA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighd&#39;</span><span class="p">:</span> <span class="s1">&#39;IgD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighe&#39;</span><span class="p">:</span> <span class="s1">&#39;IgE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighg&#39;</span><span class="p">:</span> <span class="s1">&#39;IgG&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighg1&#39;</span><span class="p">:</span> <span class="s1">&#39;IgG&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighg2&#39;</span><span class="p">:</span> <span class="s1">&#39;IgG&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighg3&#39;</span><span class="p">:</span> <span class="s1">&#39;IgG&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighg4&#39;</span><span class="p">:</span> <span class="s1">&#39;IgG&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighg2a&#39;</span><span class="p">:</span> <span class="s1">&#39;IgG&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighg2b&#39;</span><span class="p">:</span> <span class="s1">&#39;IgG&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighg2c&#39;</span><span class="p">:</span> <span class="s1">&#39;IgG&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ighm&#39;</span><span class="p">:</span> <span class="s1">&#39;IgM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;igkc&#39;</span><span class="p">:</span> <span class="s1">&#39;IgK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;iglc&#39;</span><span class="p">:</span> <span class="s1">&#39;IgL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;iglc1&#39;</span><span class="p">:</span> <span class="s1">&#39;IgL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;iglc2&#39;</span><span class="p">:</span> <span class="s1">&#39;IgL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;iglc3&#39;</span><span class="p">:</span> <span class="s1">&#39;IgL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;iglc4&#39;</span><span class="p">:</span> <span class="s1">&#39;IgL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;iglc5&#39;</span><span class="p">:</span> <span class="s1">&#39;IgL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;iglc6&#39;</span><span class="p">:</span> <span class="s1">&#39;IgL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;iglc7&#39;</span><span class="p">:</span> <span class="s1">&#39;IgL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;na&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nan&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;none&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trac&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trbc&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trbc1&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trbc2&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trdc&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trgc&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trgc1&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trgc2&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trgc3&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trgc4&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;unassigned&#39;</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">isotype</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;c_call&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">isotype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="n">conversion_dict</span><span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)])</span>
                    <span class="p">]</span>
                <span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isotype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion_dict</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isotype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;unassigned&#39;</span><span class="p">)</span>
    <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;isotype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isotype</span>
    <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;isotype_summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">i</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;IgM|IgD&#39;</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;IgD|IgM&#39;</span> <span class="k">else</span> <span class="s1">&#39;Multi&#39;</span> <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="n">i</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;isotype&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">vdj_gene_calls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">,</span> <span class="s1">&#39;d_call&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">collapse_alleles</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vdj_gene_calls</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                        <span class="n">tmp_metadata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">yy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))</span>
                                <span class="k">for</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                                    <span class="nb">set</span><span class="p">([</span>
                                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                                    <span class="p">]))</span>
                            <span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                        <span class="p">]</span>
    <span class="n">multi</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">multic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">hv_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span>
                                      <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hv_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">hv_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hv_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hj_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;j_call&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">hj_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;j_call&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">lv_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span>
                                      <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lv_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">lv_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lv_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lj_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;j_call&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">lj_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;j_call&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hc_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">hc_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lc_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">lc_</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span><span class="p">]</span>
        <span class="n">multi_h</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">multi_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">multi_hc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">multi_lc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hv_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">multi_h</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span> <span class="o">+</span> <span class="s1">&#39;_v&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hj_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">multi_h</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span> <span class="o">+</span> <span class="s1">&#39;_j&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lv_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">multi_l</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span> <span class="o">+</span> <span class="s1">&#39;_v&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lj_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">multi_l</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span> <span class="o">+</span> <span class="s1">&#39;_j&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hc_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;isotype_summary&#39;</span><span class="p">]</span>
                    <span class="o">==</span> <span class="s1">&#39;IgM|IgD&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;isotype_summary&#39;</span><span class="p">]</span>
                                      <span class="o">==</span> <span class="s1">&#39;IgD|IgM&#39;</span><span class="p">):</span>
                <span class="n">multi_hc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tmp_metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;isotype_summary&#39;</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multi_hc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span> <span class="o">+</span> <span class="s1">&#39;_c&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">multi_lc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi&#39;</span> <span class="o">+</span> <span class="n">suffix_l</span> <span class="o">+</span> <span class="s1">&#39;_c&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_hc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">multi_hc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Single&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_h</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">multi_h</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Single&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lv_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lj_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lv_</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lj_</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_l</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">multi_l</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Single&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lc_</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_lc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">multi_lc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Single&#39;</span><span class="p">])</span>
        <span class="n">multih</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">multi_h</span><span class="p">))))</span>
        <span class="n">multil</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">multi_l</span><span class="p">))))</span>
        <span class="n">multihc</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">multi_hc</span><span class="p">))))</span>
        <span class="n">multilc</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">multi_lc</span><span class="p">))))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multih</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multil</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">multih</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">multil</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">multih</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unassigned&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multihc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multilc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">multic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">multihc</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">multilc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">multihc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">multic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unassigned&#39;</span>
    <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;vdj_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">multi</span><span class="p">)</span>
    <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;vdj_status_summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Multi&#39;</span> <span class="k">if</span> <span class="s1">&#39;Multi&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="s1">&#39;Single&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;vdj_status&#39;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">tmp_metadata</span><span class="p">[</span><span class="s1">&#39;constant_status_summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Multi&#39;</span> <span class="k">if</span> <span class="s1">&#39;Multi&#39;</span> <span class="o">+</span> <span class="n">suffix_h</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="s1">&#39;Single&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">multic</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<div class="viewcode-block" id="update_metadata"><a class="viewcode-back" href="../../../modules/dandelion.utilities.update_metadata.html#dandelion.update_metadata">[docs]</a><span class="k">def</span> <span class="nf">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Dandelion</span><span class="p">,</span>
                    <span class="n">retrieve</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">locus</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;ig&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-ab&#39;</span><span class="p">,</span> <span class="s1">&#39;tr-gd&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">clone_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">split</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">collapse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">combine</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">split_locus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">collapse_alleles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">reinitialize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dandelion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A `Dandelion` initialisation function to update and populate the `.metadata` slot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion</span>
<span class="sd">        `Dandelion` object.</span>
<span class="sd">    retrieve : str, sequence, optional</span>
<span class="sd">        Column name in `.data` slot to retrieve and update the metadata.</span>
<span class="sd">    locus : str, optional</span>
<span class="sd">        Mode for creating metadata. Accepts one of &#39;ig&#39;, &#39;tr-ab&#39; or &#39;tr-gd&#39;. None defaults to &#39;ig&#39;.</span>
<span class="sd">    clone_key : str, optional</span>
<span class="sd">        Column name of clone id. None defaults to &#39;clone_id&#39;.</span>
<span class="sd">    split : bool</span>
<span class="sd">        Only applies if retrieve option is not None. Returns the retrieval splitted into two columns, e.g. one for heavy and one for light chains in BCR data, if True. Interacts with collapse, combine and split_locus options.</span>
<span class="sd">    collapse : bool</span>
<span class="sd">        Only applies if retrieve option is not None. Returns the retrieval as a collapsed entry if multiple entries are found (e.g. v genes from multiple contigs) where each entry will be separated by a &#39;|&#39; if True. Interacts with split, combine and split_locus options.</span>
<span class="sd">    combine : bool</span>
<span class="sd">        Only applies if retrieve option is not None. Returns the retrieval as a collapsed entry with only unique entries (separated by a &#39;|&#39; if multiple are found). Interacts with split, collapse, and split_locus options.</span>
<span class="sd">    split_locus : bool</span>
<span class="sd">        Only applies if retrieve option is not None. Similar to split except it returns the retrieval splitted into multiple columns corresponding to each unique element in the &#39;locus&#39; column (e.g. IGH, IGK, IGL). Interacts with split, collapse, and combine options.</span>
<span class="sd">    collapse_alleles : bool</span>
<span class="sd">        Returns the V-D-J genes with allelic calls if False.</span>
<span class="sd">    reinitialize : bool</span>
<span class="sd">        Whether or not to reinitialize the current metadata. Useful when updating older versions of `dandelion` to newer version.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Whether or not to print warning messages when constructing object.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `Dandelion` object with `.metadata` slot initialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">locus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">locus_</span> <span class="o">=</span> <span class="s1">&#39;ig&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">locus_</span> <span class="o">=</span> <span class="n">locus</span>

    <span class="k">if</span> <span class="n">clone_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clonekey</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clonekey</span> <span class="o">=</span> <span class="n">clone_key</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;sequence_id&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span> <span class="s1">&#39;v_call&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call&#39;</span><span class="p">,</span>
        <span class="s1">&#39;c_call&#39;</span><span class="p">,</span> <span class="s1">&#39;duplicate_count&#39;</span><span class="p">,</span> <span class="s1">&#39;junction_aa&#39;</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;duplicate_count&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;duplicate_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;umi_count&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;umi_count&#39;</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;duplicate_count&#39;</span> <span class="k">else</span> <span class="n">x</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;umi_count&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to initialize metadata due to missing keys. Please ensure either &#39;umi_count&#39; or &#39;duplicate_count&#39; is in the input data.&quot;</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Unable to initialize metadata due to missing keys. Please ensure the input data contains all the following columns: </span><span class="si">{}</span><span class="s1">&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;sample_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span>

    <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;v_call&#39;</span> <span class="k">else</span> <span class="n">x</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">]:</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">clonekey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">clonekey</span><span class="p">])):</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">clonekey</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span>

    <span class="n">metadata_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">metadata_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">reinitialize</span><span class="p">:</span>
        <span class="n">initialize_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">locus_</span><span class="p">,</span> <span class="n">clonekey</span><span class="p">,</span> <span class="n">collapse_alleles</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="p">)</span>

    <span class="n">tmp_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">retrieve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">retrieve</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">retrieve</span> <span class="o">=</span> <span class="p">[</span><span class="n">retrieve</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">retrieve</span><span class="p">:</span>
            <span class="n">ret_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="n">ret</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;split&#39;</span><span class="p">:</span> <span class="n">split</span><span class="p">,</span>
                    <span class="s1">&#39;collapse&#39;</span><span class="p">:</span> <span class="n">collapse</span><span class="p">,</span>
                    <span class="s1">&#39;combine&#39;</span><span class="p">:</span> <span class="n">combine</span><span class="p">,</span>
                    <span class="s1">&#39;locus&#39;</span><span class="p">:</span> <span class="n">locus_</span><span class="p">,</span>
                    <span class="s1">&#39;split_locus&#39;</span><span class="p">:</span> <span class="n">split_locus</span>
                <span class="p">}</span>
            <span class="p">})</span>

        <span class="n">vdj_gene_ret</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v_call&#39;</span><span class="p">,</span> <span class="s1">&#39;d_call&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call&#39;</span><span class="p">]</span>

        <span class="n">retrieve_</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ret_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">retrieve_</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                 <span class="n">query</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                                                 <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                                 <span class="o">**</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot retrieve </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> : Unknown column name.&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">ret_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">retrieve_</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">collapse_alleles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ret_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vdj_gene_ret</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ret_metadata</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                            <span class="n">ret_metadata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                                    <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">yy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))</span>
                                    <span class="k">for</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                                        <span class="nb">set</span><span class="p">([</span>
                                            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                                        <span class="p">]))</span>
                                <span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ret_metadata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                            <span class="p">]</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ret_metadata</span><span class="p">:</span>
            <span class="n">tmp_metadata</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ret_metadata</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">tmp_metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="load_data"><a class="viewcode-back" href="../../../modules/dandelion.utilities.load_data.html#dandelion.load_data">[docs]</a><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in or copy dataframe object and set sequence_id as index without dropping.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : DataFrame, str</span>
<span class="sd">        file path to .tsv file or pandas DataFrame object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas DataFrame object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">obj_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Either input is not of &lt;class &#39;pandas.core.frame.DataFrame&#39;&gt; or file does not exist.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;sequence_id&#39;</span> <span class="ow">in</span> <span class="n">obj_</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">obj_</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;&#39;sequence_id&#39; not found in columns of input&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">obj_</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, zktuong.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>