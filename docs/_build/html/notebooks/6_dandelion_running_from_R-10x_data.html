

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Running from R &mdash; dandelion  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/dandelion_logo.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Analyzing TCR data" href="7_dandelion_TCR_data_10x_data.html" />
    <link rel="prev" title="Dandelion class" href="0_dandelion_primer.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/dandelion_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#required-database">Required database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#external-softwares">External softwares</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#basic-requirements">Basic requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#acknowledgements">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#citation">Citation</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="singularity_preprocessing.html">Dandelion preprocessing with Singularity</a></li>
<li class="toctree-l1"><a class="reference internal" href="gamma_delta.html">Dandelion for TCR gamma/delta reannotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="1_dandelion_preprocessing-10x_data.html">Pre-processing (Re-annotation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_dandelion_filtering-10x_data.html">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="1b_dandelion_noreannotation-10x_data.html">Reading 10X Cell Ranger output directly</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_dandelion_findingclones-10x_data.html">BCR clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="1c_dandelion_scirpy.html">Interoperability with <code class="docutils literal notranslate"><span class="pre">scirpy</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="4_dandelion_visualization-10x_data.html">Visualizing BCR data</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_dandelion_diversity_and_mutation-10x_data.html">Calculating diversity and mutation</a></li>
<li class="toctree-l1"><a class="reference internal" href="0_dandelion_primer.html"><em>Dandelion</em> class</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Running from R</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Foreword">Foreword</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Pre-processing">Pre-processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Step-1:-Formatting-the-headers-of-the-Cell-Ranger-fasta-file">Step 1: Formatting the headers of the Cell Ranger fasta file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Step-2:-Reannotate-the-V/D/J-genes-with-igblastn.">Step 2: Reannotate the V/D/J genes with <em>igblastn</em>.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Step-3-:-Reassigning-heavy-chain-V-gene-alleles-(optional-but-recommended)">Step 3 : Reassigning heavy chain V gene alleles <em>(optional but recommended)</em></a></li>
<li class="toctree-l3"><a class="reference internal" href="#Step-4:-Assigning-constant-region-calls">Step 4: Assigning constant region calls</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Step-5:-Quantify-mutations-(optional).">Step 5: Quantify mutations <em>(optional)</em>.</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Filtering">Filtering</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Run-ddl$pp$filter_contigs">Run <code class="docutils literal notranslate"><span class="pre">ddl$pp$filter_contigs</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Finding-clones">Finding clones</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calculating-size-of-clones">Calculating size of clones</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Generate-BCR-network-visualization">Generate BCR network visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Integrating-with-Seurat">Integrating with Seurat</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Transfer-Dandelion-to-AnnData">Transfer <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> to <code class="docutils literal notranslate"><span class="pre">AnnData</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#New-Session:-Transfer-AnnData-to-Seurat">New Session: Transfer <code class="docutils literal notranslate"><span class="pre">AnnData</span></code> to <code class="docutils literal notranslate"><span class="pre">Seurat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#Plotting-BCR-network">Plotting BCR network</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="7_dandelion_TCR_data_10x_data.html">Analyzing TCR data</a></li>
</ul>
<p class="caption"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Preprocessing: <cite>pp</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-dandelion.preprocessing.external">Preprocessing (external): <cite>pp.external</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-dandelion.tools">Tools: <cite>tl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-dandelion.plotting">Plotting: <cite>pl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-dandelion.utilities">Utilities: <cite>utl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-dandelion.Dandelion">Dandelion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-dandelion.logging">Logging</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">dandelion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../tutorial_short.html">&lt;no title&gt;</a> &raquo;</li>
        
      <li>Running from R</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/notebooks/6_dandelion_running_from_R-10x_data.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Running-from-R">
<h1>Running from R<a class="headerlink" href="#Running-from-R" title="Permalink to this headline">¶</a></h1>
<img alt="dandelion_logo" src="../_images/dandelion_logo_illustration.png" />
<div class="section" id="Foreword">
<h2>Foreword<a class="headerlink" href="#Foreword" title="Permalink to this headline">¶</a></h2>
<p><strong>dandelion</strong> is written in <code class="docutils literal notranslate"><span class="pre">python==3.7.6</span></code> and it is primarily a single-cell BCR-seq analysis package. It makes use of some tools from the fantastic <a class="reference external" href="https://immcantation.readthedocs.io/">immcantation suite</a> and the main idea is that it implements a workflow for the pre-processing and exploratory stages with integrated use of tools from <em>immcantation</em> for the BCR side of things and analysis tools from <a class="reference external" href="https://scanpy.readthedocs.io/">scanpy</a> for the RNA-seq side of things. I hope to be
able to introduce some new single-cell BCR-seq exploratory tools down the road through <em>dandelion</em>.</p>
<p><strong>dandelion</strong> can be run in <code class="docutils literal notranslate"><span class="pre">R</span></code> through <code class="docutils literal notranslate"><span class="pre">reticulate</span></code>. This section will try to replicate the examples using <code class="docutils literal notranslate"><span class="pre">R</span></code>.</p>
<p>There are some issues with the conversion of dataframes between python and R so I would <strong>not</strong> recommend saving the final <code class="docutils literal notranslate"><span class="pre">AnnData</span></code> object as a final out file, but only use this to help generate the intermediate files from the BCR processing and the plots. Please store your original analysis some where safe. I would also skip quantify mutation step due to conflicts between rpy2 and reticulate.</p>
<p>For more details, please refer to the original python tutorial.</p>
<p>Let’s start!</p>
<p>First, install reticulate via if you don’t already have it:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;reticulate&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Because we are managing the packages through a conda virtual environment, we will need to point reticulate to the right python paths.</p>
<p>Currently, rpy2&gt;=3.4 or &gt;=3.3.2,&lt;3.3.5 works.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">library</span><span class="p">(</span><span class="n">reticulate</span><span class="p">)</span>
<span class="nf">use_condaenv</span><span class="p">(</span><span class="s">&#39;dandelion&#39;</span><span class="p">)</span>
<span class="c1"># or use Sys.setenv(RETICULATE_PYTHON = conda_python(envname=&#39;dandelion&#39;))</span>
</pre></div>
</div>
</div>
<p>You can check if the python config is set up properly with <code class="docutils literal notranslate"><span class="pre">py_config()</span></code></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">py_config</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
python:         /Users/kt16/miniconda3/envs/dandelion/bin/python
libpython:      /Users/kt16/miniconda3/envs/dandelion/lib/libpython3.7m.dylib
pythonhome:     /Users/kt16/miniconda3/envs/dandelion:/Users/kt16/miniconda3/envs/dandelion
version:        3.7.8 | packaged by conda-forge | (default, Nov 17 2020, 23:22:07)  [Clang 10.0.1 ]
numpy:          /Users/kt16/miniconda3/envs/dandelion/lib/python3.7/site-packages/numpy
numpy_version:  1.20.1

NOTE: Python version was forced by RETICULATE_PYTHON
</pre></div></div>
</div>
<p>To proceed with the analyses, we first change the working directory and also import the dandelion module.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># change directory to somewhere more workable</span>
<span class="nf">setwd</span><span class="p">(</span><span class="s">&#39;/Users/kt16/Downloads/dandelion_tutorial/&#39;</span><span class="p">)</span>
<span class="n">ddl</span> <span class="o">=</span> <span class="nf">import</span><span class="p">(</span><span class="s">&#39;dandelion&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>As per reticulate convention, python <code class="docutils literal notranslate"><span class="pre">.</span></code> operators are to be swaped with <code class="docutils literal notranslate"><span class="pre">$</span></code> in R.</p>
</div>
<div class="section" id="Pre-processing">
<h2>Pre-processing<a class="headerlink" href="#Pre-processing" title="Permalink to this headline">¶</a></h2>
<p>To being the BCR preprocessing, the minimum files you require are the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">filtered_contig.fasta</span>
<span class="go">filtered_contig_annotations.csv</span>
</pre></div>
</div>
<div class="section" id="Step-1:-Formatting-the-headers-of-the-Cell-Ranger-fasta-file">
<h3>Step 1: Formatting the headers of the Cell Ranger fasta file<a class="headerlink" href="#Step-1:-Formatting-the-headers-of-the-Cell-Ranger-fasta-file" title="Permalink to this headline">¶</a></h3>
<p>This will do the following: 1) add the prefix provided to every sequence header</p>
<ol class="arabic simple" start="2">
<li><p>add the prefix provided to every contig_id in the annotation.csv file</p></li>
<li><p>create a folder called <code class="docutils literal notranslate"><span class="pre">dandelion/data</span></code> (if left as default) and saves a copy of these files in that directory.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># the first option is a list of fasta files to format and the second option is the list of prefix to add to each file.</span>
<span class="n">samples</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;sc5p_v2_hs_PBMC_1k&#39;</span><span class="p">,</span> <span class="s">&#39;sc5p_v2_hs_PBMC_10k&#39;</span><span class="p">,</span> <span class="s">&#39;vdj_v1_hs_pbmc3&#39;</span><span class="p">,</span> <span class="s">&#39;vdj_nextgem_hs_pbmc3&#39;</span><span class="p">)</span>
<span class="n">ddl</span><span class="o">$</span><span class="n">pp</span><span class="o">$</span><span class="nf">format_fastas</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Step-2:-Reannotate-the-V/D/J-genes-with-igblastn.">
<h3>Step 2: Reannotate the V/D/J genes with <em>igblastn</em>.<a class="headerlink" href="#Step-2:-Reannotate-the-V/D/J-genes-with-igblastn." title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">ddl$pp$reannotate_genes</span></code> uses <a class="reference external" href="https://changeo.readthedocs.io/en/stable/examples/10x.html">changeo</a>’s scripts to call <em>igblastn</em> to reannotate the fasta files. Depending on the <code class="docutils literal notranslate"><span class="pre">fileformat</span></code> option, it will parse out as either an <code class="docutils literal notranslate"><span class="pre">airr</span></code> (default) or <code class="docutils literal notranslate"><span class="pre">changeo</span></code>-legacy TSV file. Importantly, with the recent update to changeo v1.0.0, all the column headers, including <em>changeo</em> format, are now adhereing to the <a class="reference external" href="http://docs.airr-community.org/">AIRR</a> standard (lowercase and some column
name changes). Specifying <code class="docutils literal notranslate"><span class="pre">extended</span> <span class="pre">=</span> <span class="pre">True</span></code> will return the additional 10x annotation of V/D/J genes but they are unnecessary at this stage.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">ddl</span><span class="o">$</span><span class="n">pp</span><span class="o">$</span><span class="nf">reannotate_genes</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>you should see something like this in the terminal:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Assigning genes :   0%|                                        | 0/4 [00:00&lt;?, ?it/s]</span>
<span class="go">START&gt; AssignGenes</span>
<span class="go"> COMMAND&gt; igblast</span>
<span class="go"> VERSION&gt; 1.15.0</span>
<span class="go">    FILE&gt; sc5p_v2_hs_PBMC_10k_b_filtered_contig.fasta</span>
<span class="go">ORGANISM&gt; human</span>
<span class="go">    LOCI&gt; ig</span>
<span class="go">   NPROC&gt; 4</span>

<span class="go">PROGRESS&gt; 12:30:37 |Running IgBLAST          | 0.0 min</span>
</pre></div>
</div>
</div>
<div class="section" id="Step-3-:-Reassigning-heavy-chain-V-gene-alleles-(optional-but-recommended)">
<h3>Step 3 : Reassigning heavy chain V gene alleles <em>(optional but recommended)</em><a class="headerlink" href="#Step-3-:-Reassigning-heavy-chain-V-gene-alleles-(optional-but-recommended)" title="Permalink to this headline">¶</a></h3>
<p>Next, we use <em>immcantation’s TIgGER</em> method to reassign allelic calls for heavy chain V genes with <code class="docutils literal notranslate"><span class="pre">pp.reassign_alleles</span></code>. As stated in TIgGER’s <a class="reference external" href="https://tigger.readthedocs.io/en/stable/">website</a> and <a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/25675496/">manuscript</a>, <em>‘TIgGER is a computational method that significantly improves V(D)J allele assignments by first determining the complete set of gene segments carried by an individual (including novel alleles) from V(D)J-rearrange sequences. TIgGER
can then infer a subject’s genotype from these sequences, and use this genotype to correct the initial V(D)J allele assignments.’</em></p>
<p>This impact’s on how contigs are chosen for finding clones later so it is highly recommended to run it. It is also important when considering to do mutational analysis.</p>
<p>However, the main caveat is that this needs to be run on multiple samples from the same subject to allow for more information to be used to confidently assign a genotyped <em>v_call</em>. In this tutorial, I’m assuming the four samples can be split into two sets where sets of two corresponds to a different/single individual. So while important, this step can be skipped if you don’t have the samples to do this.</p>
<p><code class="docutils literal notranslate"><span class="pre">pp.reassign_alleles</span></code> requires the <code class="docutils literal notranslate"><span class="pre">combined_folder</span></code> option to be specified so that a merged/concatenated file can be produced for running TIgGER. The function also runs <code class="docutils literal notranslate"><span class="pre">pp.create_germlines</span></code> using the germline database updated with the germline corrections from TIgGER. The default behavior is that it will return a <code class="docutils literal notranslate"><span class="pre">germline_alignment_d_mask</span></code> column in the final output. This can be changed by specifying <code class="docutils literal notranslate"><span class="pre">germ_types</span></code> option; see
<a class="reference external" href="https://changeo.readthedocs.io/en/stable/tools/CreateGermlines.html#creategermlines">here</a> for other options.</p>
<p>Specifying <code class="docutils literal notranslate"><span class="pre">fileformat</span> <span class="pre">=</span> <span class="pre">'changeo'</span></code> will run on changeo formatted files if this was run earlier; but it’s probably best to stick to airr’s standard format.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># reassigning alleles on the first set of samples</span>
<span class="n">ddl</span><span class="o">$</span><span class="n">pp</span><span class="o">$</span><span class="nf">reassign_alleles</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">],</span> <span class="n">combined_folder</span> <span class="o">=</span> <span class="s">&#39;tutorial_scgp1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># reassigning alleles on the first set of samples</span>
<span class="n">ddl</span><span class="o">$</span><span class="n">pp</span><span class="o">$</span><span class="nf">reassign_alleles</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="m">3</span><span class="o">:</span><span class="m">4</span><span class="p">],</span> <span class="n">combined_folder</span> <span class="o">=</span> <span class="s">&#39;tutorial_scgp2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can see that most of the original ambiguous V calls have now been corrected and only a few remain. These will be flagged as multi later on and can probably be excluded from detailed analyses. For now, leaving them in the data will not impact on subsequent analyses.</p>
</div>
<div class="section" id="Step-4:-Assigning-constant-region-calls">
<h3>Step 4: Assigning constant region calls<a class="headerlink" href="#Step-4:-Assigning-constant-region-calls" title="Permalink to this headline">¶</a></h3>
<p>10X’s annotation.csv files provides a <em>c_gene</em> column, but rather than simply relying on 10x’s annotation, <a class="reference external" href="https://twitter.com/hamish_king">hk6</a> recommended using <a class="reference external" href="https://presto.readthedocs.io/en/version-0.5.3---license-change/tools/MaskPrimers.html">immcantation-presto’s MaskPrimers.py</a> with his custom primer list and I tested that; worked well but it took <strong>20 min</strong> for the first file (~6k contigs). It also only calls the constant region for the heavy chains. The processing speed for
MaskPrimers can be sped up with using the filtered file.</p>
<p>Anyway, as an alternative, I wrote a pre-processing function, <code class="docutils literal notranslate"><span class="pre">ddl$pp$assign_isotypes</span></code>, to use <em>blast</em> to annotate constant region calls for all contigs and retrieves the call, merging it with the tsv files. This function will simply overwrite the output from previous steps and add a <em>c_call</em> column at the end, or replace the existing column if it already exists.</p>
<p>To deal with incorrect constant gene calls due to insufficient length, an internal subfunction will run a pairwise alignment against <a class="reference external" href="https://twitter.com/hamish_king">hk6</a>’s curated sequences that were deemed to be highly specific in distinguishing IGHA1-2, IGHG1-4. I have also curated sets of sequences that should help deal with <code class="docutils literal notranslate"><span class="pre">IGLC3/6/7</span></code> as these are problematic too. If there’s insufficient info, the <code class="docutils literal notranslate"><span class="pre">c_call</span></code> will be returned as a combination of the most aligned sets of sequences.
Because of how similar the light chains are, extremely ambiguous calls (only able to map to a common sequence across the light chains) will be returned as <code class="docutils literal notranslate"><span class="pre">IGLC</span></code>. This typically occurs when the constant sequence is very short. Those that have equal alignment scores between <code class="docutils literal notranslate"><span class="pre">IGLC3/6/7</span></code> sequences and the common sequence will be returned as a concatenated call; for example with a contig initially annotated as <code class="docutils literal notranslate"><span class="pre">IGLC3</span></code> will be returned as <code class="docutils literal notranslate"><span class="pre">IGLC,IGLC3</span></code>. If you do not want this subfunction to
run, toggle:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">correct_c_call</span> <span class="o">=</span> <span class="kc">FALSE</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Before running, there is a need to set up a database with IMGT constant gene fasta sequences using <em>makeblastdb</em>, basically following the instructions from <a class="reference external" href="https://www.ncbi.nlm.nih.gov/books/NBK279688/">https://www.ncbi.nlm.nih.gov/books/NBK279688/</a>. <strong>This only needs to be done once.</strong></p>
<p>The fasta files were downloaded from IMGT and only sequences corresponding to <em>CH1</em> region for each constant gene/allele were retained. The headers were trimmed to only keep the gene and allele information. Links to find the sequences can be found here : <a class="reference external" href="http://www.imgt.org/genedb/GENElect?query=7.2+IGHC&amp;species=Homo+sapiens">human</a> and <a class="reference external" href="http://www.imgt.org/genedb/GENElect?query=7.2+IGHC&amp;species=Mus">mouse</a>.</p>
<p>The database file is provided in the repository and I’ve written a utility function <code class="docutils literal notranslate"><span class="pre">ddl$utl$makeblastdb</span></code> to prep new fasta files/databases if you need to.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">ddl</span><span class="o">$</span><span class="n">utl</span><span class="o">$</span><span class="nf">makeblastdb</span><span class="p">(</span><span class="s">&#39;/path/to/folder/containing/database/blast/human/human_BCR_C.fasta&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Again, we really only need to do it once</strong>; the file path can be added as an environmental variable after running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;export BLASTDB=/path/to/folder/containing/database/blast/&quot;</span> &gt;&gt; ~/.bash_profile
<span class="nb">source</span> ~/.bash_profile
</pre></div>
</div>
<p>I’ve set it up so that if the default option for <code class="docutils literal notranslate"><span class="pre">blastdb</span></code> is left as <code class="docutils literal notranslate"><span class="pre">None</span></code>, the function will retrieve a relative path from the environmental variable <code class="docutils literal notranslate"><span class="pre">$BLASTDB</span></code> and then, depending on which organism was specified (default = human), point to the correct fasta file. If you choose not to add it to environment, you can provide a string specifying a path to the fasta file for the <code class="docutils literal notranslate"><span class="pre">blastdb</span></code> option. The string has to point directly to the fasta file, i.e. end with <code class="docutils literal notranslate"><span class="pre">.fasta</span></code>.</p>
<hr class="docutils" />
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># ddl$utl$makeblastdb(&#39;/Users/kt16/Documents/Github/dandelion/database/blast/human/human_BCR_C.fasta&#39;)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">ddl</span><span class="o">$</span><span class="n">pp</span><span class="o">$</span><span class="nf">assign_isotypes</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This still takes a while when dealing with large files; the number of cpus to size of file isn’t exactly linear. Nevertheless, I have enabled parallelization as default because there were noticeable improvements in processing speeds with the smaller files. Maybe it will work better on a cluster with more cpus, rather than just a standard laptop. Other than a couple of samples that took about <strong>~10-40min</strong>, most ran within <strong>2-5min</strong>. I expect that this should run faster with filtered files too.</p>
<p>The default option will return a summary plot that can be disabled with <code class="docutils literal notranslate"><span class="pre">plot</span> <span class="pre">=</span> <span class="pre">FALSE</span></code>. In R, if you leave the <code class="docutils literal notranslate"><span class="pre">plot</span> <span class="pre">=</span> <span class="pre">TRUE</span></code>, it will wait for you to close the plots before continuing.</p>
<p>Also, the function can be run with <code class="docutils literal notranslate"><span class="pre">fileformat</span> <span class="pre">=</span> <span class="pre">'changeo'</span></code> if preferred.</p>
<p>It’s worthwhile to manually check the the sequences for constant calls returned as IGHA1-2, IGHG1-4 and the light chains and manually correct them if necessary.</p>
</div>
<div class="section" id="Step-5:-Quantify-mutations-(optional).">
<h3>Step 5: Quantify mutations <em>(optional)</em>.<a class="headerlink" href="#Step-5:-Quantify-mutations-(optional)." title="Permalink to this headline">¶</a></h3>
<p>In the python tutorial, at this stage, I quantified the basic mutational load with <code class="docutils literal notranslate"><span class="pre">ddl.pp.quantify_mutations</span></code> before subsequent analyses. This would not run properly within this R session due to rpy2/reticulate conflict. Instead, i’d recommend you to run this separately on the. <code class="docutils literal notranslate"><span class="pre">*_igblast_gap_genotyped.tsv</span></code> file that was generated in the previous step, by following <a class="reference external" href="https://shazam.readthedocs.io/en/stable/vignettes/Mutation-Vignette/">Shazam’s tutorial</a> on basic mutational analysis,
before continuing to step 6.</p>
</div>
</div>
<div class="section" id="Filtering">
<h2>Filtering<a class="headerlink" href="#Filtering" title="Permalink to this headline">¶</a></h2>
<p><strong>Create a Seurat object from the transcriptome data</strong></p>
<p>Let’s first import the gene expression data. Let’s try from Seurat object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">setwd</span><span class="p">(</span><span class="s">&#39;/Users/kt16/Downloads/dandelion_tutorial/&#39;</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">Seurat</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;sc5p_v2_hs_PBMC_1k&#39;</span><span class="p">,</span> <span class="s">&#39;sc5p_v2_hs_PBMC_10k&#39;</span><span class="p">,</span> <span class="s">&#39;vdj_v1_hs_pbmc3&#39;</span><span class="p">,</span> <span class="s">&#39;vdj_nextgem_hs_pbmc3&#39;</span><span class="p">)</span>
<span class="n">seurat_objects</span> <span class="o">=</span> <span class="nf">list</span><span class="p">()</span>
<span class="nf">for </span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">samples</span><span class="p">)){</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;/filtered_feature_bc_matrix.h5&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">&lt;-</span> <span class="nf">Read10X_h5</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">seurat_objects</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">CreateSeuratObject</span><span class="p">(</span><span class="n">counts</span> <span class="o">=</span> <span class="n">data</span><span class="o">$</span><span class="n">`Gene Expression`</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Warning message in sparseMatrix(i = indices[] + 1, p = indptr[], x = as.numeric(x = counts[]), :
“&#39;giveCsparse&#39; has been deprecated; setting &#39;repr = &#34;T&#34;&#39; for you”
Genome matrix has multiple modalities, returning a list of matrices for this genome

Warning message in sparseMatrix(i = indices[] + 1, p = indptr[], x = as.numeric(x = counts[]), :
“&#39;giveCsparse&#39; has been deprecated; setting &#39;repr = &#34;T&#34;&#39; for you”
Genome matrix has multiple modalities, returning a list of matrices for this genome

Warning message in sparseMatrix(i = indices[] + 1, p = indptr[], x = as.numeric(x = counts[]), :
“&#39;giveCsparse&#39; has been deprecated; setting &#39;repr = &#34;T&#34;&#39; for you”
Genome matrix has multiple modalities, returning a list of matrices for this genome

Warning message in sparseMatrix(i = indices[] + 1, p = indptr[], x = as.numeric(x = counts[]), :
“&#39;giveCsparse&#39; has been deprecated; setting &#39;repr = &#34;T&#34;&#39; for you”
Genome matrix has multiple modalities, returning a list of matrices for this genome

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># merge them, there&#39;s probably better ways</span>
<span class="n">merged1</span> <span class="o">=</span> <span class="nf">merge</span><span class="p">(</span><span class="n">seurat_objects</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span> <span class="n">seurat_objects</span><span class="p">[[</span><span class="m">2</span><span class="p">]],</span> <span class="n">add.cell.ids</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">])</span>
<span class="n">merged2</span> <span class="o">=</span> <span class="nf">merge</span><span class="p">(</span><span class="n">seurat_objects</span><span class="p">[[</span><span class="m">3</span><span class="p">]],</span> <span class="n">seurat_objects</span><span class="p">[[</span><span class="m">4</span><span class="p">]],</span> <span class="n">add.cell.ids</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="m">3</span><span class="o">:</span><span class="m">4</span><span class="p">])</span>
<span class="n">merged</span> <span class="o">=</span> <span class="nf">merge</span><span class="p">(</span><span class="n">merged1</span><span class="p">,</span> <span class="n">merged2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">head</span><span class="p">(</span><span class="n">merged</span><span class="o">@</span><span class="n">meta.data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<table class="dataframe">
<caption>A data.frame: 6 × 3</caption>
<thead>
    <tr><th></th><th scope=col>orig.ident</th><th scope=col>nCount_RNA</th><th scope=col>nFeature_RNA</th></tr>
    <tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACCTGAGATCTGAA-1</th><td>SeuratProject</td><td>4386</td><td>1206</td></tr>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACCTGAGGAACTGC-1</th><td>SeuratProject</td><td>6258</td><td>1723</td></tr>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACCTGAGGAGTCTG-1</th><td>SeuratProject</td><td>4243</td><td>1404</td></tr>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACCTGAGGCTCTTA-1</th><td>SeuratProject</td><td>5205</td><td>1622</td></tr>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACCTGAGTACGTTC-1</th><td>SeuratProject</td><td>7098</td><td>2123</td></tr>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACCTGGTATCACCA-1</th><td>SeuratProject</td><td>1095</td><td> 604</td></tr>
</tbody>
</table></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">dandelion</span></code> removes hyphen from the cell barcodes as a default behaviour, so we will do the same for the <code class="docutils literal notranslate"><span class="pre">Seurat</span></code> object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># remove the -# from the end of each cell name</span>
<span class="n">merged</span> <span class="o">&lt;-</span> <span class="nf">RenameCells</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">new.names</span> <span class="o">=</span> <span class="nf">gsub</span><span class="p">(</span><span class="s">&#39;-.*&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nf">row.names</span><span class="p">(</span><span class="n">merged</span><span class="o">@</span><span class="n">meta.data</span><span class="p">)))</span>
<span class="n">merged</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
An object of class Seurat
38224 features across 36730 samples within 1 assay
Active assay: RNA (38224 features, 0 variable features)
</pre></div></div>
</div>
<p><strong>Standard Seurat pre-processing workflow</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">merged</span><span class="p">[[</span><span class="s">&quot;percent.mt&quot;</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">PercentageFeatureSet</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s">&quot;^MT-&quot;</span><span class="p">)</span>
<span class="n">merged</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="n">nFeature_RNA</span> <span class="o">&gt;</span> <span class="m">200</span> <span class="o">&amp;</span> <span class="n">nFeature_RNA</span> <span class="o">&lt;</span> <span class="m">2500</span> <span class="o">&amp;</span> <span class="n">percent.mt</span> <span class="o">&lt;</span> <span class="m">5</span><span class="p">)</span>
<span class="n">merged</span> <span class="o">&lt;-</span> <span class="nf">NormalizeData</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
<span class="n">merged</span> <span class="o">&lt;-</span> <span class="nf">FindVariableFeatures</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">selection.method</span> <span class="o">=</span> <span class="s">&quot;vst&quot;</span><span class="p">,</span> <span class="n">nfeatures</span> <span class="o">=</span> <span class="m">2000</span><span class="p">)</span>
<span class="n">merged</span> <span class="o">&lt;-</span> <span class="nf">ScaleData</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
<span class="n">merged</span> <span class="o">&lt;-</span> <span class="nf">RunPCA</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">features</span> <span class="o">=</span> <span class="nf">VariableFeatures</span><span class="p">(</span><span class="n">object</span> <span class="o">=</span> <span class="n">merged</span><span class="p">))</span>
<span class="n">merged</span> <span class="o">&lt;-</span> <span class="nf">FindNeighbors</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">dims</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">50</span><span class="p">)</span>
<span class="n">merged</span> <span class="o">&lt;-</span> <span class="nf">FindClusters</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
<span class="n">merged</span> <span class="o">&lt;-</span> <span class="nf">RunUMAP</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">dims</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Centering and scaling data matrix

PC_ 1
Positive:  IFITM1, RPS27, IL32, LTB, RPS18, IL7R, TRBC2, TCF7, CD7, RPS29
           NOSIP, LEF1, CD247, ETS1, AES, CCR7, MAL, LIME1, CD2, TRBC1
           SELL, CD69, GZMM, AQP3, OXNAD1, SEPT6, SEPT1, ARL4C, PIM2, TRAC
Negative:  LYZ, S100A9, FCN1, S100A8, CST3, VCAN, MNDA, IFI30, SPI1, SERPINA1
           S100A12, CSTA, CD14, TYMP, LST1, CTSS, CYBB, MS4A6A, CSF3R, CD68
           TYROBP, NCF2, CFD, TNFAIP2, FTL, CD36, CEBPD, AIF1, GRN, LILRB2
PC_ 2
Positive:  MS4A1, CD79A, BANK1, LINC00926, IGHM, HLA-DQA1, FCER2, HLA-DQB1, TCL1A, CD79B
           FCRLA, CD19, VPREB3, RALGPS2, CD22, FCRL1, HLA-DRA, HLA-DOB, AFF3, IGHD
           BLNK, POU2AF1, NIBAN3, IGKC, CD24, SPIB, BLK, ADAM28, HLA-DPB1, TSPAN13
Negative:  NKG7, CST7, GZMA, PRF1, GNLY, HCST, KLRD1, CTSW, FGFBP2, FCGR3A
           KLRF1, HOPX, SPON2, GZMB, CLIC3, IFITM1, CCL5, MATK, TBX21, IFITM2
           IL2RB, SH2D1B, SRGN, S100A4, S1PR5, KLRB1, MYOM2, ITGB2, ADGRG1, PTGDR
PC_ 3
Positive:  TCF7, LEF1, IL7R, TPT1, VIM, CCR7, MAL, NOSIP, RPL36A, OXNAD1
           ACTN1, RGCC, PRKCQ-AS1, RPL17, AQP3, LTB, BCL11B, GIMAP5, SNHG29, INPP4B
           NELL2, RPS18, EEF1G, GIMAP1, GAS5, RPS29, RPS4Y1, LRRN3, AIF1, CD40LG
Negative:  NKG7, GZMB, GNLY, CST7, PRF1, KLRD1, FCGR3A, GZMA, KLRF1, CLIC3
           FGFBP2, SPON2, HOPX, SH2D1B, TBX21, CCL4, ADGRG1, S1PR5, MYOM2, MATK
           PTGDR, TTC38, IL2RB, CXXC5, PRSS23, CTSW, GZMH, CCL5, PLEK, CX3CR1
PC_ 4
Positive:  TLE5, RPS4Y1, EEF1G, SNHG29, GAS5, PCED1B-AS1, SNHG6, SEPTIN9, SEPTIN7, PLAAT4
           LINC01578, SEPTIN1, IL2RG, AL138963.4, SEPTIN6, SNHG5, RPL17, TOMM6, JUND, GIMAP5
           RESF1, PRKCQ-AS1, CD81, MICOS10, RBIS, ATP5PO, KLF2, RNASEK, GNAS, RPS17
Negative:  AES, SEPT9, SEPT6, SEPT1, RARRES3, AL138963.3, KIAA1551, JUNB, DUSP1, FOS
           FTH1, JUN, GAPDH, MTRNR2L12, HLA-DQA2, RETN, CD69, COTL1, HLA-DRB5, FAM129C
           SAT1, VIM, NFKBIA, DUSP2, PPP1R15A, TNFAIP3, LGALS3, LTB, NR4A1, AL121748.1
PC_ 5
Positive:  CAVIN2, GNG11, PPBP, TUBB1, PF4, SPARC, MPIG6B, CLU, GP9, TREML1
           ITGA2B, CMTM5, PTGS1, PRKAR2B, NRGN, AL731557.1, MYL9, MAP3K7CL, MMD, TRIM58
           F13A1, ACRBP, AC147651.1, AP001189.1, THBS1, TMEM40, CD9, C2orf88, PTCRA, MGLL
Negative:  RPS18, MALAT1, RPS27, TPT1, CYBA, RPS29, CD37, ITGB2, RPL36A, CD74
           JUN, RPL17, IER2, JUNB, VIM, S100A6, IFITM2, NKG7, DUSP1, ZFP36
           S100A4, GSTP1, FGR, EFHD2, TYROBP, S100A10, KLF2, PRF1, GZMA, CST7

Computing nearest neighbor graph

Computing SNN

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 20766
Number of edges: 928189

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.9138
Number of communities: 24
Elapsed time: 2 seconds
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Warning message:
“The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric
To use Python UMAP via reticulate, set umap.method to &#39;umap-learn&#39; and metric to &#39;correlation&#39;
This message will be shown once per session”
23:51:32 UMAP embedding parameters a = 0.9922 b = 1.112

23:51:32 Read 20766 rows and found 50 numeric columns

23:51:32 Using Annoy for neighbor search, n_neighbors = 30

23:51:32 Building Annoy index with metric = cosine, n_trees = 50

0%   10   20   30   40   50   60   70   80   90   100%

[----|----|----|----|----|----|----|----|----|----|

*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
|

23:51:34 Writing NN index file to temp file /var/folders/nb/wrd6px6171j52lqpmkljt6vw000l2l/T//RtmpKTzwsS/filee47b1be59093

23:51:35 Searching Annoy index using 1 thread, search_k = 3000

23:51:41 Annoy recall = 100%

23:51:41 Commencing smooth kNN distance calibration using 1 thread

23:51:42 Initializing from normalized Laplacian + noise

23:51:49 Commencing optimization for 200 epochs, with 905388 positive edges

23:52:02 Optimization finished

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">4</span><span class="p">)</span>
<span class="nf">DimPlot</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">reduction</span> <span class="o">=</span> <span class="s">&quot;umap&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_6_dandelion_running_from_R-10x_data_32_0.png" class="no-scaled-link" src="../_images/notebooks_6_dandelion_running_from_R-10x_data_32_0.png" style="width: 360px; height: 240px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">merged</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
An object of class Seurat
38224 features across 20766 samples within 1 assay
Active assay: RNA (38224 features, 2000 variable features)
 2 dimensional reductions calculated: pca, umap
</pre></div></div>
</div>
<p>In order for <code class="docutils literal notranslate"><span class="pre">dandelion</span></code> to do the next step (marking/filtering of poor quality BCRs and BCR doublets), we need to include a column in the metadata, <code class="docutils literal notranslate"><span class="pre">filter_rna</span></code>. This column will tell <code class="docutils literal notranslate"><span class="pre">dandelion</span></code> whether or not the cell has passed transcriptomic QCs. So, we will set the column to <code class="docutils literal notranslate"><span class="pre">FALSE</span></code> i.e. every cell passed QC. This is important because we want to remove as many doublets and poor quality contigs to save time on computation and construction of the final data tables.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create a column called filter_rna and set it to FALSE</span>
<span class="n">merged</span><span class="o">@</span><span class="n">meta.data</span><span class="o">$</span><span class="n">filter_rna</span> <span class="o">=</span> <span class="kc">FALSE</span>
</pre></div>
</div>
</div>
<p><strong>Convert to AnnData</strong></p>
<p>We will need to convert the <code class="docutils literal notranslate"><span class="pre">Seurat</span></code> object to <code class="docutils literal notranslate"><span class="pre">AnnData</span></code> to be able to continue. <code class="docutils literal notranslate"><span class="pre">AnnData</span></code> <code class="docutils literal notranslate"><span class="pre">.obs</span></code> slot is essentially the same as <code class="docutils literal notranslate"><span class="pre">&#64;meta.data</span></code> in seurat.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">library</span><span class="p">(</span><span class="n">reticulate</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">=</span> <span class="nf">import</span><span class="p">(</span><span class="s">&quot;scanpy&quot;</span><span class="p">)</span>
<span class="c1"># convert the meta.data slot to a python friendly object</span>
<span class="n">obs</span> <span class="o">=</span> <span class="nf">r_to_py</span><span class="p">(</span><span class="n">merged</span><span class="o">@</span><span class="n">meta.data</span><span class="p">)</span>
<span class="n">normcounts</span> <span class="o">=</span> <span class="nf">r_to_py</span><span class="p">(</span><span class="n">Matrix</span><span class="o">::</span><span class="nf">t</span><span class="p">(</span><span class="nf">GetAssayData</span><span class="p">(</span><span class="n">merged</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">$</span><span class="nf">AnnData</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">normcounts</span><span class="p">,</span> <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">)</span>
<span class="n">adata</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 20766 × 38224
    obs: &#39;orig.ident&#39;, &#39;nCount_RNA&#39;, &#39;nFeature_RNA&#39;, &#39;percent.mt&#39;, &#39;RNA_snn_res.0.8&#39;, &#39;seurat_clusters&#39;, &#39;filter_rna&#39;
</pre></div></div>
</div>
<p>We need to populate the <code class="docutils literal notranslate"><span class="pre">.neighbors</span></code> slots via scanpy for smooth transfer later.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">sc</span><span class="o">$</span><span class="n">pp</span><span class="o">$</span><span class="nf">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="n">adata</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 20766 × 38224
    obs: &#39;orig.ident&#39;, &#39;nCount_RNA&#39;, &#39;nFeature_RNA&#39;, &#39;percent.mt&#39;, &#39;RNA_snn_res.0.8&#39;, &#39;seurat_clusters&#39;, &#39;filter_rna&#39;
    uns: &#39;neighbors&#39;
    obsm: &#39;X_pca&#39;
    obsp: &#39;distances&#39;, &#39;connectivities&#39;
</pre></div></div>
</div>
<p><strong>Read in the BCR files and merge them</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">files</span> <span class="o">=</span> <span class="nf">list</span><span class="p">()</span>
<span class="nf">for </span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">samples</span><span class="p">)){</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;/dandelion/filtered_contig_igblast_db-pass_genotyped.tsv&#39;</span><span class="p">)</span>
    <span class="n">files</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">readr</span><span class="o">::</span><span class="nf">read_tsv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">combined_bcr</span> <span class="o">=</span> <span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">combined_bcr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Registered S3 method overwritten by &#39;cli&#39;:
  method     from
  print.boxx spatstat

<span class="ansi-cyan-fg">──</span> <span class="ansi-bold">Column specification</span> <span class="ansi-cyan-fg">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
cols(
  .default = col_character(),
  rev_comp = <span class="ansi-yellow-fg">col_logical()</span>,
  productive = <span class="ansi-yellow-fg">col_logical()</span>,
  stop_codon = <span class="ansi-yellow-fg">col_logical()</span>,
  vj_in_frame = <span class="ansi-yellow-fg">col_logical()</span>,
  junction_length = <span class="ansi-green-fg">col_double()</span>,
  np1_length = <span class="ansi-green-fg">col_double()</span>,
  np2_length = <span class="ansi-green-fg">col_double()</span>,
  v_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  v_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  v_germline_start = <span class="ansi-green-fg">col_double()</span>,
  v_germline_end = <span class="ansi-green-fg">col_double()</span>,
  d_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  d_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  d_germline_start = <span class="ansi-green-fg">col_double()</span>,
  d_germline_end = <span class="ansi-green-fg">col_double()</span>,
  j_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  j_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  j_germline_start = <span class="ansi-green-fg">col_double()</span>,
  j_germline_end = <span class="ansi-green-fg">col_double()</span>,
  v_score = <span class="ansi-green-fg">col_double()</span>
  # ... with 16 more columns
)
<span class="ansi-cyan-fg">ℹ</span> Use <span class="ansi-black-fg ansi-white-bg">`spec()`</span> for the full column specifications.



<span class="ansi-cyan-fg">──</span> <span class="ansi-bold">Column specification</span> <span class="ansi-cyan-fg">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
cols(
  .default = col_character(),
  rev_comp = <span class="ansi-yellow-fg">col_logical()</span>,
  productive = <span class="ansi-yellow-fg">col_logical()</span>,
  stop_codon = <span class="ansi-yellow-fg">col_logical()</span>,
  vj_in_frame = <span class="ansi-yellow-fg">col_logical()</span>,
  junction_length = <span class="ansi-green-fg">col_double()</span>,
  np1_length = <span class="ansi-green-fg">col_double()</span>,
  np2_length = <span class="ansi-green-fg">col_double()</span>,
  v_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  v_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  v_germline_start = <span class="ansi-green-fg">col_double()</span>,
  v_germline_end = <span class="ansi-green-fg">col_double()</span>,
  d_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  d_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  d_germline_start = <span class="ansi-green-fg">col_double()</span>,
  d_germline_end = <span class="ansi-green-fg">col_double()</span>,
  j_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  j_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  j_germline_start = <span class="ansi-green-fg">col_double()</span>,
  j_germline_end = <span class="ansi-green-fg">col_double()</span>,
  v_score = <span class="ansi-green-fg">col_double()</span>
  # ... with 16 more columns
)
<span class="ansi-cyan-fg">ℹ</span> Use <span class="ansi-black-fg ansi-white-bg">`spec()`</span> for the full column specifications.



<span class="ansi-cyan-fg">──</span> <span class="ansi-bold">Column specification</span> <span class="ansi-cyan-fg">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
cols(
  .default = col_character(),
  rev_comp = <span class="ansi-yellow-fg">col_logical()</span>,
  productive = <span class="ansi-yellow-fg">col_logical()</span>,
  stop_codon = <span class="ansi-yellow-fg">col_logical()</span>,
  vj_in_frame = <span class="ansi-yellow-fg">col_logical()</span>,
  junction_length = <span class="ansi-green-fg">col_double()</span>,
  np1_length = <span class="ansi-green-fg">col_double()</span>,
  np2_length = <span class="ansi-green-fg">col_double()</span>,
  v_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  v_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  v_germline_start = <span class="ansi-green-fg">col_double()</span>,
  v_germline_end = <span class="ansi-green-fg">col_double()</span>,
  d_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  d_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  d_germline_start = <span class="ansi-green-fg">col_double()</span>,
  d_germline_end = <span class="ansi-green-fg">col_double()</span>,
  j_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  j_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  j_germline_start = <span class="ansi-green-fg">col_double()</span>,
  j_germline_end = <span class="ansi-green-fg">col_double()</span>,
  v_score = <span class="ansi-green-fg">col_double()</span>
  # ... with 16 more columns
)
<span class="ansi-cyan-fg">ℹ</span> Use <span class="ansi-black-fg ansi-white-bg">`spec()`</span> for the full column specifications.



<span class="ansi-cyan-fg">──</span> <span class="ansi-bold">Column specification</span> <span class="ansi-cyan-fg">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
cols(
  .default = col_character(),
  rev_comp = <span class="ansi-yellow-fg">col_logical()</span>,
  productive = <span class="ansi-yellow-fg">col_logical()</span>,
  stop_codon = <span class="ansi-yellow-fg">col_logical()</span>,
  vj_in_frame = <span class="ansi-yellow-fg">col_logical()</span>,
  junction_length = <span class="ansi-green-fg">col_double()</span>,
  np1_length = <span class="ansi-green-fg">col_double()</span>,
  np2_length = <span class="ansi-green-fg">col_double()</span>,
  v_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  v_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  v_germline_start = <span class="ansi-green-fg">col_double()</span>,
  v_germline_end = <span class="ansi-green-fg">col_double()</span>,
  d_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  d_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  d_germline_start = <span class="ansi-green-fg">col_double()</span>,
  d_germline_end = <span class="ansi-green-fg">col_double()</span>,
  j_sequence_start = <span class="ansi-green-fg">col_double()</span>,
  j_sequence_end = <span class="ansi-green-fg">col_double()</span>,
  j_germline_start = <span class="ansi-green-fg">col_double()</span>,
  j_germline_end = <span class="ansi-green-fg">col_double()</span>,
  v_score = <span class="ansi-green-fg">col_double()</span>
  # ... with 16 more columns
)
<span class="ansi-cyan-fg">ℹ</span> Use <span class="ansi-black-fg ansi-white-bg">`spec()`</span> for the full column specifications.


</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<table class="dataframe">
<caption>A tibble: 6 × 80</caption>
<thead>
    <tr><th scope=col>sequence_id</th><th scope=col>sequence</th><th scope=col>rev_comp</th><th scope=col>productive</th><th scope=col>v_call</th><th scope=col>d_call</th><th scope=col>j_call</th><th scope=col>sequence_alignment</th><th scope=col>germline_alignment</th><th scope=col>junction</th><th scope=col>⋯</th><th scope=col>fwr2_aa</th><th scope=col>fwr3_aa</th><th scope=col>fwr4_aa</th><th scope=col>cdr1_aa</th><th scope=col>cdr2_aa</th><th scope=col>cdr3_aa</th><th scope=col>sequence_alignment_aa</th><th scope=col>v_sequence_alignment_aa</th><th scope=col>d_sequence_alignment_aa</th><th scope=col>j_sequence_alignment_aa</th></tr>
    <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;lgl&gt;</th><th scope=col>&lt;lgl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>⋯</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
    <tr><td>sc5p_v2_hs_PBMC_1k_AAACCTGTCACTGGGC_contig_2</td><td>GGGGACTTTCTGAGAGTCCTGGACCTCCTGCACAAGAACATGAAACACCTGTGGTTCTTCCTCCTCCTGGTGGCAGCTCCCAGATGGGTCCTGTCCCAGGTGCAGCTGCAGGAGTCGGGCCCAGGACTGGTGAAGCCTTCGGAGACCCTGTCCCTCACCTGCACTGTCTCTGGTGGCTCCATCAGGAGTTACTACTGGAGCTGGATCCGGCAGCCCGCCGGGAAGGGACTGGAGTGGATTGGGCGTATCTATATTAGTGGGAGCACCAACTACAACCCCTCCCTCAAGAGTCGAGTCACCATGTCAGTAGACACGTCCAAGAACCAATTCTCCCTGAAGCTGAGCTCTGTGACCGCCGCGGACACGGCCGTGTATTACTGTGCGAGAGGCGGGAACAGTGGCTTAGACCCCTGGGGCCAGGGAACCCTGGTCACCGTCTCCTCAGGGAGTGCATCCGCCCCAACCCTTTTCCCCCTCGTCTCCTGTGAGAATTCCCCGTCGGATACGAGCAGCGTG                                                     </td><td>FALSE</td><td> TRUE</td><td>IGHV4-4*07                          </td><td>IGHD6-19*01</td><td>IGHJ5*02         </td><td>CAGGTGCAGCTGCAGGAGTCGGGCCCA...GGACTGGTGAAGCCTTCGGAGACCCTGTCCCTCACCTGCACTGTCTCTGGTGGCTCCATC............AGGAGTTACTACTGGAGCTGGATCCGGCAGCCCGCCGGGAAGGGACTGGAGTGGATTGGGCGTATCTATATTAGT.........GGGAGCACCAACTACAACCCCTCCCTCAAG...AGTCGAGTCACCATGTCAGTAGACACGTCCAAGAACCAATTCTCCCTGAAGCTGAGCTCTGTGACCGCCGCGGACACGGCCGTGTATTACTGTGCGAGAGGCGGGAACAGTGGCTTAGACCCCTGGGGCCAGGGAACCCTGGTCACCGTCTCCTCAG</td><td>CAGGTGCAGCTGCAGGAGTCGGGCCCA...GGACTGGTGAAGCCTTCGGAGACCCTGTCCCTCACCTGCACTGTCTCTGGTGGCTCCATC............AGTAGTTACTACTGGAGCTGGATCCGGCAGCCCGCCGGGAAGGGACTGGAGTGGATTGGGCGTATCTATACCAGT.........GGGAGCACCAACTACAACCCCTCCCTCAAG...AGTCGAGTCACCATGTCAGTAGACACGTCCAAGAACCAGTTCTCCCTGAAGCTGAGCTCTGTGACCGCCGCGGACACGGCCGTGTATTACTGTGCGAGAGNNNNNNNCAGTGGCTNNGACCCCTGGGGCCAGGGAACCCTGGTCACCGTCTCCTCAG</td><td>TGTGCGAGAGGCGGGAACAGTGGCTTAGACCCCTGG</td><td>⋯</td><td>WSWIRQPAGKGLEWIGR</td><td>NYNPSLKSRVTMSVDTSKNQFSLKLSSVTAADTAVYYC</td><td>WGQGTLVTVSS</td><td>GGSIRSYY   </td><td>IYISGST</td><td>ARGGNSGLDP</td><td>QVQLQESGPGLVKPSETLSLTCTVSGGSIRSYYWSWIRQPAGKGLEWIGRIYISGSTNYNPSLKSRVTMSVDTSKNQFSLKLSSVTAADTAVYYCARGGNSGLDPWGQGTLVTVSS</td><td>QVQLQESGPGLVKPSETLSLTCTVSGGSIRSYYWSWIRQPAGKGLEWIGRIYISGSTNYNPSLKSRVTMSVDTSKNQFSLKLSSVTAADTAVYYCAR       </td><td>SG</td><td>DPWGQGTLVTVSS</td></tr>
    <tr><td>sc5p_v2_hs_PBMC_1k_AAACCTGTCACTGGGC_contig_3</td><td>GGGGACTGATCAGGACTCCTCAGTTCACCTTCTCACAATGAGGCTCCCTGCTCAGCTCCTGGGGCTGCTAATGCTCTGGGTCCCAGGATCCAGTGGGGATGTTGTGATGACTCAGTCTCCACTCTCCCTGCCCGTCACCCTTGGACAGCCGGCCTCCATCTCCTGCAGGTCTAGTCAAAGCCTCGTATACAGTGATGGAAACACCTACTTGAATTGGTTTCAGCAGAGGCCAGGCCAATCTCCAAGGCGCCTAATTTATAAGTTTTCTAACTGGGACTCTGGGGTCCCAGACAGATTCAGCGGCAGTGGGTCAGGCACTGATTTCACACTGAAAATCAGCAGGGTGGAGGCTGAGGATGTTGGGGTTTATTACTGCATGCAAGGTACACACTGGCCTGGACGTTCGGCCAAGGGACCAAGGTGGAAATCAAACGAACTGTGGCTGCACCATCTGTCTTCATCTTCCCGCCATCTGATGAGCAGTTGAAATCTGGAACTGCCTCTGTTGTGTGCCTGCTGAATAACTTCTATCCCAGAGAGGCCAAAGTACAGTGGAAGGTGGATAACGC</td><td>FALSE</td><td>FALSE</td><td>IGKV2D-30*01                        </td><td>NA         </td><td>IGKJ1*01         </td><td>GATGTTGTGATGACTCAGTCTCCACTCTCCCTGCCCGTCACCCTTGGACAGCCGGCCTCCATCTCCTGCAGGTCTAGTCAAAGCCTCGTATACAGT...GATGGAAACACCTACTTGAATTGGTTTCAGCAGAGGCCAGGCCAATCTCCAAGGCGCCTAATTTATAAGTTT.....................TCTAACTGGGACTCTGGGGTCCCA...GACAGATTCAGCGGCAGTGGG......TCAGGCACTGATTTCACACTGAAAATCAGCAGGGTGGAGGCTGAGGATGTTGGGGTTTATTACTGCATGCAAGGTACACACTGGCCTGGACGTTCGGCCAAGGGACCAAGGTGGAAATCAAAC       </td><td>GATGTTGTGATGACTCAGTCTCCACTCTCCCTGCCCGTCACCCTTGGACAGCCGGCCTCCATCTCCTGCAGGTCTAGTCAAAGCCTCGTATACAGT...GATGGAAACACCTACTTGAATTGGTTTCAGCAGAGGCCAGGCCAATCTCCAAGGCGCCTAATTTATAAGGTT.....................TCTAACTGGGACTCTGGGGTCCCA...GACAGATTCAGCGGCAGTGGG......TCAGGCACTGATTTCACACTGAAAATCAGCAGGGTGGAGGCTGAGGATGTTGGGGTTTATTACTGCATGCAAGGTACACACTGGCCTGGACGTTCGGCCAAGGGACCAAGGTGGAAATCAAAC       </td><td>TGCATGCAAGGTACACACTGGCCTGGACGTTC    </td><td>⋯</td><td>LNWFQQRPGQSPRRLIY</td><td>NWDSGVPDRFSGSGSGTDFTLKISRVEAEDVGVYYC  </td><td>SAKGPRWKS  </td><td>QSLVYSDGNTY</td><td>KFS    </td><td>MQGTHWPGR </td><td>DVVMTQSPLSLPVTLGQPASISCRSSQSLVYSDGNTYLNWFQQRPGQSPRRLIYKFSNWDSGVPDRFSGSGSGTDFTLKISRVEAEDVGVYYCMQGTHWPGRSAKGPRWKSN    </td><td>DVVMTQSPLSLPVTLGQPASISCRSSQSLVYSDGNTYLNWFQQRPGQSPRRLIYKFSNWDSGVPDRFSGSGSGTDFTLKISRVEAEDVGVYYCMQGTHWP    </td><td>NA</td><td>GRSAKGPRWKSN </td></tr>
    <tr><td>sc5p_v2_hs_PBMC_1k_AAACCTGTCACTGGGC_contig_1</td><td>GGGGGAGGAGTCAGTCCCAACCAGGACACAGCATGGACATGAGGGTCCCTGCTCAGCTCCTGGGGCTCCTGCTGCTCTGGCTCTCAGGTGCCAGATGTGCCATCCAGATGACCCAGTCTCCATCCTCCCTGTCTGCATCTGTAGGAGACAGAGTCACCATCACTTGCCAGGCGAGTCAGGACATTAGCAACTATTTAAATTGGTATCAGCAGAAACCAGGGAAAGCCCCTAAGCTCCTGATCTACGATGCATCCAATTTGGAAGCAGGGGTCCCATCAAGGTTCAGTGGAAGTGGATCTGGGACAGATTTTACTTTCACCATCAGCAGCCTGCAGCCTGAAGATATTGCAACATATTACTGTCAACAGTATGATAATCTCCCGCTCACTTTCGGCGGAGGGACCAAGGTGGAGATCAAACGAACTGTGGCTGCACCATCTGTCTTCATCTTCCCGCCATCTGATGAGCAGTTGAAATCTGGAACTGCCTCTGTTGTGTGCCTGCTGAATAACTTCTATCCCAGAGAGGCCAAAGTACAGTGGAAGGTGGATAACGC             </td><td>FALSE</td><td> TRUE</td><td>IGKV1-33*01,IGKV1D-33*01            </td><td>NA         </td><td>IGKJ4*01         </td><td>..CATCCAGATGACCCAGTCTCCATCCTCCCTGTCTGCATCTGTAGGAGACAGAGTCACCATCACTTGCCAGGCGAGTCAGGACATT..................AGCAACTATTTAAATTGGTATCAGCAGAAACCAGGGAAAGCCCCTAAGCTCCTGATCTACGATGCA.....................TCCAATTTGGAAGCAGGGGTCCCA...TCAAGGTTCAGTGGAAGTGGA......TCTGGGACAGATTTTACTTTCACCATCAGCAGCCTGCAGCCTGAAGATATTGCAACATATTACTGTCAACAGTATGATAATCTCCCGCTCACTTTCGGCGGAGGGACCAAGGTGGAGATCAAAC      </td><td>GACATCCAGATGACCCAGTCTCCATCCTCCCTGTCTGCATCTGTAGGAGACAGAGTCACCATCACTTGCCAGGCGAGTCAGGACATT..................AGCAACTATTTAAATTGGTATCAGCAGAAACCAGGGAAAGCCCCTAAGCTCCTGATCTACGATGCA.....................TCCAATTTGGAAACAGGGGTCCCA...TCAAGGTTCAGTGGAAGTGGA......TCTGGGACAGATTTTACTTTCACCATCAGCAGCCTGCAGCCTGAAGATATTGCAACATATTACTGTCAACAGTATGATAATCTCCCGCTCACTTTCGGCGGAGGGACCAAGGTGGAGATCAAAC      </td><td>TGTCAACAGTATGATAATCTCCCGCTCACTTTC   </td><td>⋯</td><td>LNWYQQKPGKAPKLLIY</td><td>NLEAGVPSRFSGSGSGTDFTFTISSLQPEDIATYYC  </td><td>FGGGTKVEIK </td><td>QDISNY     </td><td>DAS    </td><td>QQYDNLPLT </td><td>IQMTQSPSSLSASVGDRVTITCQASQDISNYLNWYQQKPGKAPKLLIYDASNLEAGVPSRFSGSGSGTDFTFTISSLQPEDIATYYCQQYDNLPLTFGGGTKVEIK          </td><td>IQMTQSPSSLSASVGDRVTITCQASQDISNYLNWYQQKPGKAPKLLIYDASNLEAGVPSRFSGSGSGTDFTFTISSLQPEDIATYYCQQYDNLP          </td><td>NA</td><td>LTFGGGTKVEIK </td></tr>
    <tr><td>sc5p_v2_hs_PBMC_1k_AAACCTGTCAGGTAAA_contig_1</td><td>AGGAGTCAGACCCAGTCAGGACACAGCATGGACATGAGGGTCCCCGCTCAGCTCCTGGGGCTCCTGCTGCTCTGGTTCCCAGGTTCCAGATGCGACATCCAGATGACCCAGTCTCCATCTTCCGTGTCTGCATCTGTAGGAGACAGAGTCACCATCACTTGTCGGGCGAGTCAGGGTATTAGCGACTGGTTAGCCTGGTATCAGCAGAAGCCAGGGAAAGCCCCTAAGTTCCTGATCTATGCTGCATCCACTTTGCAAAGTGGGGTCCCATCAAGGTTCAGCGGCAGTGGATCTGGGACAGATTTCACTCTCACCATCAGCCTGCAGCCTGAAGATTTTGCAACTTACTATTGTCAACAGGCTAACAGTTTCCCGCTCACTTTCGGCGGAGGGACCAAGGTGGAGATCAAACGAACTGTGGCTGCACCATCTGTCTTCATCTTCCCGCCATCTGATGAGCAGTTGAAATCTGGAACTGCCTCTGTTGTGTGCCTGCTGAATAACTTCTATCCCAGAGAGGCCAAAGTACAGTGGAAGGTGGATAACGC                     </td><td>FALSE</td><td> TRUE</td><td>IGKV1-12*01,IGKV1-12*02,IGKV1D-12*02</td><td>NA         </td><td>IGKJ4*01         </td><td>GACATCCAGATGACCCAGTCTCCATCTTCCGTGTCTGCATCTGTAGGAGACAGAGTCACCATCACTTGTCGGGCGAGTCAGGGTATT..................AGCGACTGGTTAGCCTGGTATCAGCAGAAGCCAGGGAAAGCCCCTAAGTTCCTGATCTATGCTGCA.....................TCCACTTTGCAAAGTGGGGTCCCA...TCAAGGTTCAGCGGCAGTGGA......TCTGGGACAGATTTCACTCTCACCAT---CAGCCTGCAGCCTGAAGATTTTGCAACTTACTATTGTCAACAGGCTAACAGTTTCCCGCTCACTTTCGGCGGAGGGACCAAGGTGGAGATCAAAC      </td><td>GACATCCAGATGACCCAGTCTCCATCTTCCGTGTCTGCATCTGTAGGAGACAGAGTCACCATCACTTGTCGGGCGAGTCAGGGTATT..................AGCAGCTGGTTAGCCTGGTATCAGCAGAAACCAGGGAAAGCCCCTAAGCTCCTGATCTATGCTGCA.....................TCCAGTTTGCAAAGTGGGGTCCCA...TCAAGGTTCAGCGGCAGTGGA......TCTGGGACAGATTTCACTCTCACCATCAGCAGCCTGCAGCCTGAAGATTTTGCAACTTACTATTGTCAACAGGCTAACAGTTTCCCGCTCACTTTCGGCGGAGGGACCAAGGTGGAGATCAAAC      </td><td>TGTCAACAGGCTAACAGTTTCCCGCTCACTTTC   </td><td>⋯</td><td>LAWYQQKPGKAPKFLIY</td><td>TLQSGVPSRFSGSGSGTDFTLTISLQPEDFATYYC   </td><td>FGGGTKVEIK </td><td>QGISDW     </td><td>AAS    </td><td>QQANSFPLT </td><td>DIQMTQSPSSVSASVGDRVTITCRASQGISDWLAWYQQKPGKAPKFLIYAASTLQSGVPSRFSGSGSGTDFTLTISLQPEDFATYYCQQANSFPLTFGGGTKVEIK          </td><td>DIQMTQSPSSVSASVGDRVTITCRASQGISDWLAWYQQKPGKAPKFLIYAASTLQSGVPSRFSGSGSGTDFTLTISLQPEDFATYYCQQANSFP          </td><td>NA</td><td>LTFGGGTKVEIK </td></tr>
    <tr><td>sc5p_v2_hs_PBMC_1k_AAACCTGTCAGGTAAA_contig_2</td><td>GGAGGAACTGCTCAGTTAGGACCCAGACGGAACCATGGAAGCCCCAGCGCAGCTTCTCTTCCTCCTGCTACTCTGGCTCCCAGATACCACTGGAGAAATAGTGATGACGCAGTCTCCAGCCACCCTGTCTGTGTCTCCAGGGGAAAGAGCCACCCTCTCCTGCAGGGCCAGTCAGAGTGTTAGCAGCAACTTGGCCTGGTACCAGCAGAAACCTGGCCAGGCTCCCAGGCTCCTCATCTATGGTACATCCACCAGGGCCACTGGTATCCCAGCCAGGTTCAGTGGCAGTGGGTCTGGGACAGAGTTCACTCTCACCATCAGCAGCCTGCAGTCTGAAGATTTTGCAGTTTATTACTGTCAGCAGTATGATAACTGGCCTCCGTACACTTTTGGCCAGGGGACCAAGCTGGAGATCAAACGAACTGTGGCTGCACCATCTGTCTTCATCTTCCCGCCATCTGATGAGCAGTTGAAATCTGGAACTGCCTCTGTTGTGTGCCTGCTGAATAACTTCTATCCCAGAGAGGCCAAAGTACAGTGGAAGGTGGATAACGC              </td><td>FALSE</td><td> TRUE</td><td>IGKV3-15*01                         </td><td>NA         </td><td>IGKJ2*01         </td><td>GAAATAGTGATGACGCAGTCTCCAGCCACCCTGTCTGTGTCTCCAGGGGAAAGAGCCACCCTCTCCTGCAGGGCCAGTCAGAGTGTT..................AGCAGCAACTTGGCCTGGTACCAGCAGAAACCTGGCCAGGCTCCCAGGCTCCTCATCTATGGTACA.....................TCCACCAGGGCCACTGGTATCCCA...GCCAGGTTCAGTGGCAGTGGG......TCTGGGACAGAGTTCACTCTCACCATCAGCAGCCTGCAGTCTGAAGATTTTGCAGTTTATTACTGTCAGCAGTATGATAACTGGCCTCCGTACACTTTTGGCCAGGGGACCAAGCTGGAGATCAAAC   </td><td>GAAATAGTGATGACGCAGTCTCCAGCCACCCTGTCTGTGTCTCCAGGGGAAAGAGCCACCCTCTCCTGCAGGGCCAGTCAGAGTGTT..................AGCAGCAACTTAGCCTGGTACCAGCAGAAACCTGGCCAGGCTCCCAGGCTCCTCATCTATGGTGCA.....................TCCACCAGGGCCACTGGTATCCCA...GCCAGGTTCAGTGGCAGTGGG......TCTGGGACAGAGTTCACTCTCACCATCAGCAGCCTGCAGTCTGAAGATTTTGCAGTTTATTACTGTCAGCAGTATAATAACTGGCCTCCGTACACTTTTGGCCAGGGGACCAAGCTGGAGATCAAAC   </td><td>TGTCAGCAGTATGATAACTGGCCTCCGTACACTTTT</td><td>⋯</td><td>LAWYQQKPGQAPRLLIY</td><td>TRATGIPARFSGSGSGTEFTLTISSLQSEDFAVYYC  </td><td>FGQGTKLEIK </td><td>QSVSSN     </td><td>GTS    </td><td>QQYDNWPPYT</td><td>EIVMTQSPATLSVSPGERATLSCRASQSVSSNLAWYQQKPGQAPRLLIYGTSTRATGIPARFSGSGSGTEFTLTISSLQSEDFAVYYCQQYDNWPPYTFGQGTKLEIK        </td><td>EIVMTQSPATLSVSPGERATLSCRASQSVSSNLAWYQQKPGQAPRLLIYGTSTRATGIPARFSGSGSGTEFTLTISSLQSEDFAVYYCQQYDNWPP        </td><td>NA</td><td>YTFGQGTKLEIK </td></tr>
    <tr><td>sc5p_v2_hs_PBMC_1k_AAACCTGTCAGGTAAA_contig_3</td><td>GGAATCCTCTCCTCCTCCTGTTCCTCTCTCACTGCACAGGTTCCCTCTCGCAGCCTGTGCTGACTCAGCCAACTTCCCTCTCAGCATCTCCTGGAGCATCAGCCAGACTCACCTGCACCTTGCGCAGTGGCATCAATCTTGGTAGCTACAGGATATTCTGGTACCAGCAGAAGCCAGAGAGCCCTCCCCGGTATCTCCTGAGCTACTACTCAGACTCAAGTAAGCATCAGGGCTCTGGAGTCCCCAGCCGCTTCTCTGGATCCAAAGATGCTTCGAGCAATGCAGGGATTTTAGTCATCTCTGGGCTCCAGTCTGAGGATGAGGCTGACTATTACTGTATGATTTGGCACAGCAGTGCTTCGGTATTCGGCGGAGGGACCAAGCTGACCGTCCTAGGTCAGCCCAAGGCTGCCCCCTCGGTCACTCTGTTCCCGCCCTCCTCTGAGGAGCTTCAAGCCAACAAGGCCACACTGGTGTGTCTCATAAGTGACTTCTACCCGGGAGCCGTGACAGTGGCC                                                   </td><td>FALSE</td><td> TRUE</td><td>IGLV5-48*01                         </td><td>NA         </td><td>IGLJ2*01,IGLJ3*01</td><td>CAGCCTGTGCTGACTCAGCCAACTTCC...CTCTCAGCATCTCCTGGAGCATCAGCCAGACTCACCTGCACCTTGCGCAGTGGCATCAATCTT.........GGTAGCTACAGGATATTCTGGTACCAGCAGAAGCCAGAGAGCCCTCCCCGGTATCTCCTGAGCTACTACTCAGAC.........TCAAGTAAGCATCAGGGCTCTGGAGTCCCC...AGCCGCTTCTCTGGATCCAAAGATGCTTCGAGCAATGCAGGGATTTTAGTCATCTCTGGGCTCCAGTCTGAGGATGAGGCTGACTATTACTGTATGATTTGGCACAGCAGTGCTTCGGTATTCGGCGGAGGGACCAAGCTGACCGTCCTAG      </td><td>CAGCCTGTGCTGACTCAGCCAACTTCC...CTCTCAGCATCTCCTGGAGCATCAGCCAGACTCACCTGCACCTTGCGCAGTGGCATCAATCTT.........GGTAGCTACAGGATATTCTGGTACCAGCAGAAGCCAGAGAGCCCTCCCCGGTATCTCCTGAGCTACTACTCAGAC.........TCAAGTAAGCATCAGGGCTCTGGAGTCCCC...AGCCGCTTCTCTGGATCCAAAGATGCTTCGAGCAATGCAGGGATTTTAGTCATCTCTGGGCTCCAGTCTGAGGATGAGGCTGACTATTACTGTATGATTTGGCACAGCAGTGCTTCGGTATTCGGCGGAGGGACCAAGCTGACCGTCCTAG      </td><td>TGTATGATTTGGCACAGCAGTGCTTCGGTATTC   </td><td>⋯</td><td>IFWYQQKPESPPRYLLS</td><td>HQGSGVPSRFSGSKDASSNAGILVISGLQSEDEADYYC</td><td>FGGGTKLTVL </td><td>SGINLGSYR  </td><td>YYSDSSK</td><td>MIWHSSASV </td><td>QPVLTQPTSLSASPGASARLTCTLRSGINLGSYRIFWYQQKPESPPRYLLSYYSDSSKHQGSGVPSRFSGSKDASSNAGILVISGLQSEDEADYYCMIWHSSASVFGGGTKLTVL </td><td>QPVLTQPTSLSASPGASARLTCTLRSGINLGSYRIFWYQQKPESPPRYLLSYYSDSSKHQGSGVPSRFSGSKDASSNAGILVISGLQSEDEADYYCMIWHSSAS</td><td>NA</td><td>VFGGGTKLTVL  </td></tr>
</tbody>
</table></div>
</div>
<div class="section" id="Run-ddl$pp$filter_contigs">
<h3>Run <code class="docutils literal notranslate"><span class="pre">ddl$pp$filter_contigs</span></code><a class="headerlink" href="#Run-ddl$pp$filter_contigs" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">ddl</span> <span class="o">=</span> <span class="nf">import</span><span class="p">(</span><span class="s">&#39;dandelion&#39;</span><span class="p">)</span>
<span class="n">vdj_results_list</span> <span class="o">=</span> <span class="n">ddl</span><span class="o">$</span><span class="n">pp</span><span class="o">$</span><span class="nf">filter_contigs</span><span class="p">(</span><span class="n">combined_bcr</span><span class="p">,</span> <span class="n">adata</span><span class="p">)</span>
<span class="n">vdj_results_list</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[1]]
Dandelion class object with n_obs = 1123 and n_contigs = 2254
    data: &#39;sequence_id&#39;, &#39;sequence&#39;, &#39;rev_comp&#39;, &#39;productive&#39;, &#39;v_call&#39;, &#39;d_call&#39;, &#39;j_call&#39;, &#39;sequence_alignment&#39;, &#39;germline_alignment&#39;, &#39;junction&#39;, &#39;junction_aa&#39;, &#39;v_cigar&#39;, &#39;d_cigar&#39;, &#39;j_cigar&#39;, &#39;stop_codon&#39;, &#39;vj_in_frame&#39;, &#39;locus&#39;, &#39;junction_length&#39;, &#39;np1_length&#39;, &#39;np2_length&#39;, &#39;v_sequence_start&#39;, &#39;v_sequence_end&#39;, &#39;v_germline_start&#39;, &#39;v_germline_end&#39;, &#39;d_sequence_start&#39;, &#39;d_sequence_end&#39;, &#39;d_germline_start&#39;, &#39;d_germline_end&#39;, &#39;j_sequence_start&#39;, &#39;j_sequence_end&#39;, &#39;j_germline_start&#39;, &#39;j_germline_end&#39;, &#39;v_score&#39;, &#39;v_identity&#39;, &#39;v_support&#39;, &#39;d_score&#39;, &#39;d_identity&#39;, &#39;d_support&#39;, &#39;j_score&#39;, &#39;j_identity&#39;, &#39;j_support&#39;, &#39;fwr1&#39;, &#39;fwr2&#39;, &#39;fwr3&#39;, &#39;fwr4&#39;, &#39;cdr1&#39;, &#39;cdr2&#39;, &#39;cdr3&#39;, &#39;cell_id&#39;, &#39;c_call&#39;, &#39;consensus_count&#39;, &#39;umi_count&#39;, &#39;v_call_10x&#39;, &#39;d_call_10x&#39;, &#39;j_call_10x&#39;, &#39;junction_10x&#39;, &#39;junction_10x_aa&#39;, &#39;v_call_genotyped&#39;, &#39;germline_alignment_d_mask&#39;, &#39;sample_id&#39;, &#39;c_sequence_alignment&#39;, &#39;c_germline_alignment&#39;, &#39;c_sequence_start&#39;, &#39;c_sequence_end&#39;, &#39;c_score&#39;, &#39;c_identity&#39;, &#39;c_support&#39;, &#39;c_call_10x&#39;, &#39;junction_aa_length&#39;, &#39;fwr1_aa&#39;, &#39;fwr2_aa&#39;, &#39;fwr3_aa&#39;, &#39;fwr4_aa&#39;, &#39;cdr1_aa&#39;, &#39;cdr2_aa&#39;, &#39;cdr3_aa&#39;, &#39;sequence_alignment_aa&#39;, &#39;v_sequence_alignment_aa&#39;, &#39;d_sequence_alignment_aa&#39;, &#39;j_sequence_alignment_aa&#39;, &#39;duplicate_count&#39;
    metadata: &#39;sample_id&#39;, &#39;locus_VDJ&#39;, &#39;locus_VJ&#39;, &#39;productive_VDJ&#39;, &#39;productive_VJ&#39;, &#39;v_call_genotyped_VDJ&#39;, &#39;v_call_genotyped_VJ&#39;, &#39;j_call_VDJ&#39;, &#39;j_call_VJ&#39;, &#39;c_call_VDJ&#39;, &#39;c_call_VJ&#39;, &#39;duplicate_count_VDJ_0&#39;, &#39;duplicate_count_VDJ_1&#39;, &#39;duplicate_count_VDJ_2&#39;, &#39;duplicate_count_VJ_0&#39;, &#39;duplicate_count_VJ_1&#39;, &#39;junction_aa_VDJ&#39;, &#39;junction_aa_VJ&#39;, &#39;status&#39;, &#39;status_summary&#39;, &#39;productive&#39;, &#39;productive_summary&#39;, &#39;isotype&#39;, &#39;isotype_summary&#39;, &#39;vdj_status&#39;, &#39;vdj_status_summary&#39;, &#39;constant_status_summary&#39;
    distance: None
    edges: None
    layout: None
    graph: None

[[2]]
AnnData object with n_obs × n_vars = 20766 × 38224
    obs: &#39;orig.ident&#39;, &#39;nCount_RNA&#39;, &#39;nFeature_RNA&#39;, &#39;percent.mt&#39;, &#39;RNA_snn_res.0.8&#39;, &#39;seurat_clusters&#39;, &#39;filter_rna&#39;, &#39;has_contig&#39;, &#39;filter_contig_quality&#39;, &#39;filter_contig_VDJ&#39;, &#39;filter_contig_VJ&#39;, &#39;contig_QC_pass&#39;, &#39;filter_contig&#39;
    uns: &#39;neighbors&#39;
    obsm: &#39;X_pca&#39;
    obsp: &#39;distances&#39;, &#39;connectivities&#39;

</pre></div></div>
</div>
<p>This returns a two level list in R. The first level is the VDJ results, stored as a <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> python-class object and the second level is the accompanying <code class="docutils literal notranslate"><span class="pre">AnnData</span></code> object.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> class is structured like a multi-slot object and the two data frames below are linked: 1) data &lt;- AIRR table with row names as individual vdj contigs</p>
<ol class="arabic simple" start="2">
<li><p>metadata &lt;- AIRR table collapsed to cell barcodes as row names</p></li>
</ol>
<p>More details on the <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> class are in my python tutorials. The most important slot for now, is the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> slot within <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code>.</p>
<p>In order for the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> to form properly, there must not be any duplicate barcodes, or incorrectly retrieved information from the <code class="docutils literal notranslate"><span class="pre">data</span></code> slot. If you end up with a <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> object that only contains the <code class="docutils literal notranslate"><span class="pre">data</span></code> slot filled, it means one of the two conditions happened. In those situations, I would recommend you to send me a copy of the file so I can check why it’s failing; it is usually due to coding eror that arise from string and float incompatibilities when constructing the
object.</p>
<p>To save the <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> object, you can do the following:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">vdj_results_list</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">$</span><span class="nf">write_pkl</span><span class="p">(</span><span class="s">&#39;vdj_save.pkl.pbz2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.pkl.pbz2</span></code> extension is basically a bzip2-compressed pickle file format from python.</p>
<p>You can also save using <code class="docutils literal notranslate"><span class="pre">$write_h5</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">vdj_results_list</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">$</span><span class="nf">write_h5</span><span class="p">(</span><span class="s">&#39;vdj_save.h5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>To read the file back into R, you can do the following:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">vdj_data</span> <span class="o">&lt;-</span> <span class="n">ddl</span><span class="o">$</span><span class="nf">read_pkl</span><span class="p">(</span><span class="s">&#39;vdj_save.pkl.pbz2&#39;</span><span class="p">)</span>
<span class="n">vdj_data</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dandelion class object with n_obs = 1123 and n_contigs = 2254
    data: &#39;sequence_id&#39;, &#39;sequence&#39;, &#39;rev_comp&#39;, &#39;productive&#39;, &#39;v_call&#39;, &#39;d_call&#39;, &#39;j_call&#39;, &#39;sequence_alignment&#39;, &#39;germline_alignment&#39;, &#39;junction&#39;, &#39;junction_aa&#39;, &#39;v_cigar&#39;, &#39;d_cigar&#39;, &#39;j_cigar&#39;, &#39;stop_codon&#39;, &#39;vj_in_frame&#39;, &#39;locus&#39;, &#39;junction_length&#39;, &#39;np1_length&#39;, &#39;np2_length&#39;, &#39;v_sequence_start&#39;, &#39;v_sequence_end&#39;, &#39;v_germline_start&#39;, &#39;v_germline_end&#39;, &#39;d_sequence_start&#39;, &#39;d_sequence_end&#39;, &#39;d_germline_start&#39;, &#39;d_germline_end&#39;, &#39;j_sequence_start&#39;, &#39;j_sequence_end&#39;, &#39;j_germline_start&#39;, &#39;j_germline_end&#39;, &#39;v_score&#39;, &#39;v_identity&#39;, &#39;v_support&#39;, &#39;d_score&#39;, &#39;d_identity&#39;, &#39;d_support&#39;, &#39;j_score&#39;, &#39;j_identity&#39;, &#39;j_support&#39;, &#39;fwr1&#39;, &#39;fwr2&#39;, &#39;fwr3&#39;, &#39;fwr4&#39;, &#39;cdr1&#39;, &#39;cdr2&#39;, &#39;cdr3&#39;, &#39;cell_id&#39;, &#39;c_call&#39;, &#39;consensus_count&#39;, &#39;umi_count&#39;, &#39;v_call_10x&#39;, &#39;d_call_10x&#39;, &#39;j_call_10x&#39;, &#39;junction_10x&#39;, &#39;junction_10x_aa&#39;, &#39;v_call_genotyped&#39;, &#39;germline_alignment_d_mask&#39;, &#39;sample_id&#39;, &#39;c_sequence_alignment&#39;, &#39;c_germline_alignment&#39;, &#39;c_sequence_start&#39;, &#39;c_sequence_end&#39;, &#39;c_score&#39;, &#39;c_identity&#39;, &#39;c_support&#39;, &#39;c_call_10x&#39;, &#39;junction_aa_length&#39;, &#39;fwr1_aa&#39;, &#39;fwr2_aa&#39;, &#39;fwr3_aa&#39;, &#39;fwr4_aa&#39;, &#39;cdr1_aa&#39;, &#39;cdr2_aa&#39;, &#39;cdr3_aa&#39;, &#39;sequence_alignment_aa&#39;, &#39;v_sequence_alignment_aa&#39;, &#39;d_sequence_alignment_aa&#39;, &#39;j_sequence_alignment_aa&#39;, &#39;duplicate_count&#39;
    metadata: &#39;sample_id&#39;, &#39;locus_VDJ&#39;, &#39;locus_VJ&#39;, &#39;productive_VDJ&#39;, &#39;productive_VJ&#39;, &#39;v_call_genotyped_VDJ&#39;, &#39;v_call_genotyped_VJ&#39;, &#39;j_call_VDJ&#39;, &#39;j_call_VJ&#39;, &#39;c_call_VDJ&#39;, &#39;c_call_VJ&#39;, &#39;duplicate_count_VDJ_0&#39;, &#39;duplicate_count_VDJ_1&#39;, &#39;duplicate_count_VDJ_2&#39;, &#39;duplicate_count_VJ_0&#39;, &#39;duplicate_count_VJ_1&#39;, &#39;junction_aa_VDJ&#39;, &#39;junction_aa_VJ&#39;, &#39;status&#39;, &#39;status_summary&#39;, &#39;productive&#39;, &#39;productive_summary&#39;, &#39;isotype&#39;, &#39;isotype_summary&#39;, &#39;vdj_status&#39;, &#39;vdj_status_summary&#39;, &#39;constant_status_summary&#39;
    distance: None
    edges: None
    layout: None
    graph: None
</pre></div></div>
</div>
<p>or</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">vdj_data2</span> <span class="o">&lt;-</span> <span class="n">ddl</span><span class="o">$</span><span class="nf">read_h5</span><span class="p">(</span><span class="s">&#39;vdj_save.h5&#39;</span><span class="p">)</span>
<span class="n">vdj_data2</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dandelion class object with n_obs = 1123 and n_contigs = 2254
    data: &#39;sequence_id&#39;, &#39;sequence&#39;, &#39;rev_comp&#39;, &#39;productive&#39;, &#39;v_call&#39;, &#39;d_call&#39;, &#39;j_call&#39;, &#39;sequence_alignment&#39;, &#39;germline_alignment&#39;, &#39;junction&#39;, &#39;junction_aa&#39;, &#39;v_cigar&#39;, &#39;d_cigar&#39;, &#39;j_cigar&#39;, &#39;stop_codon&#39;, &#39;vj_in_frame&#39;, &#39;locus&#39;, &#39;junction_length&#39;, &#39;np1_length&#39;, &#39;np2_length&#39;, &#39;v_sequence_start&#39;, &#39;v_sequence_end&#39;, &#39;v_germline_start&#39;, &#39;v_germline_end&#39;, &#39;d_sequence_start&#39;, &#39;d_sequence_end&#39;, &#39;d_germline_start&#39;, &#39;d_germline_end&#39;, &#39;j_sequence_start&#39;, &#39;j_sequence_end&#39;, &#39;j_germline_start&#39;, &#39;j_germline_end&#39;, &#39;v_score&#39;, &#39;v_identity&#39;, &#39;v_support&#39;, &#39;d_score&#39;, &#39;d_identity&#39;, &#39;d_support&#39;, &#39;j_score&#39;, &#39;j_identity&#39;, &#39;j_support&#39;, &#39;fwr1&#39;, &#39;fwr2&#39;, &#39;fwr3&#39;, &#39;fwr4&#39;, &#39;cdr1&#39;, &#39;cdr2&#39;, &#39;cdr3&#39;, &#39;cell_id&#39;, &#39;c_call&#39;, &#39;consensus_count&#39;, &#39;umi_count&#39;, &#39;v_call_10x&#39;, &#39;d_call_10x&#39;, &#39;j_call_10x&#39;, &#39;junction_10x&#39;, &#39;junction_10x_aa&#39;, &#39;v_call_genotyped&#39;, &#39;germline_alignment_d_mask&#39;, &#39;sample_id&#39;, &#39;c_sequence_alignment&#39;, &#39;c_germline_alignment&#39;, &#39;c_sequence_start&#39;, &#39;c_sequence_end&#39;, &#39;c_score&#39;, &#39;c_identity&#39;, &#39;c_support&#39;, &#39;c_call_10x&#39;, &#39;junction_aa_length&#39;, &#39;fwr1_aa&#39;, &#39;fwr2_aa&#39;, &#39;fwr3_aa&#39;, &#39;fwr4_aa&#39;, &#39;cdr1_aa&#39;, &#39;cdr2_aa&#39;, &#39;cdr3_aa&#39;, &#39;sequence_alignment_aa&#39;, &#39;v_sequence_alignment_aa&#39;, &#39;d_sequence_alignment_aa&#39;, &#39;j_sequence_alignment_aa&#39;, &#39;duplicate_count&#39;
    metadata: &#39;sample_id&#39;, &#39;locus_VDJ&#39;, &#39;locus_VJ&#39;, &#39;productive_VDJ&#39;, &#39;productive_VJ&#39;, &#39;v_call_genotyped_VDJ&#39;, &#39;v_call_genotyped_VJ&#39;, &#39;j_call_VDJ&#39;, &#39;j_call_VJ&#39;, &#39;c_call_VDJ&#39;, &#39;c_call_VJ&#39;, &#39;duplicate_count_VDJ_0&#39;, &#39;duplicate_count_VDJ_1&#39;, &#39;duplicate_count_VDJ_2&#39;, &#39;duplicate_count_VJ_0&#39;, &#39;duplicate_count_VJ_1&#39;, &#39;junction_aa_VDJ&#39;, &#39;junction_aa_VJ&#39;, &#39;status&#39;, &#39;status_summary&#39;, &#39;productive&#39;, &#39;productive_summary&#39;, &#39;isotype&#39;, &#39;isotype_summary&#39;, &#39;vdj_status&#39;, &#39;vdj_status_summary&#39;, &#39;constant_status_summary&#39;
    distance: None
    edges: None
    layout: None
    graph: None
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Finding-clones">
<h2>Finding clones<a class="headerlink" href="#Finding-clones" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> comes with a method to define clones based on V-J gene usuage and CDR3 junction similarity but you can always run Immcantation/Change-O’s DefineClones with the filtered file from earlier using their <a class="reference external" href="https://changeo.readthedocs.io/en/stable/examples/10x.html">tutorial</a>. To use dandelion’s you just need to do the following:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">ddl</span><span class="o">$</span><span class="n">tl</span><span class="o">$</span><span class="nf">find_clones</span><span class="p">(</span><span class="n">vdj_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Calculating-size-of-clones">
<h2>Calculating size of clones<a class="headerlink" href="#Calculating-size-of-clones" title="Permalink to this headline">¶</a></h2>
<p>Sometimes it’s useful to evaluate the size of the clone. Here <code class="docutils literal notranslate"><span class="pre">ddl$tl$clone_size</span></code> does a simple calculation to enable that.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">ddl</span><span class="o">$</span><span class="n">tl</span><span class="o">$</span><span class="nf">clone_size</span><span class="p">(</span><span class="n">vdj_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>You can also specify <code class="docutils literal notranslate"><span class="pre">max_size</span></code> to clip off the calculation at a fixed value.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">ddl</span><span class="o">$</span><span class="n">tl</span><span class="o">$</span><span class="nf">clone_size</span><span class="p">(</span><span class="n">vdj_data</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>I have blitz through the last 3 functions without showing you the output but don’t worry, they are all stashed in the <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># compare the column names in the metadata slot of the object below with the one above.</span>
<span class="n">vdj_data</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dandelion class object with n_obs = 1123 and n_contigs = 2254
    data: &#39;sequence_id&#39;, &#39;sequence&#39;, &#39;rev_comp&#39;, &#39;productive&#39;, &#39;v_call&#39;, &#39;d_call&#39;, &#39;j_call&#39;, &#39;sequence_alignment&#39;, &#39;germline_alignment&#39;, &#39;junction&#39;, &#39;junction_aa&#39;, &#39;v_cigar&#39;, &#39;d_cigar&#39;, &#39;j_cigar&#39;, &#39;stop_codon&#39;, &#39;vj_in_frame&#39;, &#39;locus&#39;, &#39;junction_length&#39;, &#39;np1_length&#39;, &#39;np2_length&#39;, &#39;v_sequence_start&#39;, &#39;v_sequence_end&#39;, &#39;v_germline_start&#39;, &#39;v_germline_end&#39;, &#39;d_sequence_start&#39;, &#39;d_sequence_end&#39;, &#39;d_germline_start&#39;, &#39;d_germline_end&#39;, &#39;j_sequence_start&#39;, &#39;j_sequence_end&#39;, &#39;j_germline_start&#39;, &#39;j_germline_end&#39;, &#39;v_score&#39;, &#39;v_identity&#39;, &#39;v_support&#39;, &#39;d_score&#39;, &#39;d_identity&#39;, &#39;d_support&#39;, &#39;j_score&#39;, &#39;j_identity&#39;, &#39;j_support&#39;, &#39;fwr1&#39;, &#39;fwr2&#39;, &#39;fwr3&#39;, &#39;fwr4&#39;, &#39;cdr1&#39;, &#39;cdr2&#39;, &#39;cdr3&#39;, &#39;cell_id&#39;, &#39;c_call&#39;, &#39;consensus_count&#39;, &#39;umi_count&#39;, &#39;v_call_10x&#39;, &#39;d_call_10x&#39;, &#39;j_call_10x&#39;, &#39;junction_10x&#39;, &#39;junction_10x_aa&#39;, &#39;v_call_genotyped&#39;, &#39;germline_alignment_d_mask&#39;, &#39;sample_id&#39;, &#39;c_sequence_alignment&#39;, &#39;c_germline_alignment&#39;, &#39;c_sequence_start&#39;, &#39;c_sequence_end&#39;, &#39;c_score&#39;, &#39;c_identity&#39;, &#39;c_support&#39;, &#39;c_call_10x&#39;, &#39;junction_aa_length&#39;, &#39;fwr1_aa&#39;, &#39;fwr2_aa&#39;, &#39;fwr3_aa&#39;, &#39;fwr4_aa&#39;, &#39;cdr1_aa&#39;, &#39;cdr2_aa&#39;, &#39;cdr3_aa&#39;, &#39;sequence_alignment_aa&#39;, &#39;v_sequence_alignment_aa&#39;, &#39;d_sequence_alignment_aa&#39;, &#39;j_sequence_alignment_aa&#39;, &#39;duplicate_count&#39;, &#39;clone_id&#39;
    metadata: &#39;clone_id&#39;, &#39;clone_id_by_size&#39;, &#39;sample_id&#39;, &#39;locus_VDJ&#39;, &#39;locus_VJ&#39;, &#39;productive_VDJ&#39;, &#39;productive_VJ&#39;, &#39;v_call_genotyped_VDJ&#39;, &#39;v_call_genotyped_VJ&#39;, &#39;j_call_VDJ&#39;, &#39;j_call_VJ&#39;, &#39;c_call_VDJ&#39;, &#39;c_call_VJ&#39;, &#39;duplicate_count_VDJ_0&#39;, &#39;duplicate_count_VDJ_1&#39;, &#39;duplicate_count_VDJ_2&#39;, &#39;duplicate_count_VJ_0&#39;, &#39;duplicate_count_VJ_1&#39;, &#39;junction_aa_VDJ&#39;, &#39;junction_aa_VJ&#39;, &#39;status&#39;, &#39;status_summary&#39;, &#39;productive&#39;, &#39;productive_summary&#39;, &#39;isotype&#39;, &#39;isotype_summary&#39;, &#39;vdj_status&#39;, &#39;vdj_status_summary&#39;, &#39;constant_status_summary&#39;, &#39;clone_id_size&#39;, &#39;clone_id_size_max_3.0&#39;
    distance: None
    edges: None
    layout: None
    graph: None
</pre></div></div>
</div>
</div>
<div class="section" id="Generate-BCR-network-visualization">
<h2>Generate BCR network visualization<a class="headerlink" href="#Generate-BCR-network-visualization" title="Permalink to this headline">¶</a></h2>
<p>The name of <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> came from the way it visualizes the BCR as networks, that look like dandelions in the field. We need to first generate the network. We will hopewfully visualize in Seurat later.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">ddl</span><span class="o">$</span><span class="n">tl</span><span class="o">$</span><span class="nf">generate_network</span><span class="p">(</span><span class="n">vdj_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Integrating-with-Seurat">
<h2>Integrating with Seurat<a class="headerlink" href="#Integrating-with-Seurat" title="Permalink to this headline">¶</a></h2>
<p>At this point, you might want to transfer the metadata slot back to Seurat so you can visualise some things. You can do that column by column directly from <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> object like as follows:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">isotype</span> <span class="o">=</span> <span class="nf">unlist</span><span class="p">(</span><span class="n">vdj_data</span><span class="o">$</span><span class="n">metadata</span><span class="o">$</span><span class="n">isotype</span><span class="p">)</span> <span class="c1"># because of the python to R conversion, it thinks it&#39;s a list rather than a vector. we can correct this with unlist</span>
<span class="nf">names</span><span class="p">(</span><span class="n">isotype</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">row.names</span><span class="p">(</span><span class="n">vdj_data</span><span class="o">$</span><span class="n">metadata</span><span class="p">)</span>
<span class="n">merged</span> <span class="o">&lt;-</span> <span class="nf">AddMetaData</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">isotype</span><span class="p">,</span> <span class="s">&#39;isotype&#39;</span><span class="p">)</span>
<span class="nf">DimPlot</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">group.by</span> <span class="o">=</span> <span class="s">&#39;isotype&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>I will demonstrate how to do this via the <code class="docutils literal notranslate"><span class="pre">AnnData</span></code> object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">adata2</span> <span class="o">=</span> <span class="n">vdj_results_list</span><span class="p">[[</span><span class="m">2</span><span class="p">]]</span>
<span class="n">adata2</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 20766 × 38224
    obs: &#39;orig.ident&#39;, &#39;nCount_RNA&#39;, &#39;nFeature_RNA&#39;, &#39;percent.mt&#39;, &#39;RNA_snn_res.0.8&#39;, &#39;seurat_clusters&#39;, &#39;filter_rna&#39;, &#39;has_contig&#39;, &#39;filter_contig_quality&#39;, &#39;filter_contig_VDJ&#39;, &#39;filter_contig_VJ&#39;, &#39;contig_QC_pass&#39;, &#39;filter_contig&#39;
    uns: &#39;neighbors&#39;
    obsm: &#39;X_pca&#39;
    obsp: &#39;distances&#39;, &#39;connectivities&#39;
</pre></div></div>
</div>
</div>
<div class="section" id="Transfer-Dandelion-to-AnnData">
<h2>Transfer <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> to <code class="docutils literal notranslate"><span class="pre">AnnData</span></code><a class="headerlink" href="#Transfer-Dandelion-to-AnnData" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ddl$tl$transfer</span></code> will act to transfer the metadata and graph slots from <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> object to <code class="docutils literal notranslate"><span class="pre">AnnData</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">ddl</span><span class="o">$</span><span class="n">tl</span><span class="o">$</span><span class="nf">transfer</span><span class="p">(</span><span class="n">adata2</span><span class="p">,</span> <span class="n">vdj_data</span><span class="p">)</span> <span class="c1"># switch expanded_only to TRUE if you only want to get the coordinates for expanded clones</span>
</pre></div>
</div>
</div>
<p>This will populate the adata <code class="docutils literal notranslate"><span class="pre">.obs</span></code> slot with the metadata from the <code class="docutils literal notranslate"><span class="pre">Dandelion</span></code> object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">adata2</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 20766 × 38224
    obs: &#39;orig.ident&#39;, &#39;nCount_RNA&#39;, &#39;nFeature_RNA&#39;, &#39;percent.mt&#39;, &#39;RNA_snn_res.0.8&#39;, &#39;seurat_clusters&#39;, &#39;filter_rna&#39;, &#39;has_contig&#39;, &#39;filter_contig_quality&#39;, &#39;filter_contig_VDJ&#39;, &#39;filter_contig_VJ&#39;, &#39;contig_QC_pass&#39;, &#39;filter_contig&#39;, &#39;clone_id&#39;, &#39;clone_id_by_size&#39;, &#39;sample_id&#39;, &#39;locus_VDJ&#39;, &#39;locus_VJ&#39;, &#39;productive_VDJ&#39;, &#39;productive_VJ&#39;, &#39;v_call_genotyped_VDJ&#39;, &#39;v_call_genotyped_VJ&#39;, &#39;j_call_VDJ&#39;, &#39;j_call_VJ&#39;, &#39;c_call_VDJ&#39;, &#39;c_call_VJ&#39;, &#39;duplicate_count_VDJ_0&#39;, &#39;duplicate_count_VDJ_1&#39;, &#39;duplicate_count_VDJ_2&#39;, &#39;duplicate_count_VJ_0&#39;, &#39;duplicate_count_VJ_1&#39;, &#39;junction_aa_VDJ&#39;, &#39;junction_aa_VJ&#39;, &#39;status&#39;, &#39;status_summary&#39;, &#39;productive&#39;, &#39;productive_summary&#39;, &#39;isotype&#39;, &#39;isotype_summary&#39;, &#39;vdj_status&#39;, &#39;vdj_status_summary&#39;, &#39;constant_status_summary&#39;, &#39;clone_id_size&#39;, &#39;clone_id_size_max_3.0&#39;
    uns: &#39;neighbors&#39;, &#39;rna_neighbors&#39;
    obsm: &#39;X_pca&#39;, &#39;X_vdj&#39;
    obsp: &#39;distances&#39;, &#39;connectivities&#39;, &#39;rna_connectivities&#39;, &#39;rna_distances&#39;, &#39;vdj_connectivities&#39;, &#39;vdj_distances&#39;
</pre></div></div>
</div>
<p><strong>Saving</strong></p>
<p>There may be some issues with conversions between python and R and vice versa. So my recommendation at this stage is to save the three objects separately and load them up in a fresh session. There’s a high chance your session will crash and/or corrupt your file if you ignore this.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">adata2</span><span class="o">$</span><span class="nf">write</span><span class="p">(</span><span class="s">&#39;adata_test.h5ad&#39;</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s">&#39;gzip&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">saveRDS</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="s">&#39;merged.RDS&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">vdj_data</span><span class="o">$</span><span class="nf">write_pkl</span><span class="p">(</span><span class="s">&#39;vdj_save.pkl.pbz2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="New-Session:-Transfer-AnnData-to-Seurat">
<h2>New Session: Transfer <code class="docutils literal notranslate"><span class="pre">AnnData</span></code> to <code class="docutils literal notranslate"><span class="pre">Seurat</span></code><a class="headerlink" href="#New-Session:-Transfer-AnnData-to-Seurat" title="Permalink to this headline">¶</a></h2>
<p>We start a new session and read in the files.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">setwd</span><span class="p">(</span><span class="s">&#39;/Users/kt16/Downloads/dandelion_tutorial/&#39;</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">reticulate</span><span class="p">)</span>
<span class="n">ddl</span> <span class="o">=</span> <span class="nf">import</span><span class="p">(</span><span class="s">&#39;dandelion&#39;</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">=</span> <span class="nf">import</span><span class="p">(</span><span class="s">&#39;scanpy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">library</span><span class="p">(</span><span class="n">Seurat</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;sc5p_v2_hs_PBMC_1k&#39;</span><span class="p">,</span> <span class="s">&#39;sc5p_v2_hs_PBMC_10k&#39;</span><span class="p">,</span> <span class="s">&#39;vdj_v1_hs_pbmc3&#39;</span><span class="p">,</span> <span class="s">&#39;vdj_nextgem_hs_pbmc3&#39;</span><span class="p">)</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">$</span><span class="nf">read_h5ad</span><span class="p">(</span><span class="s">&#39;adata_test.h5ad&#39;</span><span class="p">)</span>
<span class="c1"># vdj = ddl$read(&#39;vdj_save.pkl.pbz2&#39;) # don&#39;t need this at this stage</span>
<span class="n">merged</span> <span class="o">=</span> <span class="nf">readRDS</span><span class="p">(</span><span class="s">&#39;merged.RDS&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">adata</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 20766 × 38224
    obs: &#39;orig.ident&#39;, &#39;nCount_RNA&#39;, &#39;nFeature_RNA&#39;, &#39;percent.mt&#39;, &#39;RNA_snn_res.0.8&#39;, &#39;seurat_clusters&#39;, &#39;filter_rna&#39;, &#39;has_contig&#39;, &#39;filter_contig_quality&#39;, &#39;filter_contig_VDJ&#39;, &#39;filter_contig_VJ&#39;, &#39;contig_QC_pass&#39;, &#39;filter_contig&#39;, &#39;clone_id&#39;, &#39;clone_id_by_size&#39;, &#39;sample_id&#39;, &#39;locus_VDJ&#39;, &#39;locus_VJ&#39;, &#39;productive_VDJ&#39;, &#39;productive_VJ&#39;, &#39;v_call_genotyped_VDJ&#39;, &#39;v_call_genotyped_VJ&#39;, &#39;j_call_VDJ&#39;, &#39;j_call_VJ&#39;, &#39;c_call_VDJ&#39;, &#39;c_call_VJ&#39;, &#39;duplicate_count_VDJ_0&#39;, &#39;duplicate_count_VDJ_1&#39;, &#39;duplicate_count_VDJ_2&#39;, &#39;duplicate_count_VJ_0&#39;, &#39;duplicate_count_VJ_1&#39;, &#39;junction_aa_VDJ&#39;, &#39;junction_aa_VJ&#39;, &#39;status&#39;, &#39;status_summary&#39;, &#39;productive&#39;, &#39;productive_summary&#39;, &#39;isotype&#39;, &#39;isotype_summary&#39;, &#39;vdj_status&#39;, &#39;vdj_status_summary&#39;, &#39;constant_status_summary&#39;, &#39;clone_id_size&#39;, &#39;clone_id_size_max_3.0&#39;
    uns: &#39;neighbors&#39;, &#39;rna_neighbors&#39;
    obsm: &#39;X_pca&#39;, &#39;X_vdj&#39;
    obsp: &#39;connectivities&#39;, &#39;distances&#39;, &#39;rna_connectivities&#39;, &#39;rna_distances&#39;, &#39;vdj_connectivities&#39;, &#39;vdj_distances&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">merged</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
An object of class Seurat
38224 features across 20766 samples within 1 assay
Active assay: RNA (38224 features, 2000 variable features)
 2 dimensional reductions calculated: pca, umap
</pre></div></div>
</div>
<p>So there are a few cells missing from the <code class="docutils literal notranslate"><span class="pre">AnnData</span></code> object because they were filtered away. Let’s do a simple merge to populate the <code class="docutils literal notranslate"><span class="pre">Seurat</span></code> object’s <code class="docutils literal notranslate"><span class="pre">meta.data</span></code> slot.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">merged_meta</span> <span class="o">=</span> <span class="n">merged</span><span class="o">@</span><span class="n">meta.data</span>
<span class="nf">head</span><span class="p">(</span><span class="n">merged_meta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<table class="dataframe">
<caption>A data.frame: 6 × 7</caption>
<thead>
    <tr><th></th><th scope=col>orig.ident</th><th scope=col>nCount_RNA</th><th scope=col>nFeature_RNA</th><th scope=col>percent.mt</th><th scope=col>RNA_snn_res.0.8</th><th scope=col>seurat_clusters</th><th scope=col>filter_rna</th></tr>
    <tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;lgl&gt;</th></tr>
</thead>
<tbody>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACCTGAGATCTGAA</th><td>SeuratProject</td><td>4386</td><td>1206</td><td>2.507980</td><td>1</td><td>1</td><td>FALSE</td></tr>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACCTGAGGAACTGC</th><td>SeuratProject</td><td>6258</td><td>1723</td><td>4.873762</td><td>0</td><td>0</td><td>FALSE</td></tr>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACCTGAGGAGTCTG</th><td>SeuratProject</td><td>4243</td><td>1404</td><td>4.572237</td><td>0</td><td>0</td><td>FALSE</td></tr>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACCTGAGGCTCTTA</th><td>SeuratProject</td><td>5205</td><td>1622</td><td>4.591739</td><td>0</td><td>0</td><td>FALSE</td></tr>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACGGGAGACATAAC</th><td>SeuratProject</td><td>5775</td><td>1444</td><td>3.307359</td><td>0</td><td>0</td><td>FALSE</td></tr>
    <tr><th scope=row>sc5p_v2_hs_PBMC_1k_AAACGGGCAGATGAGC</th><td>SeuratProject</td><td>4607</td><td>1268</td><td>4.167571</td><td>1</td><td>1</td><td>FALSE</td></tr>
</tbody>
</table></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># extract the metadata from the anndata object</span>
<span class="n">adata_meta</span> <span class="o">=</span> <span class="nf">as.data.frame</span><span class="p">(</span><span class="n">adata</span><span class="o">$</span><span class="n">obs</span><span class="p">)</span>
<span class="c1"># two rounds to convert NAs</span>
<span class="n">is.nan.data.frame</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="nf">do.call</span><span class="p">(</span><span class="n">cbind</span><span class="p">,</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">is.nan</span><span class="p">))</span>

<span class="n">adata_meta</span><span class="p">[</span><span class="nf">is.nan</span><span class="p">(</span><span class="n">adata_meta</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="kc">NA</span>

<span class="n">is.nan.data.frame</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="nf">do.call</span><span class="p">(</span><span class="n">cbind</span><span class="p">,</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="n">y</span> <span class="o">==</span> <span class="s">&#39;nan&#39;</span><span class="p">))</span>

<span class="n">adata_meta</span><span class="p">[</span><span class="nf">is.nan</span><span class="p">(</span><span class="n">adata_meta</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="kc">NA</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Warning message in (function (..., deparse.level = 1) :
“number of rows of result is not a multiple of vector length (arg 15)”
</pre></div></div>
</div>
<p>If you run into issues with the conversion, unfortunately there’s not much I can do about it. One alternative is to just transfer the <code class="docutils literal notranslate"><span class="pre">.obs</span></code> slot from the dandelion object one by one as above into the seurat object.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># merge into a data frame and then make sure the format is correct</span>
<span class="n">merged_data</span> <span class="o">&lt;-</span> <span class="nf">as.data.frame</span><span class="p">(</span><span class="nf">merge</span><span class="p">(</span><span class="n">merged_meta</span><span class="p">,</span> <span class="n">adata_meta</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">all</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">merged_data</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">merged_data</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>
<span class="n">merged_data</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># now just replace the current Seurat@meta.data</span>
<span class="n">merged</span><span class="o">@</span><span class="n">meta.data</span> <span class="o">=</span> <span class="n">merged_data</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">12</span><span class="p">,</span> <span class="n">repr.plot.res</span> <span class="o">=</span> <span class="m">200</span><span class="p">)</span>
<span class="nf">DimPlot</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">group.by</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;contig_QC_pass&#39;</span><span class="p">,</span> <span class="s">&#39;isotype&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_6_dandelion_running_from_R-10x_data_86_0.png" class="no-scaled-link" src="../_images/notebooks_6_dandelion_running_from_R-10x_data_86_0.png" style="width: 600px; height: 1200px;" />
</div>
</div>
<p>If you want to visualise the BCR network, you will have to subset to cells that contain BCR.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">merged_bcr</span> <span class="o">=</span> <span class="nf">subset</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="n">contig_QC_pass</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span><span class="p">)</span>
<span class="n">merged_bcr</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
An object of class Seurat
38224 features across 1123 samples within 1 assay
Active assay: RNA (38224 features, 2000 variable features)
 2 dimensional reductions calculated: pca, umap
</pre></div></div>
</div>
</div>
<div class="section" id="Plotting-BCR-network">
<h2>Plotting BCR network<a class="headerlink" href="#Plotting-BCR-network" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_vdj</span> <span class="o">=</span> <span class="n">adata</span><span class="o">$</span><span class="n">obsm</span><span class="p">[</span><span class="s">&#39;X_vdj&#39;</span><span class="p">]</span>
<span class="n">X_vdj</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">X_vdj</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">gsub</span><span class="p">(</span><span class="s">&#39;NaN&#39;</span><span class="p">,</span> <span class="kc">NA</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="c1"># convert python NAs to R NAs</span>
<span class="n">X_vdj</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">X_vdj</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="c1"># Make sure they are actually numbers</span>
<span class="n">X_vdj</span> <span class="o">&lt;-</span> <span class="nf">as.matrix</span><span class="p">(</span><span class="n">X_vdj</span><span class="p">)</span>
<span class="nf">row.names</span><span class="p">(</span><span class="n">X_vdj</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">row.names</span><span class="p">(</span><span class="n">adata</span><span class="o">$</span><span class="n">obs</span><span class="p">)</span> <span class="c1"># will not work if the anndata .obs slot is malformed. the row.names for adata$obs and row.names(merged_bcr@meta.data) should be identical anyway, so just replace with row.names(merged_bcr@meta.data)</span>
<span class="n">X_vdj</span> <span class="o">&lt;-</span> <span class="n">X_vdj</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">X_vdj</span><span class="p">[,</span><span class="m">1</span><span class="p">]),</span> <span class="p">]</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">X_vdj</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;VDJ_1&#39;</span><span class="p">,</span> <span class="s">&#39;VDJ_2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">merged_bcr</span><span class="p">[[</span><span class="s">&quot;VDJ&quot;</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">CreateDimReducObject</span><span class="p">(</span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">X_vdj</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;VDJ_&quot;</span><span class="p">,</span> <span class="n">assay</span> <span class="o">=</span> <span class="nf">DefaultAssay</span><span class="p">(</span><span class="n">merged_bcr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">merged_bcr</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
An object of class Seurat
38224 features across 1123 samples within 1 assay
Active assay: RNA (38224 features, 2000 variable features)
 3 dimensional reductions calculated: pca, umap, VDJ
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span> <span class="n">repr.plot.res</span> <span class="o">=</span> <span class="m">200</span><span class="p">)</span>
<span class="nf">DimPlot</span><span class="p">(</span><span class="n">merged_bcr</span><span class="p">,</span> <span class="n">reduction</span> <span class="o">=</span> <span class="s">&#39;VDJ&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_6_dandelion_running_from_R-10x_data_93_0.png" class="no-scaled-link" src="../_images/notebooks_6_dandelion_running_from_R-10x_data_93_0.png" style="width: 600px; height: 500px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">DimPlot</span><span class="p">(</span><span class="n">merged_bcr</span><span class="p">,</span> <span class="n">reduction</span> <span class="o">=</span> <span class="s">&#39;VDJ&#39;</span><span class="p">,</span> <span class="n">group.by</span> <span class="o">=</span> <span class="s">&#39;isotype&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_6_dandelion_running_from_R-10x_data_94_0.png" class="no-scaled-link" src="../_images/notebooks_6_dandelion_running_from_R-10x_data_94_0.png" style="width: 600px; height: 500px;" />
</div>
</div>
<p>This concludes a quick primer on how to use <code class="docutils literal notranslate"><span class="pre">dandelion</span></code> from R. It may be a bit buggy from time to time due to how reticulate works but hopefully it will be overall alright.</p>
<p>The rest of the functions could be potentially run from R (just be changing <code class="docutils literal notranslate"><span class="pre">.</span></code> to <code class="docutils literal notranslate"><span class="pre">$</span></code> for example), but I haven’t tested it. Might be easier to run it through python, or maybe with the new RStudio 4?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">sessionInfo</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
R version 4.0.2 (2020-06-22)
Platform: x86_64-apple-darwin17.0 (64-bit)
Running under: macOS Mojave 10.14.6

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRblas.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRlapack.dylib

locale:
[1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base

other attached packages:
[1] Seurat_3.2.3    reticulate_1.18

loaded via a namespace (and not attached):
  [1] nlme_3.1-148         matrixStats_0.58.0   RcppAnnoy_0.0.18
  [4] RColorBrewer_1.1-2   httr_1.4.2           repr_1.1.3
  [7] sctransform_0.3.2    tools_4.0.2          utf8_1.2.1
 [10] R6_2.5.0             irlba_2.3.3          rpart_4.1-15
 [13] KernSmooth_2.23-17   uwot_0.1.10          mgcv_1.8-31
 [16] DBI_1.1.1            lazyeval_0.2.2       colorspace_2.0-0
 [19] gridExtra_2.3        tidyselect_1.1.1     compiler_4.0.2
 [22] Cairo_1.5-12.2       plotly_4.9.3         labeling_0.4.2
 [25] scales_1.1.1         spatstat.data_2.1-0  lmtest_0.9-38
 [28] ggridges_0.5.3       pbapply_1.4-3        goftest_1.2-2
 [31] spatstat_1.64-1      pbdZMQ_0.3-5         stringr_1.4.0
 [34] digest_0.6.27        spatstat.utils_2.1-0 base64enc_0.1-3
 [37] pkgconfig_2.0.3      htmltools_0.5.1.1    parallelly_1.23.0
 [40] fastmap_1.1.0        htmlwidgets_1.5.3    rlang_0.4.11
 [43] shiny_1.6.0          farver_2.1.0         generics_0.1.0
 [46] zoo_1.8-9            jsonlite_1.7.2       ica_1.0-2
 [49] dplyr_1.0.6          magrittr_2.0.1       patchwork_1.1.1
 [52] Matrix_1.3-2         Rcpp_1.0.6           IRkernel_1.1.1
 [55] munsell_0.5.0        fansi_0.5.0          abind_1.4-5
 [58] lifecycle_1.0.0      stringi_1.6.2        MASS_7.3-51.6
 [61] Rtsne_0.15           plyr_1.8.6           grid_4.0.2
 [64] parallel_4.0.2       listenv_0.8.0        promises_1.2.0.1
 [67] ggrepel_0.9.1        crayon_1.4.1         deldir_0.2-10
 [70] miniUI_0.1.1.1       lattice_0.20-41      IRdisplay_1.0
 [73] cowplot_1.1.1        splines_4.0.2        tensor_1.5
 [76] pillar_1.6.1         igraph_1.2.6         uuid_0.1-4
 [79] future.apply_1.7.0   reshape2_1.4.4       codetools_0.2-16
 [82] leiden_0.3.7         glue_1.4.2           evaluate_0.14
 [85] data.table_1.14.0    vctrs_0.3.8          png_0.1-7
 [88] httpuv_1.5.5         polyclip_1.10-0      gtable_0.3.0
 [91] RANN_2.6.1           purrr_0.3.4          tidyr_1.1.3
 [94] scattermore_0.7      future_1.21.0        assertthat_0.2.1
 [97] ggplot2_3.3.3        rsvd_1.0.3           mime_0.10
[100] xtable_1.8-4         later_1.1.0.1        survival_3.1-12
[103] viridisLite_0.3.0    tibble_3.1.2         cluster_2.1.0
[106] globals_0.14.0       fitdistrplus_1.1-3   ellipsis_0.3.2
[109] ROCR_1.0-11
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="7_dandelion_TCR_data_10x_data.html" class="btn btn-neutral float-right" title="Analyzing TCR data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="0_dandelion_primer.html" class="btn btn-neutral float-left" title="Dandelion class" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, zktuong.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>